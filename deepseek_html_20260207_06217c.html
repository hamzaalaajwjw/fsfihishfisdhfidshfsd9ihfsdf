<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>منتدى الريدبيل</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
  /* =====================================================
     GLOBAL / RESET
  ===================================================== */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Cairo', sans-serif;
    background: #000000;
    color: #ffffff;
    overflow-x: hidden;
    line-height: 1.6;
    min-height: 100vh;
  }
  
  h1, h2, h3, h4, h5, h6 {
    margin: 0;
    font-weight: 700;
    line-height: 1.3;
  }
  
  button {
    cursor: pointer;
    font-family: inherit;
    border: none;
    outline: none;
    background: none;
  }
  
  a {
    text-decoration: none;
    color: inherit;
  }
  
  /* =====================================================
     THEME VARIABLES
  ===================================================== */
  :root {
    --bg: #000000;
    --panel: #0a0a0a;
    --card: #111111;
    --card-hover: #1a1a1a;
    --border: rgba(255, 255, 255, 0.1);
    --accent: #ffffff;
    --text: #ffffff;
    --text-muted: #aaaaaa;
    --text-light: #f5f5f5;
    --red: #ff4757;
    --blue: #1e90ff;
    --verified-color: #1e90ff;
    --radius: 12px;
    --radius-sm: 8px;
  }
  
  /* =====================================================
     LAYOUT
  ===================================================== */
  header {
    height: 70px;
    background: rgba(10, 10, 10, 0.95);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.5px;
  }
  
  .logo i {
    font-size: 20px;
    color: var(--text);
  }
  
  .menu-toggle {
    display: none;
    color: var(--text);
    font-size: 20px;
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    transition: all 0.2s;
  }
  
  .app {
    display: flex;
    min-height: calc(100vh - 70px);
  }
  
  /* =====================================================
     SIDEBAR
  ===================================================== */
  .sidebar {
    width: 280px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
    overflow-y: auto;
    max-height: calc(100vh - 70px);
    z-index: 90;
  }
  
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 70px;
    right: 0;
    width: 100%;
    height: calc(100vh - 70px);
    background: rgba(0, 0, 0, 0.8);
    z-index: 80;
  }
  
  main {
    flex: 1;
    padding: 20px;
    max-width: 100%;
    width: 100%;
    overflow-x: hidden;
  }
  
  /* =====================================================
     UI COMPONENTS
  ===================================================== */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }
  
  .card.highlight {
    background: var(--card-hover);
    border: 1px solid var(--border);
  }
  
  .auth-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
  }
  
  .auth-card .profile-header {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .auth-card .profile-header .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #222222;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }
  
  .auth-card .profile-header .user-info {
    flex: 1;
    min-width: 0;
  }
  
  .auth-card .profile-header .user-info strong {
    display: block;
    font-size: 16px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text);
  }
  
  .auth-card .profile-header .user-info .muted {
    font-size: 12px;
    color: var(--text-muted);
  }
  
  .auth-card .auth-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
  }
  
  .auth-card .auth-form input {
    width: 100%;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
  }
  
  .auth-card .auth-form input:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  .auth-card .auth-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 16px;
  }
  
  .btn {
    width: 100%;
    padding: 14px;
    border-radius: var(--radius-sm);
    border: none;
    background: #222222;
    color: var(--text);
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn:hover {
    background: #333333;
  }
  
  .btn.ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-light);
  }
  
  .btn.ghost:hover {
    border-color: var(--accent);
    background: rgba(255, 255, 255, 0.05);
  }
  
  .btn.small {
    padding: 10px 16px;
    font-size: 13px;
    width: auto;
  }
  
  .btn.danger {
    background: #222222;
    color: var(--red);
  }
  
  .menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: transparent;
    color: var(--text-light);
    border-radius: var(--radius-sm);
    transition: all 0.2s;
    border: none;
    width: 100%;
    text-align: right;
    font-size: 14px;
    font-weight: 600;
  }
  
  .menu-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--accent);
  }
  
  .menu-item.active {
    background: rgba(255, 255, 255, 0.1);
    color: var(--accent);
    border-left: 2px solid var(--accent);
  }
  
  .menu-item i {
    width: 20px;
    font-size: 16px;
    color: inherit;
  }
  
  input, textarea, select {
    width: 100%;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    color: var(--text);
    margin-top: 8px;
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
  }
  
  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  .muted {
    color: var(--text-muted);
    font-size: 13px;
  }
  
  .tag {
    display: inline-block;
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-light);
    border-radius: 12px;
    font-size: 11px;
    margin-left: 6px;
    margin-top: 6px;
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  /* =====================================================
     VERIFICATION BADGE - UPDATED FOR ALL USERS
  ===================================================== */
  .verified-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--verified-color);
    margin-right: 5px;
    position: relative;
  }
  
  .verified-badge i {
    font-size: 10px;
    color: white;
  }
  
  .user-with-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  
  .verified-user {
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  
  .verified-user .username {
    color: var(--text);
  }
  
  /* =====================================================
     ACTION BUTTONS - بدون دوائر
  ===================================================== */
  .article-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    justify-content: flex-start;
    flex-wrap: wrap;
  }
  
  .action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    color: var(--text-light);
    font-weight: 500;
    font-size: 14px;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    background: transparent;
    border: none;
  }
  
  .action-btn:hover {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .action-btn.like {
    color: var(--text-light);
  }
  
  .action-btn.like:hover {
    color: var(--red);
  }
  
  .action-btn.like.active {
    color: var(--red);
  }
  
  .action-btn.comment {
    color: var(--text-light);
  }
  
  .action-btn.comment:hover {
    color: #4fc3f7;
  }
  
  .action-btn.delete {
    color: var(--red);
  }
  
  .action-btn i {
    font-size: 16px;
  }
  
  .action-btn span {
    font-weight: 500;
    font-size: 13px;
  }
  
  .action-btn.processing {
    opacity: 0.7;
    cursor: not-allowed;
  }
  
  /* =====================================================
     CHARACTER COUNTERS
  ===================================================== */
  .char-counter {
    font-size: 11px;
    margin-top: 4px;
    text-align: right;
    font-weight: 500;
    color: var(--text-muted);
  }
  
  .char-counter.warning {
    color: #ffa502;
  }
  
  .char-counter.error {
    color: var(--red);
  }
  
  /* =====================================================
     COOLDOWN TIMER
  ===================================================== */
  .cooldown-timer {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 12px;
    background: #222222;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }
  
  .cooldown-timer .timer {
    color: var(--red);
    font-weight: 600;
    font-size: 14px;
  }
  
  /* =====================================================
     LOAD MORE BUTTONS
  ===================================================== */
  .load-more-container {
    text-align: center;
    margin: 30px 0;
  }
  
  .load-more-btn {
    padding: 14px 28px;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-light);
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .load-more-btn:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--accent);
  }
  
  .load-more-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .load-more-btn.loading {
    opacity: 0.7;
    cursor: not-allowed;
  }
  
  /* =====================================================
     CONTENT SECTIONS
  ===================================================== */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .section-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    position: relative;
    padding-bottom: 6px;
  }
  
  .article-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 10px;
    line-height: 1.4;
    color: var(--text);
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
  }
  
  .article-content {
    font-size: 14px;
    line-height: 1.7;
    margin: 16px 0;
    color: var(--text-light);
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
  }
  
  .article-meta {
    font-size: 12px;
    color: var(--text-muted);
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .article-meta i {
    margin-left: 4px;
  }
  
  .profile-header {
    display: flex;
    gap: 16px;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: #222222;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
    color: white;
    border: 2px solid var(--border);
  }
  
  .profile-stats {
    display: flex;
    gap: 20px;
    margin: 20px 0;
    padding: 20px;
    background: #222222;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }
  
  .stat {
    text-align: center;
    flex: 1;
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
    font-weight: 500;
  }
  
  /* =====================================================
     FILTERS & SORTING
  ===================================================== */
  .filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-btn {
    padding: 10px 16px;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text-light);
    font-size: 13px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
  }
  
  .filter-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: black;
  }
  
  .filter-btn:hover:not(.active) {
    border-color: var(--accent);
    color: var(--accent);
  }
  
  /* =====================================================
     MODALS
  ===================================================== */
  .modal-overlay {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }
  
  .modal {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 24px;
    width: 90%;
    max-width: 600px;
    border: 1px solid var(--border);
    position: relative;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .modal-header h3 {
    font-size: 20px;
    color: var(--text);
  }
  
  .modal-close {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-muted);
    font-size: 18px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--border);
    transition: all 0.2s;
  }
  
  .modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border-color: var(--accent);
  }
  
  /* =====================================================
     COMMENTS
  ===================================================== */
  .comments-section {
    margin-top: 30px;
    border-top: 1px solid var(--border);
    padding-top: 20px;
  }
  
  .comment {
    background: #222222;
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-top: 12px;
    border-left: 2px solid var(--accent);
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    border: 1px solid var(--border);
  }
  
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .comment-author {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .comment-time {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 500;
  }
  
  .comment-content {
    font-size: 13px;
    line-height: 1.6;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    color: var(--text-light);
  }
  
  /* =====================================================
     LOADING & EMPTY STATES
  ===================================================== */
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }
  
  .empty-state i {
    font-size: 40px;
    margin-bottom: 16px;
    opacity: 0.5;
    color: var(--text);
  }
  
  .empty-state h3 {
    font-size: 18px;
    margin-bottom: 12px;
    color: var(--text);
  }
  
  /* =====================================================
     NOTIFICATION
  ===================================================== */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--panel);
    border-radius: var(--radius);
    padding: 16px 20px;
    border-left: 3px solid var(--accent);
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 1001;
    max-width: 400px;
    border: 1px solid var(--border);
  }
  
  .notification.success {
    border-left-color: #00d2a0;
  }
  
  .notification.error {
    border-left-color: var(--red);
  }
  
  .notification i {
    font-size: 18px;
  }
  
  .notification.success i {
    color: #00d2a0;
  }
  
  .notification.error i {
    color: var(--red);
  }
  
  /* =====================================================
     VIEW COUNT
  ===================================================== */
  .view-count {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    font-weight: 500;
    font-size: 12px;
  }
  
  .view-count i {
    margin-left: 4px;
    color: var(--text-muted);
  }
  
  /* =====================================================
     BANNED USER STYLES
  ===================================================== */
  .banned-overlay {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  
  .banned-message {
    background: var(--card);
    border: 2px solid var(--red);
    border-radius: var(--radius);
    padding: 40px;
    max-width: 500px;
    text-align: center;
  }
  
  .banned-icon {
    font-size: 60px;
    color: var(--red);
    margin-bottom: 20px;
  }
  
  .banned-title {
    font-size: 24px;
    color: var(--red);
    margin-bottom: 15px;
  }
  
  .banned-reason {
    font-size: 16px;
    color: var(--text);
    margin-bottom: 20px;
    background: rgba(255, 71, 87, 0.1);
    padding: 15px;
    border-radius: var(--radius-sm);
  }
  
  .banned-details {
    font-size: 14px;
    color: var(--text-muted);
    margin-top: 20px;
  }
  
  /* =====================================================
     RESPONSIVE DESIGN
  ===================================================== */
  @media (max-width: 992px) {
    .menu-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sidebar {
      position: fixed;
      top: 70px;
      left: -280px;
      height: calc(100vh - 70px);
      z-index: 100;
      width: 280px;
      transition: left 0.3s;
    }
    
    .sidebar.active {
      left: 0;
    }
    
    .sidebar-overlay.active {
      display: block;
    }
    
    main {
      padding: 16px;
      width: 100%;
    }
    
    .section-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .profile-stats {
      gap: 16px;
      flex-wrap: wrap;
      padding: 16px;
    }
    
    .modal {
      width: 95%;
      padding: 20px;
    }
    
    .auth-card .profile-header {
      flex-direction: row;
      text-align: right;
    }
    
    .article-actions {
      gap: 10px;
      justify-content: center;
    }
    
    .action-btn {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .action-btn span {
      font-size: 13px;
    }
    
    .load-more-btn {
      padding: 12px 24px;
      font-size: 13px;
    }
  }
  
  @media (max-width: 768px) {
    header {
      padding: 0 16px;
      height: 60px;
    }
    
    .logo {
      font-size: 16px;
    }
    
    .logo i {
      font-size: 16px;
    }
    
    .sidebar {
      width: 250px;
      left: -250px;
    }
    
    .section-title {
      font-size: 18px;
    }
    
    .article-title {
      font-size: 16px;
    }
    
    .article-content {
      font-size: 13px;
    }
    
    .card {
      padding: 16px;
    }
    
    .modal {
      padding: 16px;
    }
    
    .profile-stats {
      gap: 12px;
      padding: 14px;
    }
    
    .stat-value {
      font-size: 20px;
    }
    
    .stat-label {
      font-size: 11px;
    }
    
    .btn.small {
      padding: 8px 14px;
      font-size: 12px;
    }
    
    .filter-btn {
      padding: 8px 12px;
      font-size: 12px;
    }
    
    .notification {
      right: 16px;
      left: 16px;
      max-width: none;
      bottom: 16px;
    }
    
    .menu-item {
      padding: 12px 14px;
      font-size: 13px;
    }
    
    .auth-card {
      padding: 16px;
    }
    
    .auth-card .auth-buttons {
      gap: 8px;
    }
    
    .btn {
      padding: 12px;
      font-size: 13px;
    }
    
    .auth-card .profile-header {
      gap: 12px;
    }
    
    .auth-card .profile-header .avatar {
      width: 45px;
      height: 45px;
      font-size: 16px;
    }
    
    .auth-card .profile-header .user-info strong {
      font-size: 14px;
    }
    
    .article-meta {
      font-size: 11px;
      gap: 10px;
    }
    
    .action-btn {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    .action-btn i {
      font-size: 14px;
    }
    
    .action-btn span {
      font-size: 12px;
    }
    
    .banned-message {
      padding: 20px;
    }
    
    .banned-icon {
      font-size: 40px;
    }
    
    .banned-title {
      font-size: 20px;
    }
  }
  
  @media (max-width: 576px) {
    header {
      padding: 0 12px;
    }
    
    .logo {
      font-size: 14px;
      gap: 6px;
    }
    
    .logo i {
      font-size: 14px;
    }
    
    .section-title {
      font-size: 16px;
    }
    
    .card {
      padding: 14px;
    }
    
    .modal {
      padding: 14px;
    }
    
    .profile-stats {
      gap: 10px;
      padding: 12px;
    }
    
    .stat-value {
      font-size: 18px;
    }
    
    .stat-label {
      font-size: 10px;
    }
    
    .article-title {
      font-size: 15px;
    }
    
    .article-content {
      font-size: 12px;
    }
    
    .btn.small {
      padding: 7px 12px;
      font-size: 11px;
    }
    
    .filter-btn {
      padding: 7px 12px;
      font-size: 11px;
    }
    
    .action-btn {
      padding: 5px 8px;
      font-size: 11px;
    }
    
    .action-btn i {
      font-size: 12px;
    }
    
    .action-btn span {
      font-size: 11px;
    }
    
    .article-actions {
      gap: 8px;
    }
    
    .menu-item {
      padding: 10px 12px;
      font-size: 12px;
    }
    
    .auth-card .profile-header .avatar {
      width: 40px;
      height: 40px;
      font-size: 14px;
    }
    
    .auth-card .profile-header .user-info strong {
      font-size: 13px;
    }
    
    .filters {
      gap: 6px;
      justify-content: center;
    }
    
    .load-more-btn {
      padding: 10px 20px;
      font-size: 12px;
    }
  }
  
  @media (max-width: 400px) {
    .logo {
      font-size: 13px;
    }
    
    .logo i {
      font-size: 13px;
    }
    
    .section-title {
      font-size: 15px;
    }
    
    .article-title {
      font-size: 14px;
    }
    
    .article-actions {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }
    
    .action-btn {
      width: 100%;
      justify-content: flex-start;
    }
    
    .filters {
      justify-content: space-between;
    }
    
    .filter-btn {
      flex: 1;
      justify-content: center;
    }
  }
  
  /* ===============================
     REMOVE DEFAULT BLUE TAP / FOCUS
     (SAFE - DOES NOT AFFECT CUSTOM EFFECTS)
  ================================ */
  * {
    -webkit-tap-highlight-color: transparent;
  }

  :focus-visible {
    outline: none;
  }

  button:focus,
  a:focus,
  .action-btn:focus,
  .menu-item:focus {
    outline: none;
    box-shadow: none;
  }


  /* ===============================
     COPY CONTROL
  ================================ */
  * {
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }

  .article-content,
  .comment-content {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
  }
  </style>
</head>
<body>
  <!-- ================= BANNED USER OVERLAY ================= -->
  <div class="banned-overlay" id="bannedOverlay">
    <div class="banned-message">
      <div class="banned-icon">
        <i class="fas fa-ban"></i>
      </div>
      <h2 class="banned-title">حسابك محظور</h2>
      <div class="banned-reason" id="banReasonText"></div>
      <div class="banned-details">
        <p><i class="fas fa-info-circle"></i> لا يمكنك النشر أو التعليق أو الإعجاب</p>
        <p><i class="fas fa-clock"></i> للحصول على المساعدة، اتصل بإدارة المنتدى</p>
      </div>
    </div>
  </div>
  
  <header>
    <div class="logo">
      <i class="fas fa-pills"></i>
      <span>منتدى الريدبيل</span>
    </div>
    
    <button class="menu-toggle" id="menuToggle">
      <i class="fas fa-bars"></i>
    </button>
  </header>
  
  <div class="app">
    <!-- ================= SIDEBAR ================= -->
    <div class="sidebar" id="sidebar">
      <div id="authBox" class="auth-card"></div>
      
      <div class="card">
        <h4><i class="fas fa-sliders-h"></i> القائمة الرئيسية</h4>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 16px;">
          <button class="menu-item active" onclick="showSection('articles')">
            <i class="fas fa-newspaper"></i>
            <span>المقالات</span>
          </button>
          
          <button class="menu-item" onclick="showSection('profile')">
            <i class="fas fa-user-circle"></i>
            <span>الملف الشخصي</span>
          </button>
          
          <button class="menu-item" onclick="showSection('myArticles')">
            <i class="fas fa-file-alt"></i>
            <span>مقالاتي</span>
          </button>
          
          <button class="menu-item" onclick="openPublishModal()">
            <i class="fas fa-pen-fancy"></i>
            <span>نشر مقال جديد</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <!-- ================= MAIN CONTENT ================= -->
    <main>
      <!-- مقالات Section (Default) -->
      <div id="articlesSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title"><i class="fas fa-fire"></i> المقالات الشائعة</h2>
          <div class="filters">
            <button class="filter-btn active" onclick="filterArticles('all')">
              <i class="fas fa-layer-group"></i> الكل
            </button>
            <button class="filter-btn" onclick="filterArticles('popular')">
              <i class="fas fa-fire"></i> الأكثر شعبية
            </button>
            <button class="filter-btn" onclick="filterArticles('recent')">
              <i class="fas fa-clock"></i> الأحدث
            </button>
          </div>
        </div>
        
        <div id="articles" class="articles-container">
          <div class="loading" id="loadingArticles">
            <div class="spinner"></div>
          </div>
        </div>
        
        <div id="loadMoreArticlesContainer" class="load-more-container" style="display: none;">
          <button class="load-more-btn" id="loadMoreArticlesBtn" onclick="loadMoreArticles()">
            <i class="fas fa-redo"></i> تحميل المزيد من المقالات
          </button>
        </div>
      </div>
      
      <!-- الملف الشخصي Section -->
      <div id="profileSection" class="content-section" style="display: none;">
        <div class="section-header">
          <h2 class="section-title"><i class="fas fa-user-circle"></i> الملف الشخصي</h2>
          <button class="btn small ghost" onclick="showSection('articles')">
            <i class="fas fa-arrow-right"></i> العودة للمقالات
          </button>
        </div>
        
        <div id="profileView"></div>
      </div>
      
      <!-- مقالاتي Section -->
      <div id="myArticlesSection" class="content-section" style="display: none;">
        <div class="section-header">
          <h2 class="section-title"><i class="fas fa-file-alt"></i> مقالاتي</h2>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn small" onclick="openPublishModal()">
              <i class="fas fa-plus"></i> مقال جديد
            </button>
            <button class="btn small ghost" onclick="showSection('articles')">
              <i class="fas fa-arrow-right"></i> العودة
            </button>
          </div>
        </div>
        
        <div id="myArticlesView"></div>
      </div>
    </main>
  </div>
  
  <!-- ================= PUBLISH MODAL ================= -->
  <div class="modal-overlay" id="publishModal">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-pen-fancy"></i> كتابة مقال جديد</h3>
        <button class="modal-close" onclick="closePublishModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-content">
        <label>عنوان المقال (70 حرف كحد أقصى)</label>
        <input id="articleTitle" placeholder="اكتب عنوانًا جذابًا لمقالك" maxlength="70">
        <div class="char-counter" id="titleCounter">0/70</div>
        
        <label style="margin-top: 16px;">نص المقال (2000 حرف كحد أقصى)</label>
        <textarea id="articleContent" placeholder="اكتب محتوى مقالك هنا..." rows="6" maxlength="2000"></textarea>
        <div class="char-counter" id="contentCounter">0/2000</div>
        
        <div id="cooldownMessage" class="cooldown-timer" style="display: none;">
          <i class="fas fa-clock"></i>
          <span>يمكنك نشر المقال التالي خلال:</span>
          <span class="timer" id="articleCooldownTimer">60:00</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
          <div>
            <label>التصنيف</label>
            <select id="articleCategory">
              <option value="ريدبيل">ريدبيل</option>
              <option value="بلاك بيل">بلاك بيل</option>
              <option value="غير مصنف">غير مصنف</option>
            </select>
          </div>
          
          <div>
            <label>القراءة المتوقعة</label>
            <select id="articleReadTime">
              <option value="1">دقيقة واحدة</option>
              <option value="3">٣ دقائق</option>
              <option value="5">٥ دقائق</option>
              <option value="10">١٠ دقائق</option>
              <option value="15">١٥ دقيقة</option>
            </select>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" style="flex: 1;" onclick="publishArticle()" id="publishBtn">
            <i class="fas fa-paper-plane"></i> نشر المقال
          </button>
          <button class="btn ghost" onclick="closePublishModal()" style="width: auto;">
            إلغاء
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= COMMENT MODAL ================= -->
  <div class="modal-overlay" id="commentModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3><i class="fas fa-comments"></i> التعليقات</h3>
        <button class="modal-close" onclick="closeCommentModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-content">
        <div id="commentsList" style="max-height: 300px; overflow-y: auto; padding-left: 5px;"></div>
        
        <div id="loadMoreCommentsContainer" class="load-more-container" style="display: none;">
          <button class="load-more-btn" id="loadMoreCommentsBtn" onclick="loadMoreComments()">
            <i class="fas fa-redo"></i> تحميل المزيد من التعليقات
          </button>
        </div>
        
        <div style="margin-top: 20px;">
          <textarea id="newComment" placeholder="اكتب تعليقك هنا (1500 حرف كحد أقصى)..." rows="3" maxlength="1500"></textarea>
          <div class="char-counter" id="commentCounter">0/1500</div>
          
          <div id="commentCooldownMessage" class="cooldown-timer" style="display: none;">
            <i class="fas fa-clock"></i>
            <span>يمكنك إضافة التعليق التالي خلال:</span>
            <span class="timer" id="commentCooldownTimer">60</span>
            <span>ثانية</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <div class="muted" style="font-size: 11px;">
              اضغط Ctrl+Enter لإرسال التعليق
            </div>
            <button class="btn small" onclick="postComment()" id="postCommentBtn">
              <i class="fas fa-paper-plane"></i> إضافة تعليق
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= NOTIFICATION ================= -->
  <div class="notification" id="notification">
    <i class="fas fa-check-circle" id="notificationIcon"></i>
    <span id="notificationText"></span>
  </div>

  <script type="module">
  /* =====================================================
     FIREBASE IMPORTS
  ===================================================== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getDatabase, ref, push, get, update, set, remove, increment, query, orderByChild, limitToLast, limitToFirst, startAt, endAt } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  
  /* =====================================================
     CONFIG
  ===================================================== */
  const firebaseConfig = {
    apiKey: "AIzaSyCdoubvkI7VEvYxtG3CzKFAJg74XXl7fX4",
    authDomain: "redpill-1c7e2.firebaseapp.com",
    databaseURL: "https://redpill-1c7e2-default-rtdb.firebaseio.com",
    projectId: "redpill-1c7e2",
    storageBucket: "redpill-1c7e2.firebasestorage.app",
    messagingSenderId: "337690521778",
    appId: "1:337690521778:web:ba3c99ad55e6b0d58f59ab"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  
  // DOM Elements
  const authBox = document.getElementById('authBox');
  const articlesDiv = document.getElementById('articles');
  const profileView = document.getElementById('profileView');
  const myArticlesView = document.getElementById('myArticlesView');
  const publishModal = document.getElementById('publishModal');
  const commentModal = document.getElementById('commentModal');
  const notification = document.getElementById('notification');
  const menuToggle = document.getElementById('menuToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const loadMoreArticlesContainer = document.getElementById('loadMoreArticlesContainer');
  const loadMoreArticlesBtn = document.getElementById('loadMoreArticlesBtn');
  const loadMoreCommentsContainer = document.getElementById('loadMoreCommentsContainer');
  const loadMoreCommentsBtn = document.getElementById('loadMoreCommentsBtn');
  const bannedOverlay = document.getElementById('bannedOverlay');
  const banReasonText = document.getElementById('banReasonText');
  
  // Character counters
  const titleCounter = document.getElementById('titleCounter');
  const contentCounter = document.getElementById('contentCounter');
  const commentCounter = document.getElementById('commentCounter');
  
  // Section elements
  const articlesSection = document.getElementById('articlesSection');
  const profileSection = document.getElementById('profileSection');
  const myArticlesSection = document.getElementById('myArticlesSection');
  
  // Global variables
  let currentUser = null;
  let currentArticleId = null;
  let currentFilter = 'all';
  let allArticles = [];
  let articlesLoading = false;
  let isUserBanned = false;
  let banData = null;
  
  // Pagination variables for articles
  let lastArticleTimestamp = null;
  let hasMoreArticles = true;
  const articlesPerPage = 10;
  
  // Pagination variables for comments
  let lastCommentTimestamp = null;
  let hasMoreComments = true;
  const commentsPerPage = 10;
  
  // Rate limiting constants
  const ARTICLE_COOLDOWN = 60 * 60 * 1000;
  const COMMENT_COOLDOWN = 60 * 1000;
  const LIKE_COOLDOWN = 2000;
  
  // Character limits
  const TITLE_MAX_LENGTH = 70;
  const CONTENT_MAX_LENGTH = 2000;
  const COMMENT_MAX_LENGTH = 1500;
  
  // Cooldown timers
  let articleCooldownTimer = null;
  let commentCooldownTimer = null;
  let articleCooldownEnd = 0;
  let commentCooldownEnd = 0;
  
  // Store article likes locally
  const articleLikes = new Map();
  
  // Store user data cache
  const userDataCache = new Map();
  
  // Cache constants
  const CACHE_DURATION = 5 * 60 * 1000; // 5 دقائق
  const CACHE_KEYS = {
    ARTICLES: 'forum_articles_cache',
    ARTICLES_TIMESTAMP: 'forum_articles_timestamp',
    USER_ARTICLES: 'forum_user_articles_cache',
    USER_ARTICLES_TIMESTAMP: 'forum_user_articles_timestamp'
  };
  
  // Debounce for API calls
  let fetchDebounceTimer = null;
  
  /* =====================================================
     UTILITY FUNCTIONS
  ===================================================== */
  
  // توليد اسم مستخدم عشوائي
  function generateRandomUsername() {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let randomPart = '';
    for (let i = 0; i < 4; i++) {
      randomPart += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return `ريدبيلي${randomPart}`;
  }
  
  function formatDate(timestamp) {
    if (!timestamp || timestamp === 0) return 'غير محدد';
    
    const date = new Date(timestamp);
    if (isNaN(date.getTime())) return 'تاريخ غير صالح';
    
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60 * 1000) {
      return 'الآن';
    }
    
    if (diff < 60 * 60 * 1000) {
      const minutes = Math.floor(diff / (60 * 1000));
      return `منذ ${minutes} دقيقة`;
    }
    
    if (diff < 24 * 60 * 60 * 1000) {
      const hours = Math.floor(diff / (60 * 60 * 1000));
      return `منذ ${hours} ساعة`;
    }
    
    if (diff < 7 * 24 * 60 * 60 * 1000) {
      const days = Math.floor(diff / (24 * 60 * 60 * 1000));
      return `منذ ${days} يوم`;
    }
    
    return date.toLocaleDateString('ar-SA', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  function showNotification(message, type = 'success') {
    const icon = document.getElementById('notificationIcon');
    const text = document.getElementById('notificationText');
    
    if (type === 'success') {
      icon.className = 'fas fa-check-circle';
      notification.classList.add('success');
      notification.classList.remove('error');
    } else {
      icon.className = 'fas fa-exclamation-circle';
      notification.classList.add('error');
      notification.classList.remove('success');
    }
    
    text.textContent = message;
    notification.style.display = 'flex';
    
    setTimeout(() => {
      notification.style.display = 'none';
    }, 3000);
  }
  
  /* =====================================================
     BAN CHECK SYSTEM
  ===================================================== */
  async function checkIfUserIsBanned(uid) {
    if (!uid) return false;
    
    try {
      const banRef = ref(db, `admin/bans/${uid}`);
      const snap = await get(banRef);
      
      if (snap.exists()) {
        const banInfo = snap.val();
        
        // التحقق إذا كان الحظر لا يزال فعالاً
        const now = Date.now();
        if (banInfo.bannedUntil !== 'permanent' && banInfo.bannedUntil < now) {
          // الحظر انتهى صلاحيته، حذف بيانات الحظر
          await remove(banRef);
          return false;
        }
        
        banData = banInfo;
        return true;
      }
      return false;
    } catch (error) {
      console.log('Error checking ban status:', error);
      return false;
    }
  }
  
  function showBanOverlay() {
    if (banData) {
      let reasonText = 'تم حظر حسابك';
      if (banData.reason === 'spam') {
        reasonText = 'تم حظر حسابك بسبب: نشر محتوى غير مرغوب';
      } else if (banData.reason === 'abuse') {
        reasonText = 'تم حظر حسابك بسبب: إساءة استخدام النظام';
      } else if (banData.reason === 'violation') {
        reasonText = 'تم حظر حسابك بسبب: انتهاك شروط الاستخدام';
      } else if (banData.reason === 'other' && banData.notes) {
        reasonText = `تم حظر حسابك بسبب: ${banData.notes}`;
      }
      
      banReasonText.textContent = reasonText;
      bannedOverlay.style.display = 'flex';
    }
  }
  
  function hideBanOverlay() {
    bannedOverlay.style.display = 'none';
  }
  
  /* =====================================================
     CACHING FUNCTIONS
  ===================================================== */
  function getFromCache(key) {
    try {
      const cached = localStorage.getItem(key);
      return cached ? JSON.parse(cached) : null;
    } catch (error) {
      console.log('Error reading cache:', error);
      return null;
    }
  }
  
  function saveToCache(key, data) {
    try {
      localStorage.setItem(key, JSON.stringify(data));
    } catch (error) {
      console.log('Error saving cache:', error);
    }
  }
  
  function isCacheValid(timestampKey) {
    try {
      const cachedTime = localStorage.getItem(timestampKey);
      if (!cachedTime) return false;
      
      const timeDiff = Date.now() - parseInt(cachedTime);
      return timeDiff < CACHE_DURATION;
    } catch (error) {
      return false;
    }
  }
  
  function updateCacheTimestamp(timestampKey) {
    localStorage.setItem(timestampKey, Date.now().toString());
  }
  
  /* =====================================================
     SIDEBAR FUNCTIONS
  ===================================================== */
  function toggleSidebar() {
    sidebar.classList.toggle('active');
    sidebarOverlay.classList.toggle('active');
  }
  
  menuToggle.addEventListener('click', toggleSidebar);
  sidebarOverlay.addEventListener('click', toggleSidebar);
  
  function closeSidebarOnMobile() {
    if (window.innerWidth <= 992) {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    }
  }
  
  window.addEventListener('resize', () => {
    if (window.innerWidth > 992) {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    }
  });
  
  /* =====================================================
     SECTION NAVIGATION
  ===================================================== */
  window.showSection = (sectionName) => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    articlesSection.style.display = 'none';
    profileSection.style.display = 'none';
    myArticlesSection.style.display = 'none';
    
    document.querySelectorAll('.menu-item').forEach(item => {
      item.classList.remove('active');
    });
    
    switch(sectionName) {
      case 'articles':
        articlesSection.style.display = 'block';
        document.querySelector('.menu-item:nth-child(1)').classList.add('active');
        resetArticlesPagination();
        loadArticles();
        break;
      case 'profile':
        profileSection.style.display = 'block';
        document.querySelector('.menu-item:nth-child(2)').classList.add('active');
        openProfile();
        break;
      case 'myArticles':
        myArticlesSection.style.display = 'block';
        document.querySelector('.menu-item:nth-child(3)').classList.add('active');
        openMyArticles();
        break;
    }
    
    closeSidebarOnMobile();
  };
  
  /* =====================================================
     AUTHENTICATION
  ===================================================== */
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    
    if (user) {
      // التحقق من حالة الحظر
      isUserBanned = await checkIfUserIsBanned(user.uid);
      
      if (isUserBanned) {
        showBanOverlay();
        authBox.innerHTML = `
          <div class="profile-header">
            <div class="avatar">${user.email[0].toUpperCase()}</div>
            <div class="user-info">
              <strong>${user.email.split('@')[0]}</strong>
              <div class="muted" style="color: var(--red);">
                <i class="fas fa-ban"></i> حساب محظور
              </div>
            </div>
          </div>
          <div class="auth-buttons">
            <button class="btn ghost" id="logout">
              <i class="fas fa-sign-out-alt"></i> تسجيل خروج
            </button>
          </div>
        `;
        
        document.getElementById('logout').onclick = () => {
          signOut(auth).then(() => {
            hideBanOverlay();
            showNotification('تم تسجيل الخروج بنجاح', 'success');
          });
        };
        
        showSection('articles');
        return;
      }
      
      authBox.innerHTML = `
        <div class="profile-header">
          <div class="avatar">${user.email[0].toUpperCase()}</div>
          <div class="user-info">
            <strong>${user.email.split('@')[0]}</strong>
            <div class="muted">عضو مسجل</div>
            <div class="muted" style="margin-top: 4px; font-size: 11px;">
              <i class="fas fa-clock"></i> ${formatDate(user.metadata.lastSignInTime || Date.now())}
            </div>
          </div>
        </div>
        <div class="auth-buttons">
          <button class="btn ghost" id="logout">
            <i class="fas fa-sign-out-alt"></i> تسجيل خروج
          </button>
        </div>
      `;
      
      document.getElementById('logout').onclick = () => {
        signOut(auth).then(() => {
          showNotification('تم تسجيل الخروج بنجاح', 'success');
        });
      };
      
      initProfile(user.uid);
    } else {
      hideBanOverlay();
      isUserBanned = false;
      banData = null;
      
      authBox.innerHTML = `
        <h3 style="margin-bottom: 12px; color: var(--text-light); font-size: 14px;">
          <i class="fas fa-user" style="margin-left: 6px;"></i> تسجيل الدخول
        </h3>
        <div class="auth-form">
          <input id="email" type="email" placeholder="البريد الإلكتروني">
          <input id="pass" type="password" placeholder="كلمة المرور">
          <div class="auth-buttons">
            <button class="btn" id="login">
              <i class="fas fa-sign-in-alt"></i> دخول
            </button>
            <button class="btn ghost" id="register">
              <i class="fas fa-user-plus"></i> إنشاء حساب جديد
            </button>
          </div>
        </div>
        <div class="muted" style="margin-top: 12px; font-size: 11px; text-align: center;">
          <p>بتسجيل الدخول، يمكنك نشر المقالات والتعليق والإعجاب</p>
        </div>
      `;
      
      document.getElementById('login').onclick = () => login();
      document.getElementById('register').onclick = () => register();
      
      const passInput = document.getElementById('pass');
      if (passInput) {
        passInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') login();
        });
      }
    }
    
    if (articlesSection.style.display === 'block') {
      resetArticlesPagination();
      loadArticles();
    }
  });
  
  function login() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    
    if (!email || !pass) {
      showNotification('يرجى ملء جميع الحقول', 'error');
      return;
    }
    
    signInWithEmailAndPassword(auth, email, pass)
      .then(() => showNotification('تم تسجيل الدخول بنجاح', 'success'))
      .catch(e => {
        if (e.code === 'auth/invalid-credential') {
          showNotification('البريد الإلكتروني أو كلمة المرور غير صحيحة', 'error');
        } else if (e.code === 'auth/user-not-found') {
          showNotification('الحساب غير موجود', 'error');
        } else if (e.code === 'auth/wrong-password') {
          showNotification('كلمة المرور غير صحيحة', 'error');
        } else {
          showNotification(e.message, 'error');
        }
      });
  }
  
  async function register() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    
    if (!email || !pass) {
      showNotification('يرجى ملء جميع الحقول', 'error');
      return;
    }
    
    if (pass.length < 6) {
      showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
      return;
    }
    
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
      const user = userCredential.user;
      
      // إنشاء اسم مستخدم عشوائي
      const randomUsername = generateRandomUsername();
      
      // حفظ بيانات المستخدم مع اسم المستخدم العشوائي
      await set(ref(db, `users/${user.uid}`), {
        username: randomUsername,
        email: email,
        joinDate: Date.now(),
        lastLogin: Date.now(),
        articlesCount: 0,
        likesCount: 0,
        commentsCount: 0,
        verified: false,
        bio: 'مرحبًا! أنا عضو جديد في منتدى الريدبيل.'
      });
      
      showNotification('تم إنشاء الحساب بنجاح', 'success');
    } catch (e) {
      if (e.code === 'auth/email-already-in-use') {
        showNotification('البريد الإلكتروني مسجل بالفعل', 'error');
      } else if (e.code === 'auth/invalid-email') {
        showNotification('البريد الإلكتروني غير صالح', 'error');
      } else if (e.code === 'auth/weak-password') {
        showNotification('كلمة المرور ضعيفة، يجب أن تكون 6 أحرف على الأقل', 'error');
      } else {
        showNotification(e.message, 'error');
      }
    }
  }
  
  /* =====================================================
     USER DATA FUNCTIONS - لجلب اسم المستخدم وبيانات التوثيق
  ===================================================== */
  async function getUserData(userId) {
    if (!userId) return null;
    
    // التحقق من التخزين المؤقت
    if (userDataCache.has(userId)) {
      return userDataCache.get(userId);
    }
    
    try {
      const userRef = ref(db, 'users/' + userId);
      const snap = await get(userRef);
      
      if (snap.exists()) {
        const userData = snap.val();
        userDataCache.set(userId, userData);
        return userData;
      } else {
        // إذا لم يكن هناك بيانات مستخدم، إنشاء بيانات افتراضية
        const defaultUserData = {
          username: generateRandomUsername(),
          joinDate: Date.now(),
          lastLogin: Date.now(),
          articlesCount: 0,
          likesCount: 0,
          commentsCount: 0,
          verified: false,
          bio: 'مرحبًا! أنا عضو في منتدى الريدبيل.'
        };
        
        // حفظ البيانات الافتراضية في قاعدة البيانات
        await set(userRef, defaultUserData);
        userDataCache.set(userId, defaultUserData);
        return defaultUserData;
      }
    } catch (error) {
      console.log('Error fetching user data:', error);
      // في حالة الخطأ، إرجاع بيانات افتراضية
      const defaultUserData = {
        username: `مستخدم_${userId ? userId.substring(0, 6) : 'غير_معروف'}`,
        joinDate: Date.now(),
        articlesCount: 0,
        likesCount: 0,
        commentsCount: 0,
        verified: false,
        bio: 'مرحبًا! أنا عضو في منتدى الريدبيل.'
      };
      userDataCache.set(userId, defaultUserData);
      return defaultUserData;
    }
  }
  
  async function getUsername(userId) {
    if (!userId) return 'مجهول';
    
    const userData = await getUserData(userId);
    if (userData && userData.username) {
      return userData.username;
    }
    return 'مستخدم';
  }
  
  async function isUserVerified(userId) {
    if (!userId) return false;
    
    const userData = await getUserData(userId);
    return userData && userData.verified === true;
  }
  
  function getUsernameWithVerification(username, isVerified) {
    if (isVerified) {
      return `
        <div class="verified-user">
          <span class="username">${username}</span>
          <div class="verified-badge">
            <i class="fas fa-check"></i>
          </div>
        </div>
      `;
    }
    return username;
  }
  
  /* =====================================================
     ARTICLES SYSTEM - تحميل 10 مقالات فقط في كل مرة
     مع التخزين المؤقت
  ===================================================== */
  function resetArticlesPagination() {
    lastArticleTimestamp = null;
    hasMoreArticles = true;
    allArticles = [];
    articlesDiv.innerHTML = '';
    loadMoreArticlesContainer.style.display = 'none';
  }
  
  async function loadArticles() {
    if (articlesLoading) return;
    
    // تطبيق Debounce لتجنب الطلبات المتكررة
    if (fetchDebounceTimer) {
      clearTimeout(fetchDebounceTimer);
    }
    
    fetchDebounceTimer = setTimeout(async () => {
      await loadArticlesInternal();
    }, 300);
  }
  
  async function loadArticlesInternal() {
    articlesLoading = true;
    
    articlesDiv.innerHTML = `
      <div class="loading" id="loadingArticles">
        <div class="spinner"></div>
      </div>
    `;
    loadMoreArticlesContainer.style.display = 'none';
    
    try {
      let articles = [];
      
      // التحقق من التخزين المؤقت أولاً
      if (currentFilter === 'all' && isCacheValid(CACHE_KEYS.ARTICLES_TIMESTAMP)) {
        const cachedArticles = getFromCache(CACHE_KEYS.ARTICLES);
        if (cachedArticles && cachedArticles.length > 0) {
          articles = cachedArticles.slice(0, articlesPerPage);
          allArticles = articles;
          showNotification('جاري عرض المقالات من التخزين المؤقت', 'success');
        }
      }
      
      if (articles.length === 0) {
        // جلب البيانات من Firebase
        articles = await fetchArticles();
        
        if (currentFilter === 'all') {
          // حفظ المقالات في التخزين المؤقت
          saveToCache(CACHE_KEYS.ARTICLES, articles);
          updateCacheTimestamp(CACHE_KEYS.ARTICLES_TIMESTAMP);
        }
      }
      
      if (articles.length === 0) {
        articlesDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-newspaper"></i>
            <h3>لا توجد مقالات بعد</h3>
            <p>كن أول من ينشر مقالًا على المنتدى!</p>
            ${currentUser && !isUserBanned ? `
            <button class="btn" onclick="openPublishModal()" style="margin-top: 16px; width: auto;">
              <i class="fas fa-pen-fancy"></i> نشر أول مقال
            </button>
            ` : `
            <button class="btn" onclick="login()" style="margin-top: 16px; width: auto;">
              <i class="fas fa-sign-in-alt"></i> تسجيل الدخول للنشر
            </button>
            `}
          </div>
        `;
        articlesLoading = false;
        return;
      }
      
      articlesDiv.innerHTML = '';
      
      // تحميل الإعجابات للمستخدم الحالي
      if (currentUser && !isUserBanned) {
        await loadUserLikes();
      }
      
      // حفظ المقالات وعرضها
      for (const article of articles) {
        if (!allArticles.some(a => a.id === article.id)) {
          allArticles.push(article);
          await renderArticle(article);
        }
      }
      
      // التحقق إذا كان هناك المزيد من المقالات
      hasMoreArticles = articles.length === articlesPerPage;
      loadMoreArticlesContainer.style.display = hasMoreArticles ? 'block' : 'none';
      
    } catch (error) {
      console.error('Error loading articles:', error);
      showNotification('حدث خطأ في تحميل المقالات', 'error');
    } finally {
      articlesLoading = false;
    }
  }
  
  async function fetchArticles() {
    let articlesQuery;
    const articlesRef = ref(db, 'articles');
    
    if (currentFilter === 'popular') {
      // الأكثر شعبية - حسب عدد الإعجابات
      articlesQuery = query(
        articlesRef,
        orderByChild('likesCount'),
        limitToLast(articlesPerPage)
      );
    } else {
      // الأحدث أو الكل - حسب التاريخ
      articlesQuery = query(
        articlesRef,
        orderByChild('created'),
        limitToLast(articlesPerPage)
      );
    }
    
    const snap = await get(articlesQuery);
    const articles = [];
    
    if (snap.exists()) {
      snap.forEach(articleSnap => {
        const article = {
          id: articleSnap.key,
          ...articleSnap.val()
        };
        articles.push(article);
      });
    }
    
    return articles.sort((a, b) => b.created - a.created);
  }
  
  window.loadMoreArticles = async () => {
    if (articlesLoading || !hasMoreArticles) return;
    
    articlesLoading = true;
    loadMoreArticlesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
    loadMoreArticlesBtn.classList.add('loading');
    
    try {
      const articles = await fetchMoreArticles();
      
      if (articles.length === 0) {
        hasMoreArticles = false;
        loadMoreArticlesContainer.style.display = 'none';
        return;
      }
      
      // تحميل الإعجابات للمقالات الجديدة
      if (currentUser && !isUserBanned) {
        await loadUserLikesForArticles(articles);
      }
      
      // عرض المقالات الجديدة
      for (const article of articles) {
        // تجنب التكرار
        if (!allArticles.some(a => a.id === article.id)) {
          allArticles.push(article);
          await renderArticle(article);
        }
      }
      
      hasMoreArticles = articles.length === articlesPerPage;
      loadMoreArticlesContainer.style.display = hasMoreArticles ? 'block' : 'none';
      
    } catch (error) {
      console.error('Error loading more articles:', error);
      showNotification('حدث خطأ في تحميل المزيد من المقالات', 'error');
    } finally {
      articlesLoading = false;
      loadMoreArticlesBtn.innerHTML = '<i class="fas fa-redo"></i> تحميل المزيد من المقالات';
      loadMoreArticlesBtn.classList.remove('loading');
    }
  };
  
  async function fetchMoreArticles() {
    if (allArticles.length === 0) return [];
    
    // استخدام آخر مقال كمعيار للاستمرار في التحميل
    const lastArticle = allArticles[allArticles.length - 1];
    const lastTimestamp = lastArticle.created;
    
    let articlesQuery;
    const articlesRef = ref(db, 'articles');
    
    if (currentFilter === 'popular') {
      // للأكثر شعبية - نحتاج إلى تحسين هذا الجزء
      articlesQuery = query(
        articlesRef,
        orderByChild('likesCount'),
        limitToLast(articlesPerPage + allArticles.length)
      );
    } else {
      // للأحدث - جلب المقالات الأقدم من آخر مقال
      articlesQuery = query(
        articlesRef,
        orderByChild('created'),
        endAt(lastTimestamp - 1),
        limitToLast(articlesPerPage)
      );
    }
    
    const snap = await get(articlesQuery);
    const articles = [];
    
    if (snap.exists()) {
      snap.forEach(articleSnap => {
        const article = {
          id: articleSnap.key,
          ...articleSnap.val()
        };
        
        // التأكد من أن المقال ليس مكرراً
        if (!allArticles.some(a => a.id === article.id)) {
          articles.push(article);
        }
      });
    }
    
    return articles.sort((a, b) => b.created - a.created);
  }
  
  window.filterArticles = (filterType) => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    currentFilter = filterType;
    resetArticlesPagination();
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    loadArticles();
  };
  
  async function loadUserLikes() {
    if (!currentUser) return;
    
    try {
      articleLikes.clear();
      const likesRef = ref(db, 'likes');
      const likesSnap = await get(likesRef);
      
      if (likesSnap.exists()) {
        likesSnap.forEach(articleLikesSnap => {
          const articleId = articleLikesSnap.key;
          if (articleLikesSnap.hasChild(currentUser.uid)) {
            articleLikes.set(articleId, true);
          }
        });
      }
    } catch (error) {
      console.log('Error loading user likes:', error);
    }
  }
  
  async function loadUserLikesForArticles(articles) {
    if (!currentUser || !articles.length) return;
    
    try {
      for (const article of articles) {
        const likeRef = ref(db, `likes/${article.id}/${currentUser.uid}`);
        const likeSnap = await get(likeRef);
        if (likeSnap.exists()) {
          articleLikes.set(article.id, true);
        }
      }
    } catch (error) {
      console.log('Error loading likes for new articles:', error);
    }
  }
  
  async function renderArticle(article) {
    const card = document.createElement('div');
    card.className = 'card';
    
    const isAuthor = currentUser && article.author === currentUser.uid;
    const liked = articleLikes.has(article.id);
    
    // جلب اسم المستخدم وبيانات التوثيق
    let username = await getUsername(article.author);
    const isVerified = await isUserVerified(article.author);
    const usernameHTML = getUsernameWithVerification(username, isVerified);
    
    let tagsHTML = '';
    if (article.likesCount > 10) {
      tagsHTML += '<span class="tag hot">🔥 شائع</span>';
    }
    
    if (Date.now() - article.created < 24 * 60 * 60 * 1000) {
      tagsHTML += '<span class="tag new">🆕 جديد</span>';
    }
    
    if (article.category) {
      tagsHTML += `<span class="tag">${article.category}</span>`;
    }
    
    const readTime = article.readTime || Math.max(1, Math.floor((article.content.length || 0) / 500));
    
    let viewsCount = article.viewsCount || 0;
    if (viewsCount === 0) {
      const ageInDays = Math.max(1, Math.floor((Date.now() - article.created) / (24 * 60 * 60 * 1000)));
      const baseViews = Math.floor(Math.random() * 20) + 5;
      const likesBoost = (article.likesCount || 0) * 3;
      const commentsBoost = (article.commentsCount || 0) * 2;
      viewsCount = baseViews + (ageInDays * 5) + likesBoost + commentsBoost;
    }
    
    // إنشاء أزرار الإعجاب والتعليق
    const likeButton = currentUser && !isUserBanned ? 
      `<div class="action-btn like ${liked ? 'active' : ''}" onclick="toggleLike(event, '${article.id}')">
        <i class="${liked ? 'fas' : 'far'} fa-heart" style="${liked ? 'color: #ff4757;' : ''}"></i>
        <span>${article.likesCount || 0}</span>
      </div>` :
      `<div class="action-btn like" onclick="handleBannedAction('يجب تسجيل الدخول للإعجاب')">
        <i class="far fa-heart"></i>
        <span>${article.likesCount || 0}</span>
      </div>`;
    
    const commentButton = currentUser && !isUserBanned ?
      `<div class="action-btn comment" onclick="openComments('${article.id}')">
        <i class="far fa-comment"></i>
        <span>${article.commentsCount || 0}</span>
      </div>` :
      `<div class="action-btn comment" onclick="handleBannedAction('يجب تسجيل الدخول للتعليق')">
        <i class="far fa-comment"></i>
        <span>${article.commentsCount || 0}</span>
      </div>`;
    
    card.innerHTML = `
      <div class="article-title">${article.title || 'عنوان غير محدد'}</div>
      <div style="margin-top: 8px;">
        ${tagsHTML}
      </div>
      <div class="article-meta">
        <span><i class="far fa-calendar"></i> ${formatDate(article.created)}</span>
        <span><i class="far fa-user"></i> ${usernameHTML}</span>
        <span class="view-count"><i class="far fa-eye"></i> ${viewsCount} مشاهدة</span>
        <span><i class="far fa-clock"></i> ${readTime} دقيقة قراءة</span>
      </div>
      <div class="article-content">
        ${article.content || 'محتوى غير متوفر'}
      </div>
      <div class="article-actions">
        ${likeButton}
        ${commentButton}
        ${isAuthor && !isUserBanned ? `
        <div class="action-btn delete" onclick="deleteArticle('${article.id}')">
          <i class="far fa-trash-alt"></i>
          <span>حذف</span>
        </div>
        ` : ''}
      </div>
    `;
    
    articlesDiv.appendChild(card);
    
    // تتبع المشاهدة
    if (currentUser && !isUserBanned) {
      setTimeout(() => {
        trackArticleView(article.id);
      }, 1000);
    }
  }
  
  /* =====================================================
     HANDLE BANNED ACTIONS
  ===================================================== */
  function handleBannedAction(defaultMessage) {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!currentUser) {
      showNotification(defaultMessage, 'error');
    }
  }
  
  /* =====================================================
     ENHANCED LIKES SYSTEM - التقييد لكل مقال فقط
  ===================================================== */
  window.toggleLike = async (event, articleId) => {
    event.preventDefault();
    event.stopPropagation();
    
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!currentUser) {
      showNotification('يجب تسجيل الدخول أولاً', 'error');
      return;
    }
    
    const likeBtn = event.currentTarget;
    
    // منع النقر المتكرر السريع
    if (likeBtn.classList.contains('processing')) {
      return;
    }
    
    likeBtn.classList.add('processing');
    
    const likeIcon = likeBtn.querySelector('i');
    const likeCountSpan = likeBtn.querySelector('span');
    const currentCount = parseInt(likeCountSpan.textContent) || 0;
    
    // التحقق من الإعجاب الحالي لهذا المقال فقط
    const likeRef = ref(db, `likes/${articleId}/${currentUser.uid}`);
    const likeSnap = await get(likeRef);
    const alreadyLiked = likeSnap.exists();
    
    let newCount;
    
    if (alreadyLiked) {
      // إلغاء الإعجاب
      newCount = Math.max(0, currentCount - 1);
      likeBtn.classList.remove('active');
      likeIcon.style.color = ''; // إعادة اللون الأبيض
      articleLikes.delete(articleId);
    } else {
      // إضافة إعجاب
      newCount = currentCount + 1;
      likeBtn.classList.add('active');
      likeIcon.style.color = '#ff4757'; // اللون الأحمر للإعجاب
      articleLikes.set(articleId, true);
    }
    
    likeCountSpan.textContent = newCount;
    
    try {
      if (alreadyLiked) {
        // إزالة الإعجاب
        await remove(likeRef);
        
        // تحديث عداد الإعجابات في المقال
        await update(ref(db, `articles/${articleId}`), {
          likesCount: increment(-1)
        });
        
        showNotification('تم إلغاء الإعجاب', 'success');
      } else {
        // إضافة إعجاب جديد
        await set(likeRef, {
          userId: currentUser.uid,
          timestamp: Date.now()
        });
        
        // تحديث عداد الإعجابات في المقال
        await update(ref(db, `articles/${articleId}`), {
          likesCount: increment(1)
        });
        
        showNotification('تم الإعجاب بالمقال', 'success');
      }
      
      // تحديث التخزين المؤقت للمقالات
      clearArticlesCache();
    } catch (error) {
      showNotification('حدث خطأ أثناء تحديث الإعجاب', 'error');
      // التراجع عن التغييرات في الواجهة
      if (alreadyLiked) {
        likeBtn.classList.add('active');
        likeIcon.style.color = '#ff4757';
        likeCountSpan.textContent = currentCount;
        articleLikes.set(articleId, true);
      } else {
        likeBtn.classList.remove('active');
        likeIcon.style.color = '';
        likeCountSpan.textContent = currentCount;
        articleLikes.delete(articleId);
      }
    } finally {
      setTimeout(() => {
        likeBtn.classList.remove('processing');
      }, 500);
    }
  };
  
  /* =====================================================
     COMMENTS SYSTEM - تحميل 10 تعليقات فقط في كل مرة
     مع التخزين المؤقت
  ===================================================== */
  window.openComments = async (articleId) => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!currentUser) {
      showNotification('يجب تسجيل الدخول أولاً', 'error');
      return;
    }
    
    currentArticleId = articleId;
    resetCommentsPagination();
    commentModal.style.display = 'flex';
    
    // إعداد عدادات الأحرف
    initCharacterCounters();
    
    // التحقق من فترة التبريد للتعليقات
    await checkCommentCooldown();
    
    // تحميل أول 10 تعليقات
    await loadComments(articleId);
  };
  
  function resetCommentsPagination() {
    lastCommentTimestamp = null;
    hasMoreComments = true;
    loadMoreCommentsContainer.style.display = 'none';
    const commentsList = document.getElementById('commentsList');
    commentsList.innerHTML = '';
  }
  
  window.closeCommentModal = () => {
    commentModal.style.display = 'none';
    document.getElementById('newComment').value = '';
    loadMoreCommentsContainer.style.display = 'none';
    
    commentCounter.textContent = '0/1500';
    commentCounter.className = 'char-counter muted';
    
    if (commentCooldownTimer) {
      clearInterval(commentCooldownTimer);
      commentCooldownTimer = null;
    }
  };
  
  async function loadComments(articleId, loadMore = false) {
    const commentsList = document.getElementById('commentsList');
    
    if (!loadMore) {
      commentsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    }
    
    try {
      // مفتاح التخزين المؤقت للتعليقات
      const cacheKey = `comments_${articleId}`;
      const timestampKey = `comments_timestamp_${articleId}`;
      
      let comments = [];
      
      // التحقق من التخزين المؤقت
      if (isCacheValid(timestampKey)) {
        const cachedComments = getFromCache(cacheKey);
        if (cachedComments && cachedComments.length > 0) {
          comments = cachedComments;
          if (!loadMore) {
            // عرض أول 10 تعليقات من التخزين المؤقت
            comments = comments.slice(0, commentsPerPage);
          }
        }
      }
      
      if (comments.length === 0) {
        // جلب التعليقات من Firebase
        comments = await fetchComments(articleId, loadMore);
        
        // حفظ في التخزين المؤقت
        if (!loadMore) {
          saveToCache(cacheKey, comments);
          updateCacheTimestamp(timestampKey);
        }
      }
      
      if (comments.length === 0 && !loadMore) {
        commentsList.innerHTML = `
          <div class="empty-state">
            <i class="far fa-comments"></i>
            <p>لا توجد تعليقات بعد</p>
            <p class="muted">كن أول من يعلق على هذا المقال</p>
          </div>
        `;
        hasMoreComments = false;
        loadMoreCommentsContainer.style.display = 'none';
        return;
      }
      
      if (!loadMore) {
        commentsList.innerHTML = '';
      }
      
      // جلب أسماء المستخدمين للتعليقات
      for (const comment of comments) {
        const username = await getUsername(comment.author);
        const isVerified = await isUserVerified(comment.author);
        const usernameHTML = getUsernameWithVerification(username, isVerified);
        
        const commentEl = document.createElement('div');
        commentEl.className = 'comment';
        
        commentEl.innerHTML = `
          <div class="comment-header">
            <div class="comment-author">${usernameHTML}</div>
            <div class="comment-time">${formatDate(comment.created)}</div>
          </div>
          <div class="comment-content">${comment.text}</div>
        `;
        
        commentsList.appendChild(commentEl);
      }
      
      // التحقق إذا كان هناك المزيد من التعليقات
      hasMoreComments = comments.length === commentsPerPage;
      loadMoreCommentsContainer.style.display = hasMoreComments ? 'block' : 'none';
      
    } catch (error) {
      console.error('Error loading comments:', error);
      showNotification('حدث خطأ في تحميل التعليقات', 'error');
    }
  }
  
  async function fetchComments(articleId, loadMore = false) {
    let commentsQuery;
    const commentsRef = ref(db, `comments/${articleId}`);
    
    if (loadMore && lastCommentTimestamp) {
      commentsQuery = query(
        commentsRef,
        orderByChild('created'),
        endAt(lastCommentTimestamp - 1),
        limitToLast(commentsPerPage)
      );
    } else {
      commentsQuery = query(
        commentsRef,
        orderByChild('created'),
        limitToLast(commentsPerPage)
      );
    }
    
    const snap = await get(commentsQuery);
    const comments = [];
    
    if (snap.exists()) {
      snap.forEach(commentSnap => {
        const comment = {
          id: commentSnap.key,
          ...commentSnap.val()
        };
        comments.push(comment);
        
        // تحديث الطابع الزمني للأخير
        if (!lastCommentTimestamp || comment.created < lastCommentTimestamp) {
          lastCommentTimestamp = comment.created;
        }
      });
    }
    
    return comments.sort((a, b) => b.created - a.created);
  }
  
  window.loadMoreComments = async () => {
    if (!hasMoreComments) return;
    
    loadMoreCommentsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
    loadMoreCommentsBtn.classList.add('loading');
    
    await loadComments(currentArticleId, true);
    
    loadMoreCommentsBtn.innerHTML = '<i class="fas fa-redo"></i> تحميل المزيد من التعليقات';
    loadMoreCommentsBtn.classList.remove('loading');
  };
  
  window.postComment = async () => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    const canComment = await checkCommentCooldown();
    if (!canComment) {
      showNotification('يجب الانتظار قبل إضافة التعليق التالي', 'error');
      return;
    }
    
    const commentText = document.getElementById('newComment').value.trim();
    
    if (!commentText) {
      showNotification('يرجى كتابة تعليق', 'error');
      return;
    }
    
    if (commentText.length > COMMENT_MAX_LENGTH) {
      showNotification(`التعليق طويل جدًا (${COMMENT_MAX_LENGTH} حرف كحد أقصى)`, 'error');
      return;
    }
    
    const commentRef = ref(db, `comments/${currentArticleId}`);
    const articleRef = ref(db, `articles/${currentArticleId}`);
    
    try {
      await push(commentRef, {
        text: commentText,
        author: currentUser.uid,
        created: Date.now()
      });
      
      const articleSnap = await get(articleRef);
      const articleData = articleSnap.val();
      const newCommentsCount = (articleData.commentsCount || 0) + 1;
      
      await update(articleRef, { commentsCount: newCommentsCount });
      
      document.getElementById('newComment').value = '';
      resetCommentsPagination();
      loadComments(currentArticleId);
      
      showNotification('تم إضافة التعليق', 'success');
      
      commentCounter.textContent = '0/1500';
      commentCounter.className = 'char-counter muted';
      
      await checkCommentCooldown();
      
      // مسح التخزين المؤقت للتعليقات لهذا المقال
      localStorage.removeItem(`comments_${currentArticleId}`);
      localStorage.removeItem(`comments_timestamp_${currentArticleId}`);
      
    } catch (error) {
      showNotification('حدث خطأ أثناء إضافة التعليق', 'error');
    }
  };
  
  /* =====================================================
     COOLDOWN FUNCTIONS
  ===================================================== */
  async function checkArticleCooldown() {
    if (!currentUser) return true;
    
    try {
      const userRef = ref(db, 'users/' + currentUser.uid);
      const snap = await get(userRef);
      
      if (snap.exists()) {
        const userData = snap.val();
        const lastArticleTime = userData.lastArticle || 0;
        const now = Date.now();
        const timeSinceLastArticle = now - lastArticleTime;
        
        if (timeSinceLastArticle < ARTICLE_COOLDOWN) {
          const remainingTime = ARTICLE_COOLDOWN - timeSinceLastArticle;
          articleCooldownEnd = now + remainingTime;
          
          const cooldownMessage = document.getElementById('cooldownMessage');
          const publishBtn = document.getElementById('publishBtn');
          
          if (cooldownMessage && publishBtn) {
            cooldownMessage.style.display = 'flex';
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<i class="fas fa-clock"></i> في فترة التبريد';
            publishBtn.style.opacity = '0.7';
            publishBtn.style.cursor = 'not-allowed';
            
            if (articleCooldownTimer) clearInterval(articleCooldownTimer);
            articleCooldownTimer = setInterval(() => updateArticleCooldownTimer(), 1000);
            updateArticleCooldownTimer();
          }
          
          return false;
        }
      }
    } catch (error) {
      console.log('Error checking article cooldown:', error);
    }
    
    return true;
  }
  
  function updateArticleCooldownTimer() {
    const now = Date.now();
    const remaining = Math.max(0, articleCooldownEnd - now);
    
    if (remaining <= 0) {
      clearInterval(articleCooldownTimer);
      
      const cooldownMessage = document.getElementById('cooldownMessage');
      const publishBtn = document.getElementById('publishBtn');
      
      if (cooldownMessage && publishBtn) {
        cooldownMessage.style.display = 'none';
        publishBtn.disabled = false;
        publishBtn.innerHTML = '<i class="fas fa-paper-plane"></i> نشر المقال';
        publishBtn.style.opacity = '1';
        publishBtn.style.cursor = 'pointer';
      }
      return;
    }
    
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    
    const timerElement = document.getElementById('articleCooldownTimer');
    if (timerElement) {
      timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
  }
  
  async function checkCommentCooldown() {
    if (!currentUser) return true;
    
    try {
      const userRef = ref(db, 'users/' + currentUser.uid);
      const snap = await get(userRef);
      
      if (snap.exists()) {
        const userData = snap.val();
        const lastCommentTime = userData.lastComment || 0;
        const now = Date.now();
        const timeSinceLastComment = now - lastCommentTime;
        
        if (timeSinceLastComment < COMMENT_COOLDOWN) {
          const remainingTime = COMMENT_COOLDOWN - timeSinceLastComment;
          commentCooldownEnd = now + remainingTime;
          
          const cooldownMessage = document.getElementById('commentCooldownMessage');
          const postCommentBtn = document.getElementById('postCommentBtn');
          
          if (cooldownMessage && postCommentBtn) {
            cooldownMessage.style.display = 'flex';
            postCommentBtn.disabled = true;
            postCommentBtn.innerHTML = '<i class="fas fa-clock"></i> في فترة التبريد';
            postCommentBtn.style.opacity = '0.7';
            postCommentBtn.style.cursor = 'not-allowed';
            
            if (commentCooldownTimer) clearInterval(commentCooldownTimer);
            commentCooldownTimer = setInterval(() => updateCommentCooldownTimer(), 1000);
            updateCommentCooldownTimer();
          }
          
          return false;
        }
      }
    } catch (error) {
      console.log('Error checking comment cooldown:', error);
    }
    
    return true;
  }
  
  function updateCommentCooldownTimer() {
    const now = Date.now();
    const remaining = Math.max(0, commentCooldownEnd - now);
    
    if (remaining <= 0) {
      clearInterval(commentCooldownTimer);
      
      const cooldownMessage = document.getElementById('commentCooldownMessage');
      const postCommentBtn = document.getElementById('postCommentBtn');
      
      if (cooldownMessage && postCommentBtn) {
        cooldownMessage.style.display = 'none';
        postCommentBtn.disabled = false;
        postCommentBtn.innerHTML = '<i class="fas fa-paper-plane"></i> إضافة تعليق';
        postCommentBtn.style.opacity = '1';
        postCommentBtn.style.cursor = 'pointer';
      }
      return;
    }
    
    const seconds = Math.ceil(remaining / 1000);
    
    const timerElement = document.getElementById('commentCooldownTimer');
    if (timerElement) {
      timerElement.textContent = seconds;
    }
  }
  
  /* =====================================================
     CHARACTER COUNTER FUNCTIONS
  ===================================================== */
  function initCharacterCounters() {
    const articleTitleInput = document.getElementById('articleTitle');
    if (articleTitleInput) {
      articleTitleInput.addEventListener('input', () => {
        const length = articleTitleInput.value.length;
        titleCounter.textContent = `${length}/${TITLE_MAX_LENGTH}`;
        updateCharCounterStyle(titleCounter, length, TITLE_MAX_LENGTH);
      });
    }
    
    const articleContentInput = document.getElementById('articleContent');
    if (articleContentInput) {
      articleContentInput.addEventListener('input', () => {
        const length = articleContentInput.value.length;
        contentCounter.textContent = `${length}/${CONTENT_MAX_LENGTH}`;
        updateCharCounterStyle(contentCounter, length, CONTENT_MAX_LENGTH);
      });
    }
    
    const newCommentInput = document.getElementById('newComment');
    if (newCommentInput) {
      newCommentInput.addEventListener('input', () => {
        const length = newCommentInput.value.length;
        commentCounter.textContent = `${length}/${COMMENT_MAX_LENGTH}`;
        updateCharCounterStyle(commentCounter, length, COMMENT_MAX_LENGTH);
      });
    }
  }
  
  function updateCharCounterStyle(counter, length, max) {
    counter.className = 'char-counter';
    if (length === 0) {
      counter.classList.add('muted');
    } else if (length > max * 0.9) {
      counter.classList.add('error');
    } else if (length > max * 0.75) {
      counter.classList.add('warning');
    } else {
      counter.classList.add('muted');
    }
  }
  
  /* =====================================================
     PROFILE FUNCTIONS
  ===================================================== */
  async function initProfile(uid) {
    const userRef = ref(db, 'users/' + uid);
    const snap = await get(userRef);
    
    if (!snap.exists()) {
      const username = generateRandomUsername();
      await set(userRef, {
        username: username,
        bio: 'مرحبًا! أنا مستخدم جديد في منتدى الريدبيل.',
        joinDate: Date.now(),
        lastLogin: Date.now(),
        articlesCount: 0,
        likesCount: 0,
        commentsCount: 0,
        lastArticle: 0,
        lastComment: 0,
        verified: false
      });
      
      // إضافة البيانات إلى ذاكرة التخزين المؤقت
      userDataCache.set(uid, {
        username: username,
        joinDate: Date.now(),
        lastLogin: Date.now(),
        verified: false
      });
    } else {
      await update(userRef, { lastLogin: Date.now() });
      const userData = snap.val();
      userDataCache.set(uid, userData);
    }
  }
  
  async function openProfile() {
    if (!currentUser) {
      profileView.innerHTML = `
        <div class="card highlight">
          <div class="empty-state">
            <i class="fas fa-user-lock"></i>
            <h3>يجب تسجيل الدخول</h3>
            <p>سجل الدخول لعرض وتعديل ملفك الشخصي</p>
            <button class="btn" onclick="showSection('articles')" style="margin-top: 16px; width: auto;">
              <i class="fas fa-arrow-right"></i> العودة للمقالات
            </button>
          </div>
        </div>
      `;
      return;
    }
    
    const snap = await get(ref(db, 'users/' + currentUser.uid));
    const userData = snap.val();
    const isVerified = userData.verified === true;
    
    // استخدام التخزين المؤقت لمقالات المستخدم
    let userArticlesCount = 0;
    if (isCacheValid(CACHE_KEYS.USER_ARTICLES_TIMESTAMP)) {
      const cachedUserArticles = getFromCache(CACHE_KEYS.USER_ARTICLES);
      if (cachedUserArticles) {
        userArticlesCount = cachedUserArticles.length;
      }
    }
    
    if (userArticlesCount === 0) {
      const articlesSnap = await get(ref(db, 'articles'));
      if (articlesSnap.exists()) {
        articlesSnap.forEach(article => {
          if (article.val().author === currentUser.uid) {
            userArticlesCount++;
          }
        });
      }
    }
    
    let userLikesCount = 0;
    if (userArticlesCount > 0) {
      // حساب الإعجابات من المقالات المحفوظة مؤقتاً
      if (isCacheValid(CACHE_KEYS.USER_ARTICLES_TIMESTAMP)) {
        const cachedUserArticles = getFromCache(CACHE_KEYS.USER_ARTICLES);
        cachedUserArticles.forEach(article => {
          userLikesCount += article.likesCount || 0;
        });
      } else {
        const articlesSnap = await get(ref(db, 'articles'));
        if (articlesSnap.exists()) {
          articlesSnap.forEach(article => {
            if (article.val().author === currentUser.uid) {
              userLikesCount += article.val().likesCount || 0;
            }
          });
        }
      }
    }
    
    let userCommentsCount = 0;
    const commentsSnap = await get(ref(db, 'comments'));
    if (commentsSnap.exists()) {
      commentsSnap.forEach(commentSection => {
        commentSection.forEach(comment => {
          if (comment.val().author === currentUser.uid) {
            userCommentsCount++;
          }
        });
      });
    }
    
    const usernameHTML = getUsernameWithVerification(userData.username || 'مستخدم', isVerified);
    
    profileView.innerHTML = `
      <div class="card highlight">
        <div class="profile-header">
          <div class="avatar">${currentUser.email[0].toUpperCase()}</div>
          <div>
            <h3 style="display: flex; align-items: center; gap: 10px;">${usernameHTML}</h3>
            <div class="muted">${currentUser.email}</div>
            <div class="muted">منذ ${formatDate(userData.joinDate)}</div>
          </div>
        </div>
        
        <div class="profile-stats">
          <div class="stat">
            <div class="stat-value">${userArticlesCount}</div>
            <div class="stat-label">مقالات</div>
          </div>
          <div class="stat">
            <div class="stat-value">${userLikesCount}</div>
            <div class="stat-label">إعجابات</div>
          </div>
          <div class="stat">
            <div class="stat-value">${userCommentsCount}</div>
            <div class="stat-label">تعليقات</div>
          </div>
        </div>
        
        <div style="background: #222222; padding: 16px; border-radius: var(--radius-sm); margin: 20px 0; border: 1px solid var(--border);">
          <h4 style="font-size: 14px;"><i class="fas fa-info-circle"></i> معلومات الحساب</h4>
          <div class="muted" style="margin-top: 10px; font-size: 12px;">
            <p><i class="fas fa-envelope"></i> <strong>البريد:</strong> ${currentUser.email}</p>
            <p style="margin-top: 6px;"><i class="fas fa-calendar"></i> <strong>تاريخ الانضمام:</strong> ${new Date(userData.joinDate).toLocaleDateString('ar-SA')}</p>
            <p style="margin-top: 6px;"><i class="fas fa-clock"></i> <strong>آخر نشاط:</strong> ${formatDate(userData.lastLogin || userData.joinDate)}</p>
            ${isVerified ? `
            <p style="margin-top: 6px; color: var(--verified-color);">
              <i class="fas fa-badge-check"></i> <strong>الحساب موثق</strong>
            </p>
            ` : ''}
          </div>
        </div>
        
        <label style="font-size: 13px;">اسم المستخدم</label>
        <input id="p-name" value="${userData.username || ''}" placeholder="اسم المستخدم">
        
        <label style="margin-top: 12px; font-size: 13px;">نبذة عنك</label>
        <textarea id="p-bio" rows="2" placeholder="اكتب نبذة عن نفسك..." style="font-size: 13px;">${userData.bio || ''}</textarea>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" onclick="saveProfile()">
            <i class="fas fa-save"></i> حفظ التعديلات
          </button>
          <button class="btn ghost" onclick="showSection('articles')">
            <i class="fas fa-arrow-right"></i> العودة
          </button>
        </div>
      </div>
    `;
  }
  
  window.saveProfile = async () => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    const username = document.getElementById('p-name').value.trim();
    const bio = document.getElementById('p-bio').value.trim();
    
    if (!username) {
      showNotification('يرجى إدخال اسم مستخدم', 'error');
      return;
    }
    
    if (username.length < 3) {
      showNotification('اسم المستخدم يجب أن يكون 3 أحرف على الأقل', 'error');
      return;
    }
    
    try {
      // تحديث اسم المستخدم في قاعدة البيانات
      await update(ref(db, 'users/' + currentUser.uid), {
        username: username,
        bio: bio,
        updated: Date.now()
      });
      
      // تحديث ذاكرة التخزين المؤقت
      userDataCache.set(currentUser.uid, {
        ...userDataCache.get(currentUser.uid),
        username: username,
        bio: bio
      });
      
      // تحديث جميع المقالات التي كتبها المستخدم
      const articlesRef = ref(db, 'articles');
      const articlesSnap = await get(articlesRef);
      
      if (articlesSnap.exists()) {
        const updatePromises = [];
        articlesSnap.forEach(articleSnap => {
          const article = articleSnap.val();
          if (article.author === currentUser.uid) {
            const articleRef = ref(db, `articles/${articleSnap.key}`);
            updatePromises.push(update(articleRef, {
              updatedUsername: username
            }));
          }
        });
        
        // الانتظار حتى تكتمل جميع التحديثات
        await Promise.all(updatePromises);
      }
      
      showNotification('تم تحديث الملف الشخصي وجميع مقالاتك', 'success');
      
      // تحديث العرض الحالي
      setTimeout(() => {
        openProfile();
        if (articlesSection.style.display === 'block') {
          resetArticlesPagination();
          loadArticles();
        }
      }, 500);
      
    } catch (error) {
      showNotification('حدث خطأ أثناء تحديث الملف الشخصي', 'error');
    }
  };
  
  /* =====================================================
     VIEWS TRACKING SYSTEM
  ===================================================== */
  async function trackArticleView(articleId) {
    if (!currentUser) return;
    
    try {
      const viewRef = ref(db, `views/${articleId}/${currentUser.uid}`);
      const viewSnap = await get(viewRef);
      
      if (!viewSnap.exists()) {
        await set(viewRef, {
          timestamp: Date.now(),
          count: 1
        });
        
        await update(ref(db, `articles/${articleId}`), {
          viewsCount: increment(1)
        });
        
        // تحديث التخزين المؤقت
        clearArticlesCache();
      }
    } catch (error) {
      console.log('Error tracking view:', error);
    }
  }
  
  /* =====================================================
     MY ARTICLES VIEW
  ===================================================== */
  async function openMyArticles() {
    if (!currentUser) {
      myArticlesView.innerHTML = `
        <div class="card highlight">
          <div class="empty-state">
            <i class="fas fa-user-lock"></i>
            <h3>يجب تسجيل الدخول</h3>
            <p>سجل الدخول لعرض مقالاتك</p>
            <button class="btn" onclick="showSection('articles')" style="margin-top: 16px; width: auto;">
              <i class="fas fa-arrow-right"></i> العودة للمقالات
            </button>
          </div>
        </div>
      `;
      return;
    }
    
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    myArticlesView.innerHTML = `
      <div class="card highlight">
        <h3><i class="fas fa-newspaper"></i> مقالاتي</h3>
        <p class="muted" style="margin-top: 8px; font-size: 13px;">إدارة مقالاتك المنشورة على المنتدى</p>
        <div id="myArticlesList" style="margin-top: 16px;"></div>
      </div>
    `;
    
    const myArticlesList = document.getElementById('myArticlesList');
    myArticlesList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    // استخدام التخزين المؤقت أولاً
    let userArticles = [];
    if (isCacheValid(CACHE_KEYS.USER_ARTICLES_TIMESTAMP)) {
      const cachedUserArticles = getFromCache(CACHE_KEYS.USER_ARTICLES);
      if (cachedUserArticles && cachedUserArticles.length > 0) {
        userArticles = cachedUserArticles;
        showNotification('جاري عرض مقالاتك من التخزين المؤقت', 'success');
      }
    }
    
    if (userArticles.length === 0) {
      // جلب مقالات المستخدم من Firebase
      userArticles = await fetchUserArticles();
      
      // حفظ في التخزين المؤقت
      saveToCache(CACHE_KEYS.USER_ARTICLES, userArticles);
      updateCacheTimestamp(CACHE_KEYS.USER_ARTICLES_TIMESTAMP);
    }
    
    if (userArticles.length === 0) {
      myArticlesList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-newspaper"></i>
          <p>لم تنشر أي مقالات بعد</p>
          <button class="btn" onclick="openPublishModal()" style="margin-top: 12px; width: auto;">
            <i class="fas fa-pen-fancy"></i> نشر أول مقال
          </button>
        </div>
      `;
      return;
    }
    
    userArticles.sort((a, b) => b.created - a.created);
    
    for (const article of userArticles) {
      const articleEl = document.createElement('div');
      articleEl.className = 'card';
      articleEl.style.marginBottom = '12px';
      articleEl.style.padding = '16px';
      
      articleEl.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
          <div style="flex: 1; min-width: 200px;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <strong style="font-size: 14px;">${article.title}</strong>
            </div>
            <div class="muted" style="margin-top: 4px; font-size: 11px;">
              ${formatDate(article.created)} • ${article.category || 'غير مصنف'} • ${article.readTime || '1'} دقيقة قراءة
            </div>
            <div style="display: flex; gap: 12px; margin-top: 8px; font-size: 12px;">
              <span><i class="far fa-heart"></i> ${article.likesCount || 0} إعجاب</span>
              <span><i class="far fa-comment"></i> ${article.commentsCount || 0} تعليق</span>
              <span><i class="far fa-eye"></i> ${article.viewsCount || 0} مشاهدة</span>
            </div>
          </div>
          <div style="display: flex; gap: 6px;">
            <button class="btn small danger" onclick="deleteArticle('${article.id}')">
              <i class="far fa-trash-alt"></i> حذف
            </button>
          </div>
        </div>
      `;
      
      myArticlesList.appendChild(articleEl);
    }
  }
  
  async function fetchUserArticles() {
    if (!currentUser) return [];
    
    try {
      // جلب كل المقالات ثم تصفيتها على العميل
      const articlesRef = ref(db, 'articles');
      const articlesQuery = query(
        articlesRef,
        orderByChild('created'),
        limitToLast(100) // جلب آخر 100 مقال كحد أقصى
      );
      
      const snap = await get(articlesQuery);
      const userArticles = [];
      
      if (snap.exists()) {
        snap.forEach(articleSnap => {
          const article = articleSnap.val();
          if (article.author === currentUser.uid) {
            userArticles.push({
              id: articleSnap.key,
              ...article
            });
          }
        });
      }
      
      return userArticles;
    } catch (error) {
      console.error('Error fetching user articles:', error);
      return [];
    }
  }
  
  /* =====================================================
     PUBLISH ARTICLE
  ===================================================== */
  window.openPublishModal = () => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!currentUser) {
      showNotification('يجب تسجيل الدخول أولاً', 'error');
      return;
    }
    
    publishModal.style.display = 'flex';
    document.getElementById('articleTitle').focus();
    closeSidebarOnMobile();
    
    initCharacterCounters();
    
    setTimeout(async () => {
      await checkArticleCooldown();
    }, 100);
  };
  
  window.closePublishModal = () => {
    publishModal.style.display = 'none';
    document.getElementById('articleTitle').value = '';
    document.getElementById('articleContent').value = '';
    document.getElementById('articleCategory').value = 'ريدبيل';
    document.getElementById('articleReadTime').value = '3';
    
    titleCounter.textContent = '0/70';
    contentCounter.textContent = '0/2000';
    titleCounter.className = 'char-counter muted';
    contentCounter.className = 'char-counter muted';
    
    if (articleCooldownTimer) {
      clearInterval(articleCooldownTimer);
      articleCooldownTimer = null;
    }
  };
  
  window.publishArticle = async () => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    const canPublish = await checkArticleCooldown();
    if (!canPublish) {
      showNotification('يجب الانتظار قبل نشر المقال التالي', 'error');
      return;
    }
    
    const title = document.getElementById('articleTitle').value.trim();
    const content = document.getElementById('articleContent').value.trim();
    const category = document.getElementById('articleCategory').value;
    const readTime = document.getElementById('articleReadTime').value;
    
    if (!title || !content) {
      showNotification('يرجى ملء جميع الحقول', 'error');
      return;
    }
    
    if (title.length < 5) {
      showNotification('عنوان المقال قصير جدًا (5 أحرف على الأقل)', 'error');
      return;
    }
    
    if (title.length > TITLE_MAX_LENGTH) {
      showNotification(`عنوان المقال طويل جدًا (${TITLE_MAX_LENGTH} حرف كحد أقصى)`, 'error');
      return;
    }
    
    if (content.length < 50) {
      showNotification('محتوى المقال قصير جدًا (50 حرف على الأقل)', 'error');
      return;
    }
    
    if (content.length > CONTENT_MAX_LENGTH) {
      showNotification(`محتوى المقال طويل جدًا (${CONTENT_MAX_LENGTH} حرف كحد أقصى)`, 'error');
      return;
    }
    
    const articleData = {
      title: title,
      content: content,
      category: category,
      author: currentUser.uid,
      created: Date.now(),
      likesCount: 0,
      commentsCount: 0,
      viewsCount: 0,
      readTime: readTime
    };
    
    push(ref(db, 'articles'), articleData).then((result) => {
      update(ref(db, 'users/' + currentUser.uid), { 
        lastArticle: Date.now(),
        articlesCount: increment(1)
      });
      
      showNotification('تم نشر المقال بنجاح', 'success');
      closePublishModal();
      
      // مسح التخزين المؤقت
      clearArticlesCache();
      
      showSection('articles');
    }).catch(error => {
      showNotification(error.message, 'error');
    });
  };
  
  /* =====================================================
     DELETE ARTICLE
  ===================================================== */
  window.deleteArticle = async (articleId) => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!confirm('هل أنت متأكد من حذف هذا المقال؟ سيتم حذف جميع الإعجابات والتعليقات المرتبطة به.')) return;
    
    const articleRef = ref(db, `articles/${articleId}`);
    
    try {
      await remove(articleRef);
      
      const likesRef = ref(db, `likes/${articleId}`);
      await remove(likesRef);
      
      const commentsRef = ref(db, `comments/${articleId}`);
      await remove(commentsRef);
      
      const viewsRef = ref(db, `views/${articleId}`);
      await remove(viewsRef);
      
      if (currentUser) {
        const userRef = ref(db, 'users/' + currentUser.uid);
        update(userRef, { articlesCount: increment(-1) });
      }
      
      showNotification('تم حذف المقال', 'success');
      
      // مسح التخزين المؤقت
      clearArticlesCache();
      
      setTimeout(() => {
        if (articlesSection.style.display === 'block') {
          resetArticlesPagination();
          loadArticles();
        } else if (myArticlesSection.style.display === 'block') {
          openMyArticles();
        }
      }, 300);
      
    } catch (error) {
      showNotification('حدث خطأ أثناء حذف المقال', 'error');
    }
  };
  
  /* =====================================================
     CACHE MANAGEMENT
  ===================================================== */
  function clearArticlesCache() {
    localStorage.removeItem(CACHE_KEYS.ARTICLES);
    localStorage.removeItem(CACHE_KEYS.ARTICLES_TIMESTAMP);
    localStorage.removeItem(CACHE_KEYS.USER_ARTICLES);
    localStorage.removeItem(CACHE_KEYS.USER_ARTICLES_TIMESTAMP);
  }
  
  /* =====================================================
     INITIALIZATION
  ===================================================== */
  window.addEventListener('click', (e) => {
    if (e.target === publishModal) {
      closePublishModal();
    }
    
    if (e.target === commentModal) {
      closeCommentModal();
    }
  });
  
  notification.addEventListener('click', () => {
    notification.style.display = 'none';
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (sidebar.classList.contains('active')) {
        toggleSidebar();
      }
      if (publishModal.style.display === 'flex') {
        closePublishModal();
      }
      if (commentModal.style.display === 'flex') {
        closeCommentModal();
      }
      if (bannedOverlay.style.display === 'flex') {
        hideBanOverlay();
      }
    }
    
    if (e.ctrlKey && e.key === 'Enter' && commentModal.style.display === 'flex') {
      const postCommentBtn = document.getElementById('postCommentBtn');
      if (postCommentBtn && !postCommentBtn.disabled) {
        postComment();
      }
    }
  });
  
  window.showSection('articles');
  
  window.addEventListener('load', () => {
    setTimeout(() => {
      document.body.style.opacity = '1';
    }, 100);
  });
  </script>

<script>
document.addEventListener('contextmenu', function(e) {
  if (!e.target.closest('.article-content, .comment-content')) {
    e.preventDefault();
  }
});
</script>

</body>
</html>