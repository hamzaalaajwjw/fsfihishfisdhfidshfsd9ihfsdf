<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Red Pill Platform</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
  /* =====================================================
     GLOBAL / RESET
  ===================================================== */
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:'Cairo',sans-serif;
    background:#0b0b0d;
    color:#eaeaea;
    overflow-x:hidden;
  }
  h1,h2,h3,h4{margin:0}
  button{cursor:pointer;font-family:inherit}

  /* =====================================================
     THEME VARIABLES (PERFORMANCE FRIENDLY)
  ===================================================== */
  :root{
    --bg:#0b0b0d;
    --panel:#141417;
    --card:#1b1b20;
    --border:#26262c;
    --accent:#e53935;
    --text-muted:#9a9aa0;
    --radius:14px;
    --transition:0.18s ease;
  }

  /* =====================================================
     LAYOUT
  ===================================================== */
  header{
    height:60px;
    background:linear-gradient(90deg,#111,#151515);
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    padding:0 20px;
    font-size:20px;
    font-weight:800;
    letter-spacing:.5px;
  }

  .app{
    display:flex;
    min-height:calc(100vh - 60px);
  }

  aside{
    width:280px;
    background:var(--panel);
    border-left:1px solid var(--border);
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  main{
    flex:1;
    padding:22px;
    max-width:900px;
    margin:auto;
  }

  /* =====================================================
     UI COMPONENTS
  ===================================================== */
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    margin-bottom:18px;
    transition:transform var(--transition);
  }
  .card:hover{transform:translateY(-2px)}

  .btn{
    width:100%;
    padding:11px;
    border-radius:10px;
    border:none;
    background:var(--accent);
    color:#fff;
    font-weight:700;
  }
  .btn.ghost{background:#232329}
  .btn.small{padding:6px 10px;font-size:13px;width:auto}

  input,textarea{
    width:100%;
    background:#0f0f13;
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px;
    color:#fff;
    margin-top:6px;
  }

  .muted{color:var(--text-muted);font-size:13px}

  /* =====================================================
     ARTICLE
  ===================================================== */
  .article-title{font-size:19px;font-weight:800}
  .article-meta{font-size:13px;color:var(--text-muted);margin:6px 0}
  .article-actions{display:flex;gap:18px;margin-top:12px;font-size:14px}
  .like{color:#ff5a5a;cursor:pointer}
  .liked{font-weight:800}

  /* =====================================================
     PROFILE
  ===================================================== */
  .profile-header{
    display:flex;
    gap:14px;
    align-items:center;
  }
  .avatar{
    width:60px;height:60px;
    border-radius:50%;
    background:#2a2a32;
    display:flex;align-items:center;justify-content:center;
    font-size:22px;font-weight:800;
  }

  /* =====================================================
     MOBILE
  ===================================================== */
  @media(max-width:900px){
    .app{flex-direction:column}
    aside{width:100%}
    main{padding:14px}
  }
  </style>
</head>
<body>

<header>Red Pill Platform</header>

<div class="app">

  <!-- ================= SIDEBAR ================= -->
  <aside>
    <div id="authBox" class="card"></div>

    <div class="card">
      <button class="btn" onclick="openPublish()">âœï¸ Ù†Ø´Ø± Ù…Ù‚Ø§Ù„</button>
    </div>

    <div class="card">
      <button class="btn ghost" onclick="openProfile()">ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>
    </div>
  </aside>

  <!-- ================= MAIN ================= -->
  <main>
    <h2>ğŸ”¥ Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ø«Ø§Ø±Ø©</h2>
    <div id="articles"></div>

    <div id="profileView" style="display:none"></div>
  </main>

</div>

<script type="module">
/* =====================================================
   FIREBASE IMPORTS
===================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, push, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* =====================================================
   CONFIG
===================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyCdoubvkI7VEvYxtG3CzKFAJg74XXl7fX4",
  authDomain: "redpill-1c7e2.firebaseapp.com",
  databaseURL: "https://redpill-1c7e2-default-rtdb.firebaseio.com",
  projectId: "redpill-1c7e2",
  storageBucket: "redpill-1c7e2.firebasestorage.app",
  messagingSenderId: "337690521778",
  appId: "1:337690521778:web:ba3c99ad55e6b0d58f59ab"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const authBox = document.getElementById('authBox');
const articlesDiv = document.getElementById('articles');
const profileView = document.getElementById('profileView');

/* =====================================================
   AUTH UI
===================================================== */
onAuthStateChanged(auth,user=>{
  if(user){
    authBox.innerHTML = `
      <div class="profile-header">
        <div class="avatar">${user.email[0].toUpperCase()}</div>
        <div>
          <strong>${user.email}</strong>
          <div class="muted">Ø¹Ø¶Ùˆ Ù…Ø³Ø¬Ù„</div>
        </div>
      </div>
      <button class="btn ghost" id="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    `;
    document.getElementById('logout').onclick=()=>signOut(auth);

    initProfile(user.uid);
  }else{
    authBox.innerHTML = `
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
      <input id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
      <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button class="btn" id="login">Ø¯Ø®ÙˆÙ„</button>
      <button class="btn ghost" id="register">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    `;
    document.getElementById('login').onclick=()=>login();
    document.getElementById('register').onclick=()=>register();
  }
});

function login(){
  signInWithEmailAndPassword(auth,email.value,pass.value).catch(e=>alert(e.message));
}
function register(){
  createUserWithEmailAndPassword(auth,email.value,pass.value).catch(e=>alert(e.message));
}

/* =====================================================
   PROFILE SYSTEM
===================================================== */
function initProfile(uid){
  const userRef = ref(db,'users/'+uid);
  get(userRef).then(s=>{
    if(!s.exists()){
      set(userRef,{
        username:'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯',
        bio:'',
        created:Date.now()
      });
    }
  });
}

window.openProfile = async ()=>{
  if(!auth.currentUser){alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');return;}

  articlesDiv.style.display='none';
  profileView.style.display='block';

  const snap = await get(ref(db,'users/'+auth.currentUser.uid));
  const u = snap.val();

  profileView.innerHTML = `
    <div class="card">
      <h3>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input id="p-name" value="${u.username}">
      <label>Ù†Ø¨Ø°Ø©</label>
      <textarea id="p-bio">${u.bio}</textarea>
      <button class="btn small" onclick="saveProfile()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
  `;
}

window.saveProfile = ()=>{
  update(ref(db,'users/'+auth.currentUser.uid),{
    username:document.getElementById('p-name').value,
    bio:document.getElementById('p-bio').value
  });
  alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

/* =====================================================
   PUBLISH / ARTICLES / LIKES / COMMENTS
===================================================== */
window.openPublish = ()=>{
  if(!auth.currentUser){alert('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');return;}
  const title = prompt('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„');
  const content = prompt('Ù†Øµ Ø§Ù„Ù…Ù‚Ø§Ù„');
  if(!title||!content) return;
  push(ref(db,'articles'),{
    title,content,
    author:auth.currentUser.uid,
    created:Date.now(),
    likesCount:0
  });
}

onValue(ref(db,'articles'),snap=>{
  articlesDiv.innerHTML='';
  articlesDiv.style.display='block';
  profileView.style.display='none';

  let arr=[];
  snap.forEach(s=>arr.push({id:s.key,...s.val()}));
  arr.sort((a,b)=>(b.likesCount||0)-(a.likesCount||0));
  arr.forEach(a=>renderArticle(a));
});

async function renderArticle(a){
  const card=document.createElement('div');
  card.className='card';

  let liked=false;
  if(auth.currentUser){
    const l=await get(ref(db,`likes/${a.id}/${auth.currentUser.uid}`));
    liked=l.exists();
  }

  card.innerHTML=`
    <div class="article-title">${a.title}</div>
    <div class="article-meta">${new Date(a.created).toLocaleDateString()}</div>
    <p>${a.content}</p>
    <div class="article-actions">
      <span class="like ${liked?'liked':''}" data-id="${a.id}">â¤ï¸ ${a.likesCount||0}</span>
    </div>
  `;

  card.querySelector('.like').onclick=()=>toggleLike(a,liked);
  articlesDiv.appendChild(card);
}

async function toggleLike(article,liked){
  if(!auth.currentUser||liked) return;
  await update(ref(db,'articles/'+article.id),{
    likesCount:(article.likesCount||0)+1
  });
  await set(ref(db,`likes/${article.id}/${auth.currentUser.uid}`),true);
}
</script>
</body>
</html>
