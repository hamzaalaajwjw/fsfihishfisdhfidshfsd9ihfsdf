<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø±ÙŠØ¯Ø¨ÙŠÙ„</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
  /* =====================================================
     GLOBAL / RESET
  ===================================================== */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Cairo', sans-serif;
    background: #000000;
    color: #ffffff;
    overflow-x: hidden;
    line-height: 1.6;
    min-height: 100vh;
  }
  
  h1, h2, h3, h4, h5, h6 {
    margin: 0;
    font-weight: 700;
    line-height: 1.3;
  }
  
  button {
    cursor: pointer;
    font-family: inherit;
    border: none;
    outline: none;
    background: none;
  }
  
  a {
    text-decoration: none;
    color: inherit;
  }
  
  /* =====================================================
     THEME VARIABLES
  ===================================================== */
  :root {
    --bg: #000000;
    --panel: #0a0a0a;
    --card: #111111;
    --card-hover: #1a1a1a;
    --border: rgba(255, 255, 255, 0.1);
    --accent: #ffffff;
    --text: #ffffff;
    --text-muted: #aaaaaa;
    --text-light: #f5f5f5;
    --red: #ff4757;
    --blue: #1e90ff;
    --verified-color: #1e90ff;
    --radius: 12px;
    --radius-sm: 8px;
  }
  
  /* =====================================================
     LAYOUT
  ===================================================== */
  header {
    height: 70px;
    background: rgba(10, 10, 10, 0.95);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.5px;
  }
  
  .logo i {
    font-size: 20px;
    color: var(--text);
  }
  
  .menu-toggle {
    display: none;
    color: var(--text);
    font-size: 20px;
    width: 40px;
    height: 40px;
    border-radius: var(--radius-sm);
    transition: all 0.2s;
  }
  
  .app {
    display: flex;
    min-height: calc(100vh - 70px);
  }
  
  /* =====================================================
     SIDEBAR
  ===================================================== */
  .sidebar {
    width: 280px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
    overflow-y: auto;
    max-height: calc(100vh - 70px);
    z-index: 90;
  }
  
  .sidebar-overlay {
    display: none;
    position: fixed;
    top: 70px;
    right: 0;
    width: 100%;
    height: calc(100vh - 70px);
    background: rgba(0, 0, 0, 0.8);
    z-index: 80;
  }
  
  main {
    flex: 1;
    padding: 20px;
    max-width: 100%;
    width: 100%;
    overflow-x: hidden;
  }
  
  /* =====================================================
     UI COMPONENTS
  ===================================================== */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }
  
  .card.highlight {
    background: var(--card-hover);
    border: 1px solid var(--border);
  }
  
  .auth-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 16px;
  }
  
  .auth-card .profile-header {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .auth-card .profile-header .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #222222;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 700;
    color: white;
    flex-shrink: 0;
  }
  
  .auth-card .profile-header .user-info {
    flex: 1;
    min-width: 0;
  }
  
  .auth-card .profile-header .user-info strong {
    display: block;
    font-size: 16px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text);
  }
  
  .auth-card .profile-header .user-info .muted {
    font-size: 12px;
    color: var(--text-muted);
  }
  
  .auth-card .auth-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 16px;
  }
  
  .auth-card .auth-form input {
    width: 100%;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
  }
  
  .auth-card .auth-form input:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  .auth-card .auth-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 16px;
  }
  
  .btn {
    width: 100%;
    padding: 14px;
    border-radius: var(--radius-sm);
    border: none;
    background: #222222;
    color: var(--text);
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn:hover {
    background: #333333;
  }
  
  .btn.ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-light);
  }
  
  .btn.ghost:hover {
    border-color: var(--accent);
    background: rgba(255, 255, 255, 0.05);
  }
  
  .btn.small {
    padding: 10px 16px;
    font-size: 13px;
    width: auto;
  }
  
  .btn.danger {
    background: #222222;
    color: var(--red);
  }
  
  .menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: transparent;
    color: var(--text-light);
    border-radius: var(--radius-sm);
    transition: all 0.2s;
    border: none;
    width: 100%;
    text-align: right;
    font-size: 14px;
    font-weight: 600;
  }
  
  .menu-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--accent);
  }
  
  .menu-item.active {
    background: rgba(255, 255, 255, 0.1);
    color: var(--accent);
    border-left: 2px solid var(--accent);
  }
  
  .menu-item i {
    width: 20px;
    font-size: 16px;
    color: inherit;
  }
  
  input, textarea, select {
    width: 100%;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    color: var(--text);
    margin-top: 8px;
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
  }
  
  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--accent);
  }
  
  .muted {
    color: var(--text-muted);
    font-size: 13px;
  }
  
  .tag {
    display: inline-block;
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-light);
    border-radius: 12px;
    font-size: 11px;
    margin-left: 6px;
    margin-top: 6px;
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  /* =====================================================
     VERIFICATION BADGE - UPDATED FOR ALL USERS
  ===================================================== */
  .verified-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--verified-color);
    margin-right: 5px;
    position: relative;
  }
  
  .verified-badge i {
    font-size: 10px;
    color: white;
  }
  
  .user-with-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  
  .verified-user {
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  
  .verified-user .username {
    color: var(--text);
  }
  
  /* =====================================================
     ACTION BUTTONS - Ø¨Ø¯ÙˆÙ† Ø¯ÙˆØ§Ø¦Ø±
  ===================================================== */
  .article-actions {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    justify-content: flex-start;
    flex-wrap: wrap;
  }
  
  .action-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
    color: var(--text-light);
    font-weight: 500;
    font-size: 14px;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    background: transparent;
    border: none;
  }
  
  .action-btn:hover {
    background: rgba(255, 255, 255, 0.05);
  }
  
  .action-btn.like {
    color: var(--text-light);
  }
  
  .action-btn.like:hover {
    color: var(--red);
  }
  
  .action-btn.like.active {
    color: var(--red);
  }
  
  .action-btn.comment {
    color: var(--text-light);
  }
  
  .action-btn.comment:hover {
    color: #4fc3f7;
  }
  
  .action-btn.delete {
    color: var(--red);
  }
  
  .action-btn i {
    font-size: 16px;
  }
  
  .action-btn span {
    font-weight: 500;
    font-size: 13px;
  }
  
  .action-btn.processing {
    opacity: 0.7;
    cursor: not-allowed;
  }
  
  /* =====================================================
     CHARACTER COUNTERS
  ===================================================== */
  .char-counter {
    font-size: 11px;
    margin-top: 4px;
    text-align: right;
    font-weight: 500;
    color: var(--text-muted);
  }
  
  .char-counter.warning {
    color: #ffa502;
  }
  
  .char-counter.error {
    color: var(--red);
  }
  
  /* =====================================================
     COOLDOWN TIMER
  ===================================================== */
  .cooldown-timer {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 12px;
    background: #222222;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }
  
  .cooldown-timer .timer {
    color: var(--red);
    font-weight: 600;
    font-size: 14px;
  }
  
  /* =====================================================
     LOAD MORE BUTTONS
  ===================================================== */
  .load-more-container {
    text-align: center;
    margin: 30px 0;
  }
  
  .load-more-btn {
    padding: 14px 28px;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-light);
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .load-more-btn:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.05);
    border-color: var(--accent);
  }
  
  .load-more-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .load-more-btn.loading {
    opacity: 0.7;
    cursor: not-allowed;
  }
  
  /* =====================================================
     CONTENT SECTIONS
  ===================================================== */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
  }
  
  .section-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    position: relative;
    padding-bottom: 6px;
  }
  
  .article-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 10px;
    line-height: 1.4;
    color: var(--text);
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
  }
  
  .article-content {
    font-size: 14px;
    line-height: 1.7;
    margin: 16px 0;
    color: var(--text-light);
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
  }
  
  .article-meta {
    font-size: 12px;
    color: var(--text-muted);
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .article-meta i {
    margin-left: 4px;
  }
  
  .profile-header {
    display: flex;
    gap: 16px;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .avatar {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: #222222;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
    color: white;
    border: 2px solid var(--border);
  }
  
  .profile-stats {
    display: flex;
    gap: 20px;
    margin: 20px 0;
    padding: 20px;
    background: #222222;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }
  
  .stat {
    text-align: center;
    flex: 1;
  }
  
  .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
    font-weight: 500;
  }
  
  /* =====================================================
     FILTERS & SORTING
  ===================================================== */
  .filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-btn {
    padding: 10px 16px;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text-light);
    font-size: 13px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
  }
  
  .filter-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: black;
  }
  
  .filter-btn:hover:not(.active) {
    border-color: var(--accent);
    color: var(--accent);
  }
  
  /* =====================================================
     MODALS
  ===================================================== */
  .modal-overlay {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }
  
  .modal {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 24px;
    width: 90%;
    max-width: 600px;
    border: 1px solid var(--border);
    position: relative;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .modal-header h3 {
    font-size: 20px;
    color: var(--text);
  }
  
  .modal-close {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-muted);
    font-size: 18px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--border);
    transition: all 0.2s;
  }
  
  .modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border-color: var(--accent);
  }
  
  /* =====================================================
     COMMENTS
  ===================================================== */
  .comments-section {
    margin-top: 30px;
    border-top: 1px solid var(--border);
    padding-top: 20px;
  }
  
  .comment {
    background: #222222;
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-top: 12px;
    border-left: 2px solid var(--accent);
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    border: 1px solid var(--border);
  }
  
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .comment-author {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .comment-time {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 500;
  }
  
  .comment-content {
    font-size: 13px;
    line-height: 1.6;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    color: var(--text-light);
  }
  
  /* =====================================================
     LOADING & EMPTY STATES
  ===================================================== */
  .loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-muted);
  }
  
  .empty-state i {
    font-size: 40px;
    margin-bottom: 16px;
    opacity: 0.5;
    color: var(--text);
  }
  
  .empty-state h3 {
    font-size: 18px;
    margin-bottom: 12px;
    color: var(--text);
  }
  
  /* =====================================================
     NOTIFICATION
  ===================================================== */
  .notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--panel);
    border-radius: var(--radius);
    padding: 16px 20px;
    border-left: 3px solid var(--accent);
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 1001;
    max-width: 400px;
    border: 1px solid var(--border);
  }
  
  .notification.success {
    border-left-color: #00d2a0;
  }
  
  .notification.error {
    border-left-color: var(--red);
  }
  
  .notification i {
    font-size: 18px;
  }
  
  .notification.success i {
    color: #00d2a0;
  }
  
  .notification.error i {
    color: var(--red);
  }
  
  /* =====================================================
     VIEW COUNT
  ===================================================== */
  .view-count {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    font-weight: 500;
    font-size: 12px;
  }
  
  .view-count i {
    margin-left: 4px;
    color: var(--text-muted);
  }
  
  /* =====================================================
     BANNED USER STYLES
  ===================================================== */
  .banned-overlay {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  
  .banned-message {
    background: var(--card);
    border: 2px solid var(--red);
    border-radius: var(--radius);
    padding: 40px;
    max-width: 500px;
    text-align: center;
  }
  
  .banned-icon {
    font-size: 60px;
    color: var(--red);
    margin-bottom: 20px;
  }
  
  .banned-title {
    font-size: 24px;
    color: var(--red);
    margin-bottom: 15px;
  }
  
  .banned-reason {
    font-size: 16px;
    color: var(--text);
    margin-bottom: 20px;
    background: rgba(255, 71, 87, 0.1);
    padding: 15px;
    border-radius: var(--radius-sm);
  }
  
  .banned-details {
    font-size: 14px;
    color: var(--text-muted);
    margin-top: 20px;
  }
  
  /* =====================================================
     RESPONSIVE DESIGN
  ===================================================== */
  @media (max-width: 992px) {
    .menu-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sidebar {
      position: fixed;
      top: 70px;
      left: -280px;
      height: calc(100vh - 70px);
      z-index: 100;
      width: 280px;
      transition: left 0.3s;
    }
    
    .sidebar.active {
      left: 0;
    }
    
    .sidebar-overlay.active {
      display: block;
    }
    
    main {
      padding: 16px;
      width: 100%;
    }
    
    .section-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .profile-stats {
      gap: 16px;
      flex-wrap: wrap;
      padding: 16px;
    }
    
    .modal {
      width: 95%;
      padding: 20px;
    }
    
    .auth-card .profile-header {
      flex-direction: row;
      text-align: right;
    }
    
    .article-actions {
      gap: 10px;
      justify-content: center;
    }
    
    .action-btn {
      padding: 8px 12px;
      font-size: 13px;
    }
    
    .action-btn span {
      font-size: 13px;
    }
    
    .load-more-btn {
      padding: 12px 24px;
      font-size: 13px;
    }
  }
  
  @media (max-width: 768px) {
    header {
      padding: 0 16px;
      height: 60px;
    }
    
    .logo {
      font-size: 16px;
    }
    
    .logo i {
      font-size: 16px;
    }
    
    .sidebar {
      width: 250px;
      left: -250px;
    }
    
    .section-title {
      font-size: 18px;
    }
    
    .article-title {
      font-size: 16px;
    }
    
    .article-content {
      font-size: 13px;
    }
    
    .card {
      padding: 16px;
    }
    
    .modal {
      padding: 16px;
    }
    
    .profile-stats {
      gap: 12px;
      padding: 14px;
    }
    
    .stat-value {
      font-size: 20px;
    }
    
    .stat-label {
      font-size: 11px;
    }
    
    .btn.small {
      padding: 8px 14px;
      font-size: 12px;
    }
    
    .filter-btn {
      padding: 8px 12px;
      font-size: 12px;
    }
    
    .notification {
      right: 16px;
      left: 16px;
      max-width: none;
      bottom: 16px;
    }
    
    .menu-item {
      padding: 12px 14px;
      font-size: 13px;
    }
    
    .auth-card {
      padding: 16px;
    }
    
    .auth-card .auth-buttons {
      gap: 8px;
    }
    
    .btn {
      padding: 12px;
      font-size: 13px;
    }
    
    .auth-card .profile-header {
      gap: 12px;
    }
    
    .auth-card .profile-header .avatar {
      width: 45px;
      height: 45px;
      font-size: 16px;
    }
    
    .auth-card .profile-header .user-info strong {
      font-size: 14px;
    }
    
    .article-meta {
      font-size: 11px;
      gap: 10px;
    }
    
    .action-btn {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    .action-btn i {
      font-size: 14px;
    }
    
    .action-btn span {
      font-size: 12px;
    }
    
    .banned-message {
      padding: 20px;
    }
    
    .banned-icon {
      font-size: 40px;
    }
    
    .banned-title {
      font-size: 20px;
    }
  }
  
  @media (max-width: 576px) {
    header {
      padding: 0 12px;
    }
    
    .logo {
      font-size: 14px;
      gap: 6px;
    }
    
    .logo i {
      font-size: 14px;
    }
    
    .section-title {
      font-size: 16px;
    }
    
    .card {
      padding: 14px;
    }
    
    .modal {
      padding: 14px;
    }
    
    .profile-stats {
      gap: 10px;
      padding: 12px;
    }
    
    .stat-value {
      font-size: 18px;
    }
    
    .stat-label {
      font-size: 10px;
    }
    
    .article-title {
      font-size: 15px;
    }
    
    .article-content {
      font-size: 12px;
    }
    
    .btn.small {
      padding: 7px 12px;
      font-size: 11px;
    }
    
    .filter-btn {
      padding: 7px 12px;
      font-size: 11px;
    }
    
    .action-btn {
      padding: 5px 8px;
      font-size: 11px;
    }
    
    .action-btn i {
      font-size: 12px;
    }
    
    .action-btn span {
      font-size: 11px;
    }
    
    .article-actions {
      gap: 8px;
    }
    
    .menu-item {
      padding: 10px 12px;
      font-size: 12px;
    }
    
    .auth-card .profile-header .avatar {
      width: 40px;
      height: 40px;
      font-size: 14px;
    }
    
    .auth-card .profile-header .user-info strong {
      font-size: 13px;
    }
    
    .filters {
      gap: 6px;
      justify-content: center;
    }
    
    .load-more-btn {
      padding: 10px 20px;
      font-size: 12px;
    }
  }
  
  @media (max-width: 400px) {
    .logo {
      font-size: 13px;
    }
    
    .logo i {
      font-size: 13px;
    }
    
    .section-title {
      font-size: 15px;
    }
    
    .article-title {
      font-size: 14px;
    }
    
    .article-actions {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }
    
    .action-btn {
      width: 100%;
      justify-content: flex-start;
    }
    
    .filters {
      justify-content: space-between;
    }
    
    .filter-btn {
      flex: 1;
      justify-content: center;
    }
  }
  
  /* ===============================
     REMOVE DEFAULT BLUE TAP / FOCUS
     (SAFE - DOES NOT AFFECT CUSTOM EFFECTS)
  ================================ */
  * {
    -webkit-tap-highlight-color: transparent;
  }

  :focus-visible {
    outline: none;
  }

  button:focus,
  a:focus,
  .action-btn:focus,
  .menu-item:focus {
    outline: none;
    box-shadow: none;
  }


  /* ===============================
     COPY CONTROL
  ================================ */
  * {
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }

  .article-content,
  .comment-content {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
  }
  </style>

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<link rel="icon" type="image/png" href="https://d.top4top.io/p_3691o8llf0.png">


<!-- Open Graph -->
<meta property="og:title" content="Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø±ÙŠØ¯Ø¨ÙŠÙ„ ÙÙŠ Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø·">
<meta property="og:type" content="website">
<meta property="og:image" content="https://k.top4top.io/p_36911ji070.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

</head>
<body>
  <!-- ================= BANNED USER OVERLAY ================= -->
  <div class="banned-overlay" id="bannedOverlay">
    <div class="banned-message">
      <div class="banned-icon">
        <i class="fas fa-ban"></i>
      </div>
      <h2 class="banned-title">Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±</h2>
      <div class="banned-reason" id="banReasonText"></div>
      <div class="banned-details">
        <p><i class="fas fa-info-circle"></i> Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ø´Ø± Ø£Ùˆ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø£Ùˆ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨</p>
        <p><i class="fas fa-clock"></i> Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©ØŒ Ø§ØªØµÙ„ Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¯Ù‰</p>
      </div>
    </div>
  </div>
  
  <header>
    <div class="logo">
      <i class="fas fa-pills"></i>
      <span>Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø±ÙŠØ¯Ø¨ÙŠÙ„</span>
    </div>
    
    <button class="menu-toggle" id="menuToggle">
      <i class="fas fa-bars"></i>
    </button>
  </header>
  
  <div class="app">
    <!-- ================= SIDEBAR ================= -->
    <div class="sidebar" id="sidebar">
      <div id="authBox" class="auth-card"></div>
      
      <div class="card">
        <h4><i class="fas fa-sliders-h"></i> Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h4>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 16px;">
          <button class="menu-item active" onclick="showSection('articles')">
            <i class="fas fa-newspaper"></i>
            <span>Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª</span>
          </button>
          
          <button class="menu-item" onclick="showSection('profile')">
            <i class="fas fa-user-circle"></i>
            <span>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
          </button>
          
          <button class="menu-item" onclick="showSection('myArticles')">
            <i class="fas fa-file-alt"></i>
            <span>Ù…Ù‚Ø§Ù„Ø§ØªÙŠ</span>
          </button>
          
          <button class="menu-item" onclick="openPublishModal()">
            <i class="fas fa-pen-fancy"></i>
            <span>Ù†Ø´Ø± Ù…Ù‚Ø§Ù„ Ø¬Ø¯ÙŠØ¯</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <!-- ================= MAIN CONTENT ================= -->
    <main>
      <!-- Ù…Ù‚Ø§Ù„Ø§Øª Section (Default) -->
      <div id="articlesSection" class="content-section">
        <div class="section-header">
          <h2 class="section-title"><i class="fas fa-fire"></i> Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</h2>
          <div class="filters">
            <button class="filter-btn active" onclick="filterArticles('all')">
              <i class="fas fa-layer-group"></i> Ø§Ù„ÙƒÙ„
            </button>
            <button class="filter-btn" onclick="filterArticles('popular')">
              <i class="fas fa-fire"></i> Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ©
            </button>
            <button class="filter-btn" onclick="filterArticles('recent')">
              <i class="fas fa-clock"></i> Ø§Ù„Ø£Ø­Ø¯Ø«
            </button>
          </div>
        </div>
        
        <div id="articles" class="articles-container">
          <div class="loading" id="loadingArticles">
            <div class="spinner"></div>
          </div>
        </div>
        
        <div id="loadMoreArticlesContainer" class="load-more-container" style="display: none;">
          <button class="load-more-btn" id="loadMoreArticlesBtn" onclick="loadMoreArticles()">
            <i class="fas fa-redo"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
          </button>
        </div>
      </div>
      
      <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Section -->
      <div id="profileSection" class="content-section" style="display: none;">
        <div class="section-header">
          <h2 class="section-title"><i class="fas fa-user-circle"></i> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h2>
          <button class="btn small ghost" onclick="showSection('articles')">
            <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù‚Ø§Ù„Ø§Øª
          </button>
        </div>
        
        <div id="profileView"></div>
      </div>
      
      <!-- Ù…Ù‚Ø§Ù„Ø§ØªÙŠ Section -->
      <div id="myArticlesSection" class="content-section" style="display: none;">
        <div class="section-header">
          <h2 class="section-title"><i class="fas fa-file-alt"></i> Ù…Ù‚Ø§Ù„Ø§ØªÙŠ</h2>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn small" onclick="openPublishModal()">
              <i class="fas fa-plus"></i> Ù…Ù‚Ø§Ù„ Ø¬Ø¯ÙŠØ¯
            </button>
            <button class="btn small ghost" onclick="showSection('articles')">
              <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
            </button>
          </div>
        </div>
        
        <div id="myArticlesView"></div>
      </div>
    </main>
  </div>
  
  <!-- ================= PUBLISH MODAL ================= -->
  <div class="modal-overlay" id="publishModal">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="fas fa-pen-fancy"></i> ÙƒØªØ§Ø¨Ø© Ù…Ù‚Ø§Ù„ Ø¬Ø¯ÙŠØ¯</h3>
        <button class="modal-close" onclick="closePublishModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-content">
        <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„ (70 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)</label>
        <input id="articleTitle" placeholder="Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ø¬Ø°Ø§Ø¨Ù‹Ø§ Ù„Ù…Ù‚Ø§Ù„Ùƒ" maxlength="70">
        <div class="char-counter" id="titleCounter">0/70</div>
        
        <label style="margin-top: 16px;">Ù†Øµ Ø§Ù„Ù…Ù‚Ø§Ù„ (2000 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)</label>
        <textarea id="articleContent" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ù…Ù‚Ø§Ù„Ùƒ Ù‡Ù†Ø§..." rows="6" maxlength="2000"></textarea>
        <div class="char-counter" id="contentCounter">0/2000</div>
        
        <div id="cooldownMessage" class="cooldown-timer" style="display: none;">
          <i class="fas fa-clock"></i>
          <span>ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø®Ù„Ø§Ù„:</span>
          <span class="timer" id="articleCooldownTimer">60:00</span>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;">
          <div>
            <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label>
            <select id="articleCategory">
              <option value="Ø±ÙŠØ¯Ø¨ÙŠÙ„">Ø±ÙŠØ¯Ø¨ÙŠÙ„</option>
              <option value="Ø¨Ù„Ø§Ùƒ Ø¨ÙŠÙ„">Ø¨Ù„Ø§Ùƒ Ø¨ÙŠÙ„</option>
              <option value="ØºÙŠØ± Ù…ØµÙ†Ù">ØºÙŠØ± Ù…ØµÙ†Ù</option>
            </select>
          </div>
          
          <div>
            <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©</label>
            <select id="articleReadTime">
              <option value="1">Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©</option>
              <option value="3">Ù£ Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="5">Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="10">Ù¡Ù  Ø¯Ù‚Ø§Ø¦Ù‚</option>
              <option value="15">Ù¡Ù¥ Ø¯Ù‚ÙŠÙ‚Ø©</option>
            </select>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn" style="flex: 1;" onclick="publishArticle()" id="publishBtn">
            <i class="fas fa-paper-plane"></i> Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„
          </button>
          <button class="btn ghost" onclick="closePublishModal()" style="width: auto;">
            Ø¥Ù„ØºØ§Ø¡
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= COMMENT MODAL ================= -->
  <div class="modal-overlay" id="commentModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3><i class="fas fa-comments"></i> Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h3>
        <button class="modal-close" onclick="closeCommentModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-content">
        <div id="commentsList" style="max-height: 300px; overflow-y: auto; padding-left: 5px;"></div>
        
        <div id="loadMoreCommentsContainer" class="load-more-container" style="display: none;">
          <button class="load-more-btn" id="loadMoreCommentsBtn" onclick="loadMoreComments()">
            <i class="fas fa-redo"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
          </button>
        </div>
        
        <div style="margin-top: 20px;">
          <textarea id="newComment" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§ (1500 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)..." rows="3" maxlength="1500"></textarea>
          <div class="char-counter" id="commentCounter">0/1500</div>
          
          <div id="commentCooldownMessage" class="cooldown-timer" style="display: none;">
            <i class="fas fa-clock"></i>
            <span>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ Ø®Ù„Ø§Ù„:</span>
            <span class="timer" id="commentCooldownTimer">60</span>
            <span>Ø«Ø§Ù†ÙŠØ©</span>
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
            <div class="muted" style="font-size: 11px;">
              Ø§Ø¶ØºØ· Ctrl+Enter Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
            </div>
            <button class="btn small" onclick="postComment()" id="postCommentBtn">
              <i class="fas fa-paper-plane"></i> Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= NOTIFICATION ================= -->
  <div class="notification" id="notification">
    <i class="fas fa-check-circle" id="notificationIcon"></i>
    <span id="notificationText"></span>
  </div>

  <script type="module">
  /* =====================================================
     FIREBASE IMPORTS
  ===================================================== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getDatabase, ref, push, get, update, set, remove, increment, query, orderByChild, limitToLast, limitToFirst, startAt, endAt } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  
  /* =====================================================
     CONFIG
  ===================================================== */
  const firebaseConfig = {
    apiKey: "AIzaSyCdoubvkI7VEvYxtG3CzKFAJg74XXl7fX4",
    authDomain: "redpill-1c7e2.firebaseapp.com",
    databaseURL: "https://redpill-1c7e2-default-rtdb.firebaseio.com",
    projectId: "redpill-1c7e2",
    storageBucket: "redpill-1c7e2.firebasestorage.app",
    messagingSenderId: "337690521778",
    appId: "1:337690521778:web:ba3c99ad55e6b0d58f59ab"
  };
  
  /* =====================================================
     PERFORMANCE MODULES - ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù‚ÙˆÙŠ
  ===================================================== */
  
  // ğŸ”¥ 1. LAZY FIREBASE INITIALIZATION
  let firebaseApp = null;
  let firebaseAuth = null;
  let firebaseDB = null;
  let isFirebaseInitialized = false;
  
  function getFirebase() {
    if (!isFirebaseInitialized) {
      firebaseApp = initializeApp(firebaseConfig);
      firebaseAuth = getAuth(firebaseApp);
      firebaseDB = getDatabase(firebaseApp);
      isFirebaseInitialized = true;
    }
    return { auth: firebaseAuth, db: firebaseDB };
  }
  
  // ğŸ”¥ 2. ADVANCED MEMORY CACHE
  const advancedCache = {
    articles: new Map(),
    users: new Map(),
    likes: new Map(),
    comments: new Map(),
    
    set(key, value, ttl = 30000) { // 30 Ø«Ø§Ù†ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
      this.articles.set(key, {
        data: value,
        expiry: Date.now() + ttl,
        hits: 0
      });
    },
    
    get(key) {
      const item = this.articles.get(key);
      if (!item) return null;
      
      if (Date.now() > item.expiry) {
        this.articles.delete(key);
        return null;
      }
      
      item.hits++;
      return item.data;
    },
    
    getWithStats(key) {
      const item = this.articles.get(key);
      if (!item) return { data: null, hits: 0 };
      
      if (Date.now() > item.expiry) {
        this.articles.delete(key);
        return { data: null, hits: item.hits };
      }
      
      item.hits++;
      return { data: item.data, hits: item.hits };
    },
    
    clear() {
      this.articles.clear();
      this.users.clear();
      this.likes.clear();
      this.comments.clear();
    },
    
    cleanup() {
      const now = Date.now();
      let deleted = 0;
      
      for (const [key, item] of this.articles.entries()) {
        if (now > item.expiry) {
          this.articles.delete(key);
          deleted++;
        }
      }
      
      // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ù…Ø¹Ù‚ÙˆÙ„ (500 Ø¹Ù†ØµØ± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)
      if (this.articles.size > 500) {
        const entries = Array.from(this.articles.entries());
        entries.sort((a, b) => a[1].expiry - b[1].expiry);
        
        const toDelete = entries.slice(0, 100); // Ø§Ø­Ø°Ù Ø£Ù‚Ø¯Ù… 100
        toDelete.forEach(([key]) => this.articles.delete(key));
      }
      
      return deleted;
    }
  };
  
  // ğŸ”¥ 3. SMART DEBOUNCING SYSTEM
  const requestQueue = new Map();
  const DEBOUNCE_TIME = 250;
  
  function smartDebounce(key, callback, immediate = false) {
    if (requestQueue.has(key)) {
      clearTimeout(requestQueue.get(key).timer);
    }
    
    if (immediate) {
      const result = callback();
      requestQueue.delete(key);
      return result;
    }
    
    const timer = setTimeout(() => {
      callback();
      requestQueue.delete(key);
    }, DEBOUNCE_TIME);
    
    requestQueue.set(key, { timer, timestamp: Date.now() });
  }
  
  // ğŸ”¥ 4. RATE LIMITER
  const rateLimiter = {
    requests: new Map(),
    
    check(userId, action, limit = 60, windowMs = 60000) {
      if (!userId) return true;
      
      const key = `${userId}_${action}`;
      const now = Date.now();
      
      if (!this.requests.has(key)) {
        this.requests.set(key, []);
      }
      
      const userRequests = this.requests.get(key);
      
      // Ø§Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      const recentRequests = userRequests.filter(time => 
        now - time < windowMs
      );
      
      if (recentRequests.length >= limit) {
        return false;
      }
      
      recentRequests.push(now);
      this.requests.set(key, recentRequests);
      
      // ØªÙ†Ø¸ÙŠÙ Ø¯ÙˆØ±ÙŠ (1% ÙØ±ØµØ©)
      if (Math.random() < 0.01) {
        this.cleanup();
      }
      
      return true;
    },
    
    cleanup() {
      const now = Date.now();
      for (const [key, requests] of this.requests.entries()) {
        const recent = requests.filter(time => now - time < 120000); // 2 Ø¯Ù‚ÙŠÙ‚Ø©
        if (recent.length === 0) {
          this.requests.delete(key);
        } else {
          this.requests.set(key, recent);
        }
      }
    },
    
    getStats(userId, action) {
      const key = `${userId}_${action}`;
      const requests = this.requests.get(key) || [];
      const now = Date.now();
      const recent = requests.filter(time => now - time < 60000);
      return {
        count: recent.length,
        remaining: Math.max(0, 60 - recent.length)
      };
    }
  };
  
  // ğŸ”¥ 5. PERFORMANCE TRACKER
  const performanceTracker = {
    metrics: {
      requests: 0,
      cacheHits: 0,
      errors: 0,
      responseTimes: [],
      firebaseCalls: 0
    },
    
    startRequest() {
      this.metrics.requests++;
      return { startTime: Date.now() };
    },
    
    endRequest(startData, cacheHit = false) {
      const duration = Date.now() - startData.startTime;
      this.metrics.responseTimes.push(duration);
      
      if (cacheHit) this.metrics.cacheHits++;
      
      // ØªÙ‚Ø±ÙŠØ± ÙƒÙ„ 100 Ø·Ù„Ø¨
      if (this.metrics.requests % 100 === 0) {
        this.reportMetrics();
      }
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ responseTimes
      if (this.metrics.responseTimes.length > 1000) {
        this.metrics.responseTimes = this.metrics.responseTimes.slice(-500);
      }
      
      return duration;
    },
    
    reportMetrics() {
      const avgResponse = this.metrics.responseTimes.length > 0
        ? this.metrics.responseTimes.reduce((a, b) => a + b, 0) / this.metrics.responseTimes.length
        : 0;
      
      const cacheHitRate = this.metrics.requests > 0
        ? ((this.metrics.cacheHits / this.metrics.requests) * 100).toFixed(1)
        : 0;
      
      console.log(`[Performance] Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${this.metrics.requests}, ` +
                  `Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´: ${cacheHitRate}%, ` +
                  `Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${avgResponse.toFixed(0)}ms, ` +
                  `Ù…ÙƒØ§Ù„Ù…Ø§Øª ÙØ§ÙŠØ±Ø¨Ø§Ø³: ${this.metrics.firebaseCalls}`);
      
      // Ø­ÙØ¸ Ù„Ù„Ø¥Ø·Ù„Ø§Ø¹ Ø¹Ù„ÙŠÙ‡Ø§
      try {
        localStorage.setItem('forum_perf_metrics', JSON.stringify({
          ...this.metrics,
          avgResponse: avgResponse.toFixed(0),
          cacheHitRate,
          lastUpdate: Date.now()
        }));
      } catch (e) {}
    },
    
    trackFirebaseCall() {
      this.metrics.firebaseCalls++;
    }
  };
  
  // ğŸ”¥ 6. RESILIENT FIREBASE OPERATIONS
  async function resilientFirebaseOperation(operation, maxRetries = 3) {
    let lastError;
    
    for (let i = 0; i < maxRetries; i++) {
      try {
        performanceTracker.trackFirebaseCall();
        return await operation();
      } catch (error) {
        lastError = error;
        
        // Exponential backoff
        const delay = Math.min(1000 * Math.pow(2, i), 10000);
        await new Promise(resolve => setTimeout(resolve, delay));
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„
        if (error.code === 'unavailable' || error.code === 'disconnected') {
          isFirebaseInitialized = false;
          getFirebase();
        }
      }
    }
    
    throw lastError;
  }
  
  // ğŸ”¥ 7. SMART FETCH WITH CACHING
  async function smartFetch(path, options = {}) {
    const cacheKey = `fetch_${path}_${JSON.stringify(options)}`;
    const cached = advancedCache.getWithStats(cacheKey);
    
    if (cached.data) {
      performanceTracker.metrics.cacheHits++;
      return cached.data;
    }
    
    const startData = performanceTracker.startRequest();
    
    try {
      const { db } = getFirebase();
      let dbRef = ref(db, path);
      
      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
      if (options.orderBy) {
        dbRef = query(dbRef, orderByChild(options.orderBy));
      }
      
      if (options.limit) {
        dbRef = query(dbRef, limitToLast(options.limit));
      }
      
      if (options.startAt) {
        dbRef = query(dbRef, startAt(options.startAt));
      }
      
      if (options.endAt) {
        dbRef = query(dbRef, endAt(options.endAt));
      }
      
      const snapshot = await resilientFirebaseOperation(() => get(dbRef));
      
      let result = [];
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          result.push({ id: child.key, ...child.val() });
        });
      }
      
      // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´
      advancedCache.set(cacheKey, result, options.cacheTTL || 15000);
      
      performanceTracker.endRequest(startData, false);
      return result;
      
    } catch (error) {
      performanceTracker.metrics.errors++;
      performanceTracker.endRequest(startData, false);
      
      // Fallback Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
      const fallback = localStorage.getItem(`fallback_${path}`);
      if (fallback) {
        try {
          return JSON.parse(fallback);
        } catch (e) {
          // ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ parsing
        }
      }
      
      throw error;
    }
  }
  
  // ğŸ”¥ 8. MEMORY MANAGER
  class MemoryManager {
    constructor() {
      this.cleanupInterval = setInterval(() => this.cleanup(), 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
      this.lastCleanup = Date.now();
    }
    
    cleanup() {
      const now = Date.now();
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ cache
      const deletedFromCache = advancedCache.cleanup();
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ request queue Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      for (const [key, data] of requestQueue.entries()) {
        if (now - data.timestamp > 60000) { // Ø£Ù‚Ø¯Ù… Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©
          clearTimeout(data.timer);
          requestQueue.delete(key);
        }
      }
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ rate limiter
      rateLimiter.cleanup();
      
      this.lastCleanup = now;
      
      if (deletedFromCache > 0) {
        console.log(`[MemoryManager] ØªÙ… ØªÙ†Ø¸ÙŠÙ ${deletedFromCache} Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„ÙƒØ§Ø´`);
      }
    }
    
    destroy() {
      clearInterval(this.cleanupInterval);
      advancedCache.clear();
      requestQueue.clear();
      rateLimiter.requests.clear();
    }
  }
  
  // ØªÙ‡ÙŠØ¦Ø© Memory Manager
  const memoryManager = new MemoryManager();
  
  /* =====================================================
     APPLICATION CODE (Ù…Ø¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª)
  ===================================================== */
  
  // DOM Elements
  const authBox = document.getElementById('authBox');
  const articlesDiv = document.getElementById('articles');
  const profileView = document.getElementById('profileView');
  const myArticlesView = document.getElementById('myArticlesView');
  const publishModal = document.getElementById('publishModal');
  const commentModal = document.getElementById('commentModal');
  const notification = document.getElementById('notification');
  const menuToggle = document.getElementById('menuToggle');
  const sidebar = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const loadMoreArticlesContainer = document.getElementById('loadMoreArticlesContainer');
  const loadMoreArticlesBtn = document.getElementById('loadMoreArticlesBtn');
  const loadMoreCommentsContainer = document.getElementById('loadMoreCommentsContainer');
  const loadMoreCommentsBtn = document.getElementById('loadMoreCommentsBtn');
  const bannedOverlay = document.getElementById('bannedOverlay');
  const banReasonText = document.getElementById('banReasonText');
  
  // Character counters
  const titleCounter = document.getElementById('titleCounter');
  const contentCounter = document.getElementById('contentCounter');
  const commentCounter = document.getElementById('commentCounter');
  
  // Section elements
  const articlesSection = document.getElementById('articlesSection');
  const profileSection = document.getElementById('profileSection');
  const myArticlesSection = document.getElementById('myArticlesSection');
  
  // Global variables
  let currentUser = null;
  let currentArticleId = null;
  let currentFilter = 'all';
  let allArticles = [];
  let articlesLoading = false;
  let isUserBanned = false;
  let banData = null;
  
  // Pagination variables for articles
  let lastArticleTimestamp = null;
  let hasMoreArticles = true;
  const articlesPerPage = 10;
  
  // Pagination variables for comments
  let lastCommentTimestamp = null;
  let hasMoreComments = true;
  const commentsPerPage = 10;
  
  // Rate limiting constants
  const ARTICLE_COOLDOWN = 60 * 60 * 1000;
  const COMMENT_COOLDOWN = 60 * 1000;
  const LIKE_COOLDOWN = 2000;
  
  // Character limits
  const TITLE_MAX_LENGTH = 70;
  const CONTENT_MAX_LENGTH = 2000;
  const COMMENT_MAX_LENGTH = 1500;
  
  // Cooldown timers
  let articleCooldownTimer = null;
  let commentCooldownTimer = null;
  let articleCooldownEnd = 0;
  let commentCooldownEnd = 0;
  
  // Store article likes locally
  const articleLikes = new Map();
  
  // Store user data cache
  const userDataCache = new Map();
  
  /* =====================================================
     UTILITY FUNCTIONS
  ===================================================== */
  
  // ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ
  function generateRandomUsername() {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let randomPart = '';
    for (let i = 0; i < 4; i++) {
      randomPart += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return `Ø±ÙŠØ¯Ø¨ÙŠÙ„ÙŠ${randomPart}`;
  }
  
  function formatDate(timestamp) {
    if (!timestamp || timestamp === 0) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    
    const date = new Date(timestamp);
    if (isNaN(date.getTime())) return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­';
    
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60 * 1000) {
      return 'Ø§Ù„Ø¢Ù†';
    }
    
    if (diff < 60 * 60 * 1000) {
      const minutes = Math.floor(diff / (60 * 1000));
      return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
    }
    
    if (diff < 24 * 60 * 60 * 1000) {
      const hours = Math.floor(diff / (60 * 60 * 1000));
      return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
    }
    
    if (diff < 7 * 24 * 60 * 60 * 1000) {
      const days = Math.floor(diff / (24 * 60 * 60 * 1000));
      return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
    }
    
    return date.toLocaleDateString('ar-SA', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  function showNotification(message, type = 'success') {
    const icon = document.getElementById('notificationIcon');
    const text = document.getElementById('notificationText');
    
    if (type === 'success') {
      icon.className = 'fas fa-check-circle';
      notification.classList.add('success');
      notification.classList.remove('error');
    } else {
      icon.className = 'fas fa-exclamation-circle';
      notification.classList.add('error');
      notification.classList.remove('success');
    }
    
    text.textContent = message;
    notification.style.display = 'flex';
    
    setTimeout(() => {
      notification.style.display = 'none';
    }, 3000);
  }
  
  /* =====================================================
     BAN CHECK SYSTEM
  ===================================================== */
  async function checkIfUserIsBanned(uid) {
    if (!uid) return false;
    
    try {
      const banRef = ref(getFirebase().db, `admin/bans/${uid}`);
      const snap = await resilientFirebaseOperation(() => get(banRef));
      
      if (snap.exists()) {
        const banInfo = snap.val();
        
        const now = Date.now();
        if (banInfo.bannedUntil !== 'permanent' && banInfo.bannedUntil < now) {
          await resilientFirebaseOperation(() => remove(banRef));
          return false;
        }
        
        banData = banInfo;
        return true;
      }
      return false;
    } catch (error) {
      console.log('Error checking ban status:', error);
      return false;
    }
  }
  
  function showBanOverlay() {
    if (banData) {
      let reasonText = 'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ';
      if (banData.reason === 'spam') {
        reasonText = 'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø³Ø¨Ø¨: Ù†Ø´Ø± Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù…Ø±ØºÙˆØ¨';
      } else if (banData.reason === 'abuse') {
        reasonText = 'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø³Ø¨Ø¨: Ø¥Ø³Ø§Ø¡Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù…';
      } else if (banData.reason === 'violation') {
        reasonText = 'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø³Ø¨Ø¨: Ø§Ù†ØªÙ‡Ø§Ùƒ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…';
      } else if (banData.reason === 'other' && banData.notes) {
        reasonText = `ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø³Ø¨Ø¨: ${banData.notes}`;
      }
      
      banReasonText.textContent = reasonText;
      bannedOverlay.style.display = 'flex';
    }
  }
  
  function hideBanOverlay() {
    bannedOverlay.style.display = 'none';
  }
  
  /* =====================================================
     SIDEBAR FUNCTIONS
  ===================================================== */
  function toggleSidebar() {
    sidebar.classList.toggle('active');
    sidebarOverlay.classList.toggle('active');
  }
  
  menuToggle.addEventListener('click', toggleSidebar);
  sidebarOverlay.addEventListener('click', toggleSidebar);
  
  function closeSidebarOnMobile() {
    if (window.innerWidth <= 992) {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    }
  }
  
  window.addEventListener('resize', () => {
    if (window.innerWidth > 992) {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    }
  });
  
  /* =====================================================
     SECTION NAVIGATION
  ===================================================== */
  window.showSection = (sectionName) => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    articlesSection.style.display = 'none';
    profileSection.style.display = 'none';
    myArticlesSection.style.display = 'none';
    
    document.querySelectorAll('.menu-item').forEach(item => {
      item.classList.remove('active');
    });
    
    switch(sectionName) {
      case 'articles':
        articlesSection.style.display = 'block';
        document.querySelector('.menu-item:nth-child(1)').classList.add('active');
        resetArticlesPagination();
        loadArticles();
        break;
      case 'profile':
        profileSection.style.display = 'block';
        document.querySelector('.menu-item:nth-child(2)').classList.add('active');
        openProfile();
        break;
      case 'myArticles':
        myArticlesSection.style.display = 'block';
        document.querySelector('.menu-item:nth-child(3)').classList.add('active');
        openMyArticles();
        break;
    }
    
    closeSidebarOnMobile();
  };
  
  /* =====================================================
     AUTHENTICATION (Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª)
  ===================================================== */
  onAuthStateChanged(getFirebase().auth, async (user) => {
    currentUser = user;
    
    if (user) {
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø± Ù…Ø¹ rate limiting
      if (!rateLimiter.check(user.uid, 'auth_check', 10, 60000)) {
        showNotification('Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
        return;
      }
      
      isUserBanned = await checkIfUserIsBanned(user.uid);
      
      if (isUserBanned) {
        showBanOverlay();
        authBox.innerHTML = `
          <div class="profile-header">
            <div class="avatar">${user.email[0].toUpperCase()}</div>
            <div class="user-info">
              <strong>${user.email.split('@')[0]}</strong>
              <div class="muted" style="color: var(--red);">
                <i class="fas fa-ban"></i> Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ±
              </div>
            </div>
          </div>
          <div class="auth-buttons">
            <button class="btn ghost" id="logout">
              <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
            </button>
          </div>
        `;
        
        document.getElementById('logout').onclick = () => {
          signOut(getFirebase().auth).then(() => {
            hideBanOverlay();
            showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
          });
        };
        
        showSection('articles');
        return;
      }
      
      authBox.innerHTML = `
        <div class="profile-header">
          <div class="avatar">${user.email[0].toUpperCase()}</div>
          <div class="user-info">
            <strong>${user.email.split('@')[0]}</strong>
            <div class="muted">Ø¹Ø¶Ùˆ Ù…Ø³Ø¬Ù„</div>
            <div class="muted" style="margin-top: 4px; font-size: 11px;">
              <i class="fas fa-clock"></i> ${formatDate(user.metadata.lastSignInTime || Date.now())}
            </div>
          </div>
        </div>
        <div class="auth-buttons">
          <button class="btn ghost" id="logout">
            <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
          </button>
        </div>
      `;
      
      document.getElementById('logout').onclick = () => {
        signOut(getFirebase().auth).then(() => {
          showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        });
      };
      
      initProfile(user.uid);
    } else {
      hideBanOverlay();
      isUserBanned = false;
      banData = null;
      
      authBox.innerHTML = `
        <h3 style="margin-bottom: 12px; color: var(--text-light); font-size: 14px;">
          <i class="fas fa-user" style="margin-left: 6px;"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </h3>
        <div class="auth-form">
          <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
          <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
          <div class="auth-buttons">
            <button class="btn" id="login">
              <i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„
            </button>
            <button class="btn ghost" id="register">
              <i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
            </button>
          </div>
        </div>
        <div class="muted" style="margin-top: 12px; font-size: 11px; text-align: center;">
          <p>Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙˆØ§Ù„Ø¥Ø¹Ø¬Ø§Ø¨</p>
        </div>
      `;
      
      document.getElementById('login').onclick = () => login();
      document.getElementById('register').onclick = () => register();
      
      const passInput = document.getElementById('pass');
      if (passInput) {
        passInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') login();
        });
      }
    }
    
    if (articlesSection.style.display === 'block') {
      resetArticlesPagination();
      loadArticles();
    }
  });
  
  async function login() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    
    if (!email || !pass) {
      showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
      return;
    }
    
    // Rate limiting Ù„Ù„Ø¯Ø®ÙˆÙ„
    if (!rateLimiter.check('global', 'login', 5, 60000)) {
      showNotification('Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©', 'error');
      return;
    }
    
    try {
      const { auth } = getFirebase();
      await signInWithEmailAndPassword(auth, email, pass);
      showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } catch (e) {
      if (e.code === 'auth/invalid-credential') {
        showNotification('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
      } else if (e.code === 'auth/user-not-found') {
        showNotification('Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
      } else if (e.code === 'auth/wrong-password') {
        showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
      } else {
        showNotification(e.message, 'error');
      }
    }
  }
  
  async function register() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    
    if (!email || !pass) {
      showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
      return;
    }
    
    if (pass.length < 6) {
      showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
      return;
    }
    
    // Rate limiting Ù„Ù„ØªØ³Ø¬ÙŠÙ„
    if (!rateLimiter.check('global', 'register', 3, 60000)) {
      showNotification('Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©', 'error');
      return;
    }
    
    try {
      const { auth, db } = getFirebase();
      const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
      const user = userCredential.user;
      
      const randomUsername = generateRandomUsername();
      const currentTime = Date.now();
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§ØµØ©
      await resilientFirebaseOperation(() => 
        set(ref(db, `users/${user.uid}`), {
          username: randomUsername,
          email: email,
          joinDate: currentTime,
          lastLogin: currentTime,
          articlesCount: 0,
          likesCount: 0,
          commentsCount: 0,
          verified: false,
          bio: 'Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø±ÙŠØ¯Ø¨ÙŠÙ„.'
        })
      );
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¹Ø§Ù…
      await resilientFirebaseOperation(() => 
        set(ref(db, `userPublicProfiles/${user.uid}`), {
          username: randomUsername,
          joinDate: currentTime,
          articlesCount: 0,
          verified: false,
          bioPreview: 'Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø±ÙŠØ¯Ø¨ÙŠÙ„.'
        })
      );
      
      showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } catch (e) {
      if (e.code === 'auth/email-already-in-use') {
        showNotification('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„', 'error');
      } else if (e.code === 'auth/invalid-email') {
        showNotification('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
      } else if (e.code === 'auth/weak-password') {
        showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
      } else {
        showNotification(e.message, 'error');
      }
    }
  }
  
  /* =====================================================
     USER DATA FUNCTIONS - Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ÙƒØ§Ø´
  ===================================================== */
  async function getPublicUserProfile(userId) {
    if (!userId) {
      return {
        username: 'Ù…Ø¬Ù‡ÙˆÙ„',
        joinDate: Date.now(),
        articlesCount: 0,
        verified: false,
        bioPreview: ''
      };
    }
    
    const cacheKey = `user_public_${userId}`;
    const cached = advancedCache.users.get(cacheKey);
    if (cached) {
      const now = Date.now();
      if (now < cached.expiry) {
        return cached.data;
      }
      advancedCache.users.delete(cacheKey);
    }
    
    try {
      const publicRef = ref(getFirebase().db, `userPublicProfiles/${userId}`);
      const snap = await resilientFirebaseOperation(() => get(publicRef));
      
      if (snap.exists()) {
        const publicData = snap.val();
        
        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ù„Ù…Ø¯Ø© 5 Ø¯Ù‚Ø§Ø¦Ù‚
        advancedCache.users.set(cacheKey, {
          data: publicData,
          expiry: Date.now() + 300000
        });
        
        return publicData;
      }
      
      // fallback
      try {
        const userRef = ref(getFirebase().db, `users/${userId}`);
        const userSnap = await resilientFirebaseOperation(() => get(userRef));
        if (userSnap.exists()) {
          const u = userSnap.val();
          const publicData = {
            username: u.username || 'Ù…Ø¬Ù‡ÙˆÙ„',
            joinDate: u.joinDate || Date.now(),
            articlesCount: u.articlesCount || 0,
            verified: u.verified === true,
            bioPreview: (u.bio || '').substring(0, 120)
          };
          
          advancedCache.users.set(cacheKey, {
            data: publicData,
            expiry: Date.now() + 300000
          });
          
          return publicData;
        }
      } catch(e) {}
      
      // Ø¢Ø®Ø± fallback
      return {
        username: 'Ù…Ø¬Ù‡ÙˆÙ„',
        joinDate: Date.now(),
        articlesCount: 0,
        verified: false,
        bioPreview: ''
      };
      
    } catch (error) {
      console.log('Error fetching public profile:', error);
      return {
        username: 'Ù…Ø¬Ù‡ÙˆÙ„',
        joinDate: Date.now(),
        articlesCount: 0,
        verified: false,
        bioPreview: ''
      };
    }
  }
  
  async function getUserData(userId) {
    if (!userId || !currentUser) return null;
    
    if (userId === currentUser.uid) {
      try {
        const userRef = ref(getFirebase().db, `users/${userId}`);
        const snap = await resilientFirebaseOperation(() => get(userRef));
        
        if (snap.exists()) {
          return snap.val();
        }
      } catch (error) {
        console.log('Error fetching private user data:', error);
      }
    }
    
    return await getPublicUserProfile(userId);
  }
  
  async function getUsername(userId) {
    if (!userId) return 'Ù…Ø¬Ù‡ÙˆÙ„';
    
    const publicProfile = await getPublicUserProfile(userId);
    return publicProfile.username || 'Ù…Ø¬Ù‡ÙˆÙ„';
  }
  
  async function isUserVerified(userId) {
    if (!userId) return false;
    
    const cacheKey = `user_verified_${userId}`;
    const cached = advancedCache.users.get(cacheKey);
    if (cached && cached.data !== undefined) {
      return cached.data;
    }
    
    try {
      const publicRef = ref(getFirebase().db, `userPublicProfiles/${userId}`);
      const pubSnap = await resilientFirebaseOperation(() => get(publicRef));
      if (pubSnap.exists() && pubSnap.val().verified === true) {
        advancedCache.users.set(cacheKey, { data: true, expiry: Date.now() + 600000 });
        return true;
      }
      
      const userRef = ref(getFirebase().db, `users/${userId}`);
      const userSnap = await resilientFirebaseOperation(() => get(userRef));
      if (userSnap.exists() && userSnap.val().verified === true) {
        advancedCache.users.set(cacheKey, { data: true, expiry: Date.now() + 600000 });
        return true;
      }
      
      advancedCache.users.set(cacheKey, { data: false, expiry: Date.now() + 600000 });
      return false;
      
    } catch (e) {
      return false;
    }
  }
  
  function getUsernameWithVerification(username, isVerified) {
    const safe = username || 'Ù…Ø¬Ù‡ÙˆÙ„';
    if (isVerified === true) {
      return `
        <span class="verified-user">
          <span class="username">${safe}</span>
          <span class="verified-badge">
            <i class="fas fa-check"></i>
          </span>
        </span>
      `;
    }
    return `<span class="username">${safe}</span>`;
  }
  
  /* =====================================================
     ARTICLES SYSTEM - Ù…Ø­Ø³Ù† Ù„Ù„Ø¶ØºØ·
  ===================================================== */
  function resetArticlesPagination() {
    lastArticleTimestamp = null;
    hasMoreArticles = true;
    allArticles = [];
    articlesDiv.innerHTML = '';
    loadMoreArticlesContainer.style.display = 'none';
  }
  
  async function loadArticles() {
    if (articlesLoading) return;
    
    smartDebounce('load_articles', async () => {
      await loadArticlesInternal();
    });
  }
  
  async function loadArticlesInternal() {
    articlesLoading = true;
    
    articlesDiv.innerHTML = `
      <div class="loading" id="loadingArticles">
        <div class="spinner"></div>
      </div>
    `;
    loadMoreArticlesContainer.style.display = 'none';
    
    try {
      let articles = [];
      const cacheKey = `articles_${currentFilter}`;
      const cached = advancedCache.getWithStats(cacheKey);
      
      if (cached.data && cached.data.length > 0) {
        articles = cached.data.slice(0, articlesPerPage);
        allArticles = articles;
      }
      
      if (articles.length === 0) {
        articles = await fetchArticles();
        advancedCache.set(cacheKey, articles, 10000); // 10 Ø«ÙˆØ§Ù†ÙŠ Ù„Ù„ØªØ­Ø¯ÙŠØ«
      }
      
      if (articles.length === 0) {
        articlesDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-newspaper"></i>
            <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯</h3>
            <p>ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙ†Ø´Ø± Ù…Ù‚Ø§Ù„Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¯Ù‰!</p>
            ${currentUser && !isUserBanned ? `
            <button class="btn" onclick="openPublishModal()" style="margin-top: 16px; width: auto;">
              <i class="fas fa-pen-fancy"></i> Ù†Ø´Ø± Ø£ÙˆÙ„ Ù…Ù‚Ø§Ù„
            </button>
            ` : `
            <button class="btn" onclick="login()" style="margin-top: 16px; width: auto;">
              <i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø´Ø±
            </button>
            `}
          </div>
        `;
        articlesLoading = false;
        return;
      }
      
      articlesDiv.innerHTML = '';
      
      if (currentUser && !isUserBanned) {
        await loadUserLikes();
      }
      
      for (const article of articles) {
        if (!allArticles.some(a => a.id === article.id)) {
          allArticles.push(article);
          await renderArticle(article);
        }
      }
      
      hasMoreArticles = articles.length === articlesPerPage;
      loadMoreArticlesContainer.style.display = hasMoreArticles ? 'block' : 'none';
      
    } catch (error) {
      console.error('Error loading articles:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª', 'error');
    } finally {
      articlesLoading = false;
    }
  }
  
  async function fetchArticles() {
    let options = { limit: articlesPerPage };
    
    if (currentFilter === 'popular') {
      options.orderBy = 'likesCount';
    } else {
      options.orderBy = 'created';
    }
    
    return await smartFetch('articles', options);
  }
  
  window.loadMoreArticles = async () => {
    if (articlesLoading || !hasMoreArticles) return;
    
    articlesLoading = true;
    loadMoreArticlesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    loadMoreArticlesBtn.classList.add('loading');
    
    try {
      const articles = await fetchMoreArticles();
      
      if (articles.length === 0) {
        hasMoreArticles = false;
        loadMoreArticlesContainer.style.display = 'none';
        return;
      }
      
      if (currentUser && !isUserBanned) {
        await loadUserLikesForArticles(articles);
      }
      
      for (const article of articles) {
        if (!allArticles.some(a => a.id === article.id)) {
          allArticles.push(article);
          await renderArticle(article);
        }
      }
      
      hasMoreArticles = articles.length === articlesPerPage;
      loadMoreArticlesContainer.style.display = hasMoreArticles ? 'block' : 'none';
      
    } catch (error) {
      console.error('Error loading more articles:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª', 'error');
    } finally {
      articlesLoading = false;
      loadMoreArticlesBtn.innerHTML = '<i class="fas fa-redo"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª';
      loadMoreArticlesBtn.classList.remove('loading');
    }
  };
  
  async function fetchMoreArticles() {
    if (allArticles.length === 0) return [];
    
    const lastArticle = allArticles[allArticles.length - 1];
    const lastTimestamp = lastArticle.created;
    
    let options = { limit: articlesPerPage };
    
    if (currentFilter === 'popular') {
      options.orderBy = 'likesCount';
    } else {
      options.orderBy = 'created';
      options.endAt = lastTimestamp - 1;
    }
    
    return await smartFetch('articles', options);
  }
  
  window.filterArticles = (filterType) => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    currentFilter = filterType;
    resetArticlesPagination();
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    loadArticles();
  };
  
  async function loadUserLikes() {
    if (!currentUser) return;
    
    try {
      articleLikes.clear();
      const likes = await smartFetch('likes', { cacheTTL: 30000 });
      
      likes.forEach(article => {
        if (article[currentUser.uid]) {
          articleLikes.set(article.id, true);
        }
      });
    } catch (error) {
      console.log('Error loading user likes:', error);
    }
  }
  
  async function loadUserLikesForArticles(articles) {
    if (!currentUser || !articles.length) return;
    
    try {
      for (const article of articles) {
        const likeRef = ref(getFirebase().db, `likes/${article.id}/${currentUser.uid}`);
        const likeSnap = await resilientFirebaseOperation(() => get(likeRef));
        if (likeSnap.exists()) {
          articleLikes.set(article.id, true);
        }
      }
    } catch (error) {
      console.log('Error loading likes for new articles:', error);
    }
  }
  
  async function renderArticle(article) {
    const card = document.createElement('div');
    card.className = 'card';
    
    const isAuthor = currentUser && article.author === currentUser.uid;
    const liked = articleLikes.has(article.id);
    
    const username = await getUsername(article.author);
    const isVerified = await isUserVerified(article.author);
    const usernameHTML = getUsernameWithVerification(username, isVerified);
    
    let tagsHTML = '';
    if (article.likesCount > 10) {
      tagsHTML += '<span class="tag hot">ğŸ”¥ Ø´Ø§Ø¦Ø¹</span>';
    }
    
    if (Date.now() - article.created < 24 * 60 * 60 * 1000) {
      tagsHTML += '<span class="tag new">ğŸ†• Ø¬Ø¯ÙŠØ¯</span>';
    }
    
    if (article.category) {
      tagsHTML += `<span class="tag">${article.category}</span>`;
    }
    
    const readTime = article.readTime || Math.max(1, Math.floor((article.content.length || 0) / 500));
    
    let viewsCount = article.viewsCount || 0;
    if (viewsCount === 0) {
      const ageInDays = Math.max(1, Math.floor((Date.now() - article.created) / (24 * 60 * 60 * 1000)));
      const baseViews = Math.floor(Math.random() * 20) + 5;
      const likesBoost = (article.likesCount || 0) * 3;
      const commentsBoost = (article.commentsCount || 0) * 2;
      viewsCount = baseViews + (ageInDays * 5) + likesBoost + commentsBoost;
    }
    
    const likeButton = currentUser && !isUserBanned ? 
      `<div class="action-btn like ${liked ? 'active' : ''}" onclick="toggleLike(event, '${article.id}')">
        <i class="${liked ? 'fas' : 'far'} fa-heart" style="${liked ? 'color: #ff4757;' : ''}"></i>
        <span>${article.likesCount || 0}</span>
      </div>` :
      `<div class="action-btn like" onclick="handleBannedAction('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨')">
        <i class="far fa-heart"></i>
        <span>${article.likesCount || 0}</span>
      </div>`;
    
    const commentButton = currentUser && !isUserBanned ?
      `<div class="action-btn comment" onclick="openComments('${article.id}')">
        <i class="far fa-comment"></i>
        <span>${article.commentsCount || 0}</span>
      </div>` :
      `<div class="action-btn comment" onclick="handleBannedAction('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚')">
        <i class="far fa-comment"></i>
        <span>${article.commentsCount || 0}</span>
      </div>`;
    
    card.innerHTML = `
      <div class="article-title">${article.title || 'Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
      <div style="margin-top: 8px;">
        ${tagsHTML}
      </div>
      <div class="article-meta">
        <span><i class="far fa-calendar"></i> ${formatDate(article.created)}</span>
        <span><i class="far fa-user"></i> ${usernameHTML}</span>
        <span class="view-count"><i class="far fa-eye"></i> ${viewsCount} Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
        <span><i class="far fa-clock"></i> ${readTime} Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø±Ø§Ø¡Ø©</span>
      </div>
      <div class="article-content">
        ${article.content || 'Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù…ØªÙˆÙØ±'}
      </div>
      <div class="article-actions">
        ${likeButton}
        ${commentButton}
        ${isAuthor && !isUserBanned ? `
        <div class="action-btn delete" onclick="deleteArticle('${article.id}')">
          <i class="far fa-trash-alt"></i>
          <span>Ø­Ø°Ù</span>
        </div>
        ` : ''}
      </div>
    `;
    
    articlesDiv.appendChild(card);
    
    if (currentUser && !isUserBanned) {
      setTimeout(() => {
        trackArticleView(article.id);
      }, 1000);
    }
  }
  
  /* =====================================================
     HANDLE BANNED ACTIONS
  ===================================================== */
  function handleBannedAction(defaultMessage) {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!currentUser) {
      showNotification(defaultMessage, 'error');
    }
  }
  
  /* =====================================================
     ENHANCED LIKES SYSTEM
  ===================================================== */
  window.toggleLike = async (event, articleId) => {
    event.preventDefault();
    event.stopPropagation();
    
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!currentUser) {
      showNotification('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
      return;
    }
    
    // Rate limiting Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª
    if (!rateLimiter.check(currentUser.uid, 'like', 30, 60000)) {
      showNotification('Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§ØªØŒ ØªÙˆÙ‚Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹!', 'error');
      return;
    }
    
    const likeBtn = event.currentTarget;
    
    if (likeBtn.classList.contains('processing')) {
      return;
    }
    
    likeBtn.classList.add('processing');
    
    const likeIcon = likeBtn.querySelector('i');
    const likeCountSpan = likeBtn.querySelector('span');
    const currentCount = parseInt(likeCountSpan.textContent) || 0;
    
    const likeRef = ref(getFirebase().db, `likes/${articleId}/${currentUser.uid}`);
    const likeSnap = await resilientFirebaseOperation(() => get(likeRef));
    const alreadyLiked = likeSnap.exists();
    
    let newCount;
    
    if (alreadyLiked) {
      newCount = Math.max(0, currentCount - 1);
      likeBtn.classList.remove('active');
      likeIcon.style.color = '';
      articleLikes.delete(articleId);
    } else {
      newCount = currentCount + 1;
      likeBtn.classList.add('active');
      likeIcon.style.color = '#ff4757';
      articleLikes.set(articleId, true);
    }
    
    likeCountSpan.textContent = newCount;
    
    try {
      if (alreadyLiked) {
        await resilientFirebaseOperation(() => remove(likeRef));
        await resilientFirebaseOperation(() => 
          update(ref(getFirebase().db, `articles/${articleId}`), {
            likesCount: increment(-1)
          })
        );
        showNotification('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨', 'success');
      } else {
        await resilientFirebaseOperation(() => 
          set(likeRef, {
            userId: currentUser.uid,
            timestamp: Date.now()
          })
        );
        await resilientFirebaseOperation(() => 
          update(ref(getFirebase().db, `articles/${articleId}`), {
            likesCount: increment(1)
          })
        );
        showNotification('ØªÙ… Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ø§Ù„Ù…Ù‚Ø§Ù„', 'success');
      }
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´
      advancedCache.articles.delete(`articles_all`);
      advancedCache.articles.delete(`articles_popular`);
      advancedCache.articles.delete(`articles_recent`);
      
    } catch (error) {
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨', 'error');
      if (alreadyLiked) {
        likeBtn.classList.add('active');
        likeIcon.style.color = '#ff4757';
        likeCountSpan.textContent = currentCount;
        articleLikes.set(articleId, true);
      } else {
        likeBtn.classList.remove('active');
        likeIcon.style.color = '';
        likeCountSpan.textContent = currentCount;
        articleLikes.delete(articleId);
      }
    } finally {
      setTimeout(() => {
        likeBtn.classList.remove('processing');
      }, 500);
    }
  };
  
  /* =====================================================
     COMMENTS SYSTEM
  ===================================================== */
  window.openComments = async (articleId) => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!currentUser) {
      showNotification('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
      return;
    }
    
    currentArticleId = articleId;
    resetCommentsPagination();
    commentModal.style.display = 'flex';
    
    initCharacterCounters();
    
    await checkCommentCooldown();
    
    await loadComments(articleId);
  };
  
  function resetCommentsPagination() {
    lastCommentTimestamp = null;
    hasMoreComments = true;
    loadMoreCommentsContainer.style.display = 'none';
    const commentsList = document.getElementById('commentsList');
    commentsList.innerHTML = '';
  }
  
  window.closeCommentModal = () => {
    commentModal.style.display = 'none';
    document.getElementById('newComment').value = '';
    loadMoreCommentsContainer.style.display = 'none';
    
    commentCounter.textContent = '0/1500';
    commentCounter.className = 'char-counter muted';
    
    if (commentCooldownTimer) {
      clearInterval(commentCooldownTimer);
      commentCooldownTimer = null;
    }
  };
  
  async function loadComments(articleId, loadMore = false) {
    const commentsList = document.getElementById('commentsList');
    
    if (!loadMore) {
      commentsList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    }
    
    try {
      const cacheKey = `comments_${articleId}`;
      let comments = [];
      
      if (!loadMore) {
        const cached = advancedCache.comments.get(cacheKey);
        if (cached) {
          const now = Date.now();
          if (now < cached.expiry) {
            comments = cached.data;
          }
        }
      }
      
      if (comments.length === 0) {
        const options = { orderBy: 'created', limit: commentsPerPage };
        if (loadMore && lastCommentTimestamp) {
          options.endAt = lastCommentTimestamp - 1;
        }
        
        comments = await smartFetch(`comments/${articleId}`, options);
        
        if (!loadMore) {
          advancedCache.comments.set(cacheKey, {
            data: comments,
            expiry: Date.now() + 15000
          });
        }
      }
      
      if (comments.length === 0 && !loadMore) {
        commentsList.innerHTML = `
          <div class="empty-state">
            <i class="far fa-comments"></i>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯</p>
            <p class="muted">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¹Ù„Ù‚ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù„</p>
          </div>
        `;
        hasMoreComments = false;
        loadMoreCommentsContainer.style.display = 'none';
        return;
      }
      
      if (!loadMore) {
        commentsList.innerHTML = '';
      }
      
      for (const comment of comments) {
        const username = await getUsername(comment.author);
        const isVerified = await isUserVerified(comment.author);
        const usernameHTML = getUsernameWithVerification(username, isVerified);
        
        const commentEl = document.createElement('div');
        commentEl.className = 'comment';
        
        commentEl.innerHTML = `
          <div class="comment-header">
            <div class="comment-author">${usernameHTML}</div>
            <div class="comment-time">${formatDate(comment.created)}</div>
          </div>
          <div class="comment-content">${comment.text}</div>
        `;
        
        commentsList.appendChild(commentEl);
        
        if (!lastCommentTimestamp || comment.created < lastCommentTimestamp) {
          lastCommentTimestamp = comment.created;
        }
      }
      
      hasMoreComments = comments.length === commentsPerPage;
      loadMoreCommentsContainer.style.display = hasMoreComments ? 'block' : 'none';
      
    } catch (error) {
      console.error('Error loading comments:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª', 'error');
    }
  }
  
  window.loadMoreComments = async () => {
    if (!hasMoreComments) return;
    
    loadMoreCommentsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    loadMoreCommentsBtn.classList.add('loading');
    
    await loadComments(currentArticleId, true);
    
    loadMoreCommentsBtn.innerHTML = '<i class="fas fa-redo"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª';
    loadMoreCommentsBtn.classList.remove('loading');
  };
  
  window.postComment = async () => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    const canComment = await checkCommentCooldown();
    if (!canComment) {
      showNotification('ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ', 'error');
      return;
    }
    
    // Rate limiting Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    if (!rateLimiter.check(currentUser.uid, 'comment', 20, 60000)) {
      showNotification('Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§ØªØŒ ØªÙˆÙ‚Ù Ù‚Ù„ÙŠÙ„Ø§Ù‹!', 'error');
      return;
    }
    
    const commentText = document.getElementById('newComment').value.trim();
    
    if (!commentText) {
      showNotification('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚', 'error');
      return;
    }
    
    if (commentText.length > COMMENT_MAX_LENGTH) {
      showNotification(`Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ù‹Ø§ (${COMMENT_MAX_LENGTH} Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)`, 'error');
      return;
    }
    
    try {
      const { db } = getFirebase();
      const commentRef = ref(db, `comments/${currentArticleId}`);
      const articleRef = ref(db, `articles/${currentArticleId}`);
      
      await resilientFirebaseOperation(() => 
        push(commentRef, {
          text: commentText,
          author: currentUser.uid,
          created: Date.now()
        })
      );
      
      const articleSnap = await resilientFirebaseOperation(() => get(articleRef));
      const articleData = articleSnap.val();
      const newCommentsCount = (articleData.commentsCount || 0) + 1;
      
      await resilientFirebaseOperation(() => 
        update(articleRef, { commentsCount: newCommentsCount })
      );
      
      // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (currentUser) {
        const userRef = ref(db, `users/${currentUser.uid}`);
        await resilientFirebaseOperation(() => 
          update(userRef, { 
            commentsCount: increment(1),
            lastComment: Date.now()
          })
        );
      }
      
      document.getElementById('newComment').value = '';
      resetCommentsPagination();
      loadComments(currentArticleId);
      
      showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 'success');
      
      commentCounter.textContent = '0/1500';
      commentCounter.className = 'char-counter muted';
      
      await checkCommentCooldown();
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´
      advancedCache.comments.delete(`comments_${currentArticleId}`);
      
    } catch (error) {
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 'error');
    }
  };
  
  /* =====================================================
     COOLDOWN FUNCTIONS
  ===================================================== */
  async function checkArticleCooldown() {
    if (!currentUser) return true;
    
    try {
      const userRef = ref(getFirebase().db, 'users/' + currentUser.uid);
      const snap = await resilientFirebaseOperation(() => get(userRef));
      
      if (snap.exists()) {
        const userData = snap.val();
        const lastArticleTime = userData.lastArticle || 0;
        const now = Date.now();
        const timeSinceLastArticle = now - lastArticleTime;
        
        if (timeSinceLastArticle < ARTICLE_COOLDOWN) {
          const remainingTime = ARTICLE_COOLDOWN - timeSinceLastArticle;
          articleCooldownEnd = now + remainingTime;
          
          const cooldownMessage = document.getElementById('cooldownMessage');
          const publishBtn = document.getElementById('publishBtn');
          
          if (cooldownMessage && publishBtn) {
            cooldownMessage.style.display = 'flex';
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<i class="fas fa-clock"></i> ÙÙŠ ÙØªØ±Ø© Ø§Ù„ØªØ¨Ø±ÙŠØ¯';
            publishBtn.style.opacity = '0.7';
            publishBtn.style.cursor = 'not-allowed';
            
            if (articleCooldownTimer) clearInterval(articleCooldownTimer);
            articleCooldownTimer = setInterval(() => updateArticleCooldownTimer(), 1000);
            updateArticleCooldownTimer();
          }
          
          return false;
        }
      }
    } catch (error) {
      console.log('Error checking article cooldown:', error);
    }
    
    return true;
  }
  
  function updateArticleCooldownTimer() {
    const now = Date.now();
    const remaining = Math.max(0, articleCooldownEnd - now);
    
    if (remaining <= 0) {
      clearInterval(articleCooldownTimer);
      
      const cooldownMessage = document.getElementById('cooldownMessage');
      const publishBtn = document.getElementById('publishBtn');
      
      if (cooldownMessage && publishBtn) {
        cooldownMessage.style.display = 'none';
        publishBtn.disabled = false;
        publishBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„';
        publishBtn.style.opacity = '1';
        publishBtn.style.cursor = 'pointer';
      }
      return;
    }
    
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    
    const timerElement = document.getElementById('articleCooldownTimer');
    if (timerElement) {
      timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
  }
  
  async function checkCommentCooldown() {
    if (!currentUser) return true;
    
    try {
      const userRef = ref(getFirebase().db, 'users/' + currentUser.uid);
      const snap = await resilientFirebaseOperation(() => get(userRef));
      
      if (snap.exists()) {
        const userData = snap.val();
        const lastCommentTime = userData.lastComment || 0;
        const now = Date.now();
        const timeSinceLastComment = now - lastCommentTime;
        
        if (timeSinceLastComment < COMMENT_COOLDOWN) {
          const remainingTime = COMMENT_COOLDOWN - timeSinceLastComment;
          commentCooldownEnd = now + remainingTime;
          
          const cooldownMessage = document.getElementById('commentCooldownMessage');
          const postCommentBtn = document.getElementById('postCommentBtn');
          
          if (cooldownMessage && postCommentBtn) {
            cooldownMessage.style.display = 'flex';
            postCommentBtn.disabled = true;
            postCommentBtn.innerHTML = '<i class="fas fa-clock"></i> ÙÙŠ ÙØªØ±Ø© Ø§Ù„ØªØ¨Ø±ÙŠØ¯';
            postCommentBtn.style.opacity = '0.7';
            postCommentBtn.style.cursor = 'not-allowed';
            
            if (commentCooldownTimer) clearInterval(commentCooldownTimer);
            commentCooldownTimer = setInterval(() => updateCommentCooldownTimer(), 1000);
            updateCommentCooldownTimer();
          }
          
          return false;
        }
      }
    } catch (error) {
      console.log('Error checking comment cooldown:', error);
    }
    
    return true;
  }
  
  function updateCommentCooldownTimer() {
    const now = Date.now();
    const remaining = Math.max(0, commentCooldownEnd - now);
    
    if (remaining <= 0) {
      clearInterval(commentCooldownTimer);
      
      const cooldownMessage = document.getElementById('commentCooldownMessage');
      const postCommentBtn = document.getElementById('postCommentBtn');
      
      if (cooldownMessage && postCommentBtn) {
        cooldownMessage.style.display = 'none';
        postCommentBtn.disabled = false;
        postCommentBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚';
        postCommentBtn.style.opacity = '1';
        postCommentBtn.style.cursor = 'pointer';
      }
      return;
    }
    
    const seconds = Math.ceil(remaining / 1000);
    
    const timerElement = document.getElementById('commentCooldownTimer');
    if (timerElement) {
      timerElement.textContent = seconds;
    }
  }
  
  /* =====================================================
     CHARACTER COUNTER FUNCTIONS
  ===================================================== */
  function initCharacterCounters() {
    const articleTitleInput = document.getElementById('articleTitle');
    if (articleTitleInput) {
      articleTitleInput.addEventListener('input', () => {
        const length = articleTitleInput.value.length;
        titleCounter.textContent = `${length}/${TITLE_MAX_LENGTH}`;
        updateCharCounterStyle(titleCounter, length, TITLE_MAX_LENGTH);
      });
    }
    
    const articleContentInput = document.getElementById('articleContent');
    if (articleContentInput) {
      articleContentInput.addEventListener('input', () => {
        const length = articleContentInput.value.length;
        contentCounter.textContent = `${length}/${CONTENT_MAX_LENGTH}`;
        updateCharCounterStyle(contentCounter, length, CONTENT_MAX_LENGTH);
      });
    }
    
    const newCommentInput = document.getElementById('newComment');
    if (newCommentInput) {
      newCommentInput.addEventListener('input', () => {
        const length = newCommentInput.value.length;
        commentCounter.textContent = `${length}/${COMMENT_MAX_LENGTH}`;
        updateCharCounterStyle(commentCounter, length, COMMENT_MAX_LENGTH);
      });
    }
  }
  
  function updateCharCounterStyle(counter, length, max) {
    counter.className = 'char-counter';
    if (length === 0) {
      counter.classList.add('muted');
    } else if (length > max * 0.9) {
      counter.classList.add('error');
    } else if (length > max * 0.75) {
      counter.classList.add('warning');
    } else {
      counter.classList.add('muted');
    }
  }
  
  /* =====================================================
     PROFILE FUNCTIONS
  ===================================================== */
  async function initProfile(uid) {
    try {
      const userRef = ref(getFirebase().db, 'users/' + uid);
      const snap = await resilientFirebaseOperation(() => get(userRef));
      
      if (!snap.exists()) {
        const username = generateRandomUsername();
        const currentTime = Date.now();
        
        await resilientFirebaseOperation(() => 
          set(userRef, {
            username: username,
            email: currentUser.email,
            bio: 'Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø±ÙŠØ¯Ø¨ÙŠÙ„.',
            joinDate: currentTime,
            lastLogin: currentTime,
            articlesCount: 0,
            likesCount: 0,
            commentsCount: 0,
            lastArticle: 0,
            lastComment: 0,
            verified: false
          })
        );
        
        await resilientFirebaseOperation(() => 
          set(ref(getFirebase().db, `userPublicProfiles/${uid}`), {
            username: username,
            joinDate: currentTime,
            articlesCount: 0,
            verified: false,
            bioPreview: 'Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…Ù†ØªØ¯Ù‰ Ø§Ù„Ø±ÙŠØ¯Ø¨ÙŠÙ„.'
          })
        );
      } else {
        await resilientFirebaseOperation(() => 
          update(userRef, { lastLogin: Date.now() })
        );
      }
    } catch (error) {
      console.log('Error initializing profile:', error);
    }
  }
  
  async function openProfile() {
    if (!currentUser) {
      profileView.innerHTML = `
        <div class="card highlight">
          <div class="empty-state">
            <i class="fas fa-user-lock"></i>
            <h3>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <p>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ</p>
            <button class="btn" onclick="showSection('articles')" style="margin-top: 16px; width: auto;">
              <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù‚Ø§Ù„Ø§Øª
            </button>
          </div>
        </div>
      `;
      return;
    }
    
    try {
      const userData = await getUserData(currentUser.uid);
      if (!userData) {
        showNotification('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'error');
        return;
      }
      
      const isVerified = userData.verified === true;
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… smartFetch
      let userArticlesCount = 0;
      let userLikesCount = 0;
      
      const userArticles = await smartFetch('articles', { 
        orderBy: 'created',
        cacheTTL: 30000
      });
      
      userArticles.forEach(article => {
        if (article.author === currentUser.uid) {
          userArticlesCount++;
          userLikesCount += article.likesCount || 0;
        }
      });
      
      let userCommentsCount = 0;
      const comments = await smartFetch('comments', { cacheTTL: 60000 });
      comments.forEach(commentSection => {
        if (commentSection.author === currentUser.uid) {
          userCommentsCount++;
        }
      });
      
      const usernameHTML = getUsernameWithVerification(userData.username || 'Ù…Ø³ØªØ®Ø¯Ù…', isVerified);
      
      profileView.innerHTML = `
        <div class="card highlight">
          <div class="profile-header">
            <div class="avatar">${currentUser.email[0].toUpperCase()}</div>
            <div>
              <h3 style="display: flex; align-items: center; gap: 10px;">${usernameHTML}</h3>
              <div class="muted">${currentUser.email}</div>
              <div class="muted">Ù…Ù†Ø° ${formatDate(userData.joinDate)}</div>
            </div>
          </div>
          
          <div class="profile-stats">
            <div class="stat">
              <div class="stat-value">${userArticlesCount}</div>
              <div class="stat-label">Ù…Ù‚Ø§Ù„Ø§Øª</div>
            </div>
            <div class="stat">
              <div class="stat-value">${userLikesCount}</div>
              <div class="stat-label">Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª</div>
            </div>
            <div class="stat">
              <div class="stat-value">${userCommentsCount}</div>
              <div class="stat-label">ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>
            </div>
          </div>
          
          <div style="background: #222222; padding: 16px; border-radius: var(--radius-sm); margin: 20px 0; border: 1px solid var(--border);">
            <h4 style="font-size: 14px;"><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
            <div class="muted" style="margin-top: 10px; font-size: 12px;">
              <p><i class="fas fa-envelope"></i> <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${currentUser.email}</p>
              <p style="margin-top: 6px;"><i class="fas fa-calendar"></i> <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</strong> ${new Date(userData.joinDate).toLocaleDateString('ar-SA')}</p>
              <p style="margin-top: 6px;"><i class="fas fa-clock"></i> <strong>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·:</strong> ${formatDate(userData.lastLogin || userData.joinDate)}</p>
              ${isVerified ? `
              <p style="margin-top: 6px; color: var(--verified-color);">
                <i class="fas fa-badge-check"></i> <strong>Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ«Ù‚</strong>
              </p>
              ` : ''}
            </div>
          </div>
          
          <label style="font-size: 13px;">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="p-name" value="${userData.username || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
          
          <label style="margin-top: 12px; font-size: 13px;">Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ</label>
          <textarea id="p-bio" rows="2" placeholder="Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ø¹Ù† Ù†ÙØ³Ùƒ..." style="font-size: 13px;">${userData.bio || ''}</textarea>
          
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn" onclick="saveProfile()">
              <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
            </button>
            <button class="btn ghost" onclick="showSection('articles')">
              <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
            </button>
          </div>
        </div>
      `;
    } catch (error) {
      console.error('Error opening profile:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'error');
    }
  }
  
  window.saveProfile = async () => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    const username = document.getElementById('p-name').value.trim();
    const bio = document.getElementById('p-bio').value.trim();
    
    if (!username) {
      showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…', 'error');
      return;
    }
    
    if (username.length < 3) {
      showNotification('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
      return;
    }
    
    // Rate limiting Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
    if (!rateLimiter.check(currentUser.uid, 'profile_update', 5, 60000)) {
      showNotification('Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©', 'error');
      return;
    }
    
    try {
      const { db } = getFirebase();
      
      await resilientFirebaseOperation(() => 
        update(ref(db, 'users/' + currentUser.uid), {
          username: username,
          bio: bio,
          updated: Date.now()
        })
      );
      
      await resilientFirebaseOperation(() => 
        update(ref(db, `userPublicProfiles/${currentUser.uid}`), {
          username: username,
          bioPreview: bio ? bio.substring(0, 100) : ''
        })
      );
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´
      advancedCache.users.delete(`user_public_${currentUser.uid}`);
      advancedCache.users.delete(`user_verified_${currentUser.uid}`);
      
      showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'success');
      
      setTimeout(() => {
        openProfile();
        if (articlesSection.style.display === 'block') {
          resetArticlesPagination();
          loadArticles();
        }
      }, 500);
      
    } catch (error) {
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', 'error');
    }
  };
  
  /* =====================================================
     VIEWS TRACKING SYSTEM
  ===================================================== */
  async function trackArticleView(articleId) {
    if (!currentUser) return;
    
    // Rate limiting Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
    if (!rateLimiter.check(currentUser.uid, 'article_view', 100, 60000)) {
      return; // ØµØ§Ù…ØªØŒ Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø¥Ø²Ø¹Ø§Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    }
    
    try {
      const viewRef = ref(getFirebase().db, `views/${articleId}/${currentUser.uid}`);
      const viewSnap = await resilientFirebaseOperation(() => get(viewRef));
      
      if (!viewSnap.exists()) {
        await resilientFirebaseOperation(() => 
          set(viewRef, {
            timestamp: Date.now(),
            count: 1
          })
        );
        
        await resilientFirebaseOperation(() => 
          update(ref(getFirebase().db, `articles/${articleId}`), {
            viewsCount: increment(1)
          })
        );
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´
        advancedCache.articles.delete(`articles_all`);
        advancedCache.articles.delete(`articles_popular`);
        advancedCache.articles.delete(`articles_recent`);
      }
    } catch (error) {
      console.log('Error tracking view:', error);
    }
  }
  
  /* =====================================================
     MY ARTICLES VIEW
  ===================================================== */
  async function openMyArticles() {
    if (!currentUser) {
      myArticlesView.innerHTML = `
        <div class="card highlight">
          <div class="empty-state">
            <i class="fas fa-user-lock"></i>
            <h3>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <p>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ù…Ù‚Ø§Ù„Ø§ØªÙƒ</p>
            <button class="btn" onclick="showSection('articles')" style="margin-top: 16px; width: auto;">
              <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ù‚Ø§Ù„Ø§Øª
            </button>
          </div>
        </div>
      `;
      return;
    }
    
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    myArticlesView.innerHTML = `
      <div class="card highlight">
        <h3><i class="fas fa-newspaper"></i> Ù…Ù‚Ø§Ù„Ø§ØªÙŠ</h3>
        <p class="muted" style="margin-top: 8px; font-size: 13px;">Ø¥Ø¯Ø§Ø±Ø© Ù…Ù‚Ø§Ù„Ø§ØªÙƒ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¯Ù‰</p>
        <div id="myArticlesList" style="margin-top: 16px;"></div>
      </div>
    `;
    
    const myArticlesList = document.getElementById('myArticlesList');
    myArticlesList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
      const cacheKey = `user_articles_${currentUser.uid}`;
      let userArticles = [];
      const cached = advancedCache.articles.get(cacheKey);
      
      if (cached) {
        const now = Date.now();
        if (now < cached.expiry) {
          userArticles = cached.data;
        }
      }
      
      if (userArticles.length === 0) {
        const allArticles = await smartFetch('articles', { orderBy: 'created', cacheTTL: 30000 });
        userArticles = allArticles.filter(article => article.author === currentUser.uid);
        
        advancedCache.articles.set(cacheKey, {
          data: userArticles,
          expiry: Date.now() + 30000
        });
      }
      
      if (userArticles.length === 0) {
        myArticlesList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-newspaper"></i>
            <p>Ù„Ù… ØªÙ†Ø´Ø± Ø£ÙŠ Ù…Ù‚Ø§Ù„Ø§Øª Ø¨Ø¹Ø¯</p>
            <button class="btn" onclick="openPublishModal()" style="margin-top: 12px; width: auto;">
              <i class="fas fa-pen-fancy"></i> Ù†Ø´Ø± Ø£ÙˆÙ„ Ù…Ù‚Ø§Ù„
            </button>
          </div>
        `;
        return;
      }
      
      userArticles.sort((a, b) => b.created - a.created);
      
      for (const article of userArticles) {
        const articleEl = document.createElement('div');
        articleEl.className = 'card';
        articleEl.style.marginBottom = '12px';
        articleEl.style.padding = '16px';
        
        articleEl.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px;">
            <div style="flex: 1; min-width: 200px;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <strong style="font-size: 14px;">${article.title}</strong>
              </div>
              <div class="muted" style="margin-top: 4px; font-size: 11px;">
                ${formatDate(article.created)} â€¢ ${article.category || 'ØºÙŠØ± Ù…ØµÙ†Ù'} â€¢ ${article.readTime || '1'} Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø±Ø§Ø¡Ø©
              </div>
              <div style="display: flex; gap: 12px; margin-top: 8px; font-size: 12px;">
                <span><i class="far fa-heart"></i> ${article.likesCount || 0} Ø¥Ø¹Ø¬Ø§Ø¨</span>
                <span><i class="far fa-comment"></i> ${article.commentsCount || 0} ØªØ¹Ù„ÙŠÙ‚</span>
                <span><i class="far fa-eye"></i> ${article.viewsCount || 0} Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
              </div>
            </div>
            <div style="display: flex; gap: 6px;">
              <button class="btn small danger" onclick="deleteArticle('${article.id}')">
                <i class="far fa-trash-alt"></i> Ø­Ø°Ù
              </button>
            </div>
          </div>
        `;
        
        myArticlesList.appendChild(articleEl);
      }
    } catch (error) {
      console.error('Error loading user articles:', error);
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù‚Ø§Ù„Ø§ØªÙƒ', 'error');
    }
  }
  
  /* =====================================================
     PUBLISH ARTICLE
  ===================================================== */
  window.openPublishModal = () => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!currentUser) {
      showNotification('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
      return;
    }
    
    publishModal.style.display = 'flex';
    document.getElementById('articleTitle').focus();
    closeSidebarOnMobile();
    
    initCharacterCounters();
    
    setTimeout(async () => {
      await checkArticleCooldown();
    }, 100);
  };
  
  window.closePublishModal = () => {
    publishModal.style.display = 'none';
    document.getElementById('articleTitle').value = '';
    document.getElementById('articleContent').value = '';
    document.getElementById('articleCategory').value = 'Ø±ÙŠØ¯Ø¨ÙŠÙ„';
    document.getElementById('articleReadTime').value = '3';
    
    titleCounter.textContent = '0/70';
    contentCounter.textContent = '0/2000';
    titleCounter.className = 'char-counter muted';
    contentCounter.className = 'char-counter muted';
    
    if (articleCooldownTimer) {
      clearInterval(articleCooldownTimer);
      articleCooldownTimer = null;
    }
  };
  
  window.publishArticle = async () => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    const canPublish = await checkArticleCooldown();
    if (!canPublish) {
      showNotification('ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ', 'error');
      return;
    }
    
    // Rate limiting Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
    if (!rateLimiter.check(currentUser.uid, 'article_publish', 5, 3600000)) {
      showNotification('Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù‚Ø§Ù„Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©', 'error');
      return;
    }
    
    const title = document.getElementById('articleTitle').value.trim();
    const content = document.getElementById('articleContent').value.trim();
    const category = document.getElementById('articleCategory').value;
    const readTime = document.getElementById('articleReadTime').value;
    
    if (!title || !content) {
      showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
      return;
    }
    
    if (title.length < 5) {
      showNotification('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„ Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§ (5 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)', 'error');
      return;
    }
    
    if (title.length > TITLE_MAX_LENGTH) {
      showNotification(`Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ù‹Ø§ (${TITLE_MAX_LENGTH} Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)`, 'error');
      return;
    }
    
    if (content.length < 50) {
      showNotification('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„ Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§ (50 Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)', 'error');
      return;
    }
    
    if (content.length > CONTENT_MAX_LENGTH) {
      showNotification(`Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ù‹Ø§ (${CONTENT_MAX_LENGTH} Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)`, 'error');
      return;
    }
    
    const articleData = {
      title: title,
      content: content,
      category: category,
      author: currentUser.uid,
      created: Date.now(),
      likesCount: 0,
      commentsCount: 0,
      viewsCount: 0,
      readTime: readTime
    };
    
    try {
      const { db } = getFirebase();
      
      await resilientFirebaseOperation(() => 
        push(ref(db, 'articles'), articleData)
      );
      
      await resilientFirebaseOperation(() => 
        update(ref(db, 'users/' + currentUser.uid), { 
          lastArticle: Date.now(),
          articlesCount: increment(1)
        })
      );
      
      await resilientFirebaseOperation(() => 
        update(ref(db, `userPublicProfiles/${currentUser.uid}`), {
          articlesCount: increment(1)
        })
      );
      
      showNotification('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù‚Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
      closePublishModal();
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´
      advancedCache.articles.delete('articles_all');
      advancedCache.articles.delete('articles_popular');
      advancedCache.articles.delete('articles_recent');
      advancedCache.articles.delete(`user_articles_${currentUser.uid}`);
      
      showSection('articles');
      
    } catch (error) {
      showNotification(error.message, 'error');
    }
  };
  
  /* =====================================================
     DELETE ARTICLE
  ===================================================== */
  window.deleteArticle = async (articleId) => {
    if (isUserBanned) {
      showBanOverlay();
      return;
    }
    
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù„ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.')) return;
    
    try {
      const { db } = getFirebase();
      
      await resilientFirebaseOperation(() => 
        remove(ref(db, `articles/${articleId}`))
      );
      
      await resilientFirebaseOperation(() => 
        remove(ref(db, `likes/${articleId}`))
      );
      
      await resilientFirebaseOperation(() => 
        remove(ref(db, `comments/${articleId}`))
      );
      
      await resilientFirebaseOperation(() => 
        remove(ref(db, `views/${articleId}`))
      );
      
      if (currentUser) {
        await resilientFirebaseOperation(() => 
          update(ref(db, 'users/' + currentUser.uid), { 
            articlesCount: increment(-1) 
          })
        );
        
        await resilientFirebaseOperation(() => 
          update(ref(db, `userPublicProfiles/${currentUser.uid}`), { 
            articlesCount: increment(-1) 
          })
        );
      }
      
      showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„', 'success');
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´
      advancedCache.articles.delete('articles_all');
      advancedCache.articles.delete('articles_popular');
      advancedCache.articles.delete('articles_recent');
      advancedCache.articles.delete(`user_articles_${currentUser.uid}`);
      advancedCache.comments.delete(`comments_${articleId}`);
      
      setTimeout(() => {
        if (articlesSection.style.display === 'block') {
          resetArticlesPagination();
          loadArticles();
        } else if (myArticlesSection.style.display === 'block') {
          openMyArticles();
        }
      }, 300);
      
    } catch (error) {
      showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù‚Ø§Ù„', 'error');
    }
  };
  
  /* =====================================================
     INITIALIZATION
  ===================================================== */
  window.addEventListener('click', (e) => {
    if (e.target === publishModal) {
      closePublishModal();
    }
    
    if (e.target === commentModal) {
      closeCommentModal();
    }
  });
  
  notification.addEventListener('click', () => {
    notification.style.display = 'none';
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (sidebar.classList.contains('active')) {
        toggleSidebar();
      }
      if (publishModal.style.display === 'flex') {
        closePublishModal();
      }
      if (commentModal.style.display === 'flex') {
        closeCommentModal();
      }
      if (bannedOverlay.style.display === 'flex') {
        hideBanOverlay();
      }
    }
    
    if (e.ctrlKey && e.key === 'Enter' && commentModal.style.display === 'flex') {
      const postCommentBtn = document.getElementById('postCommentBtn');
      if (postCommentBtn && !postCommentBtn.disabled) {
        postComment();
      }
    }
  });
  
  window.showSection('articles');
  
  window.addEventListener('load', () => {
    setTimeout(() => {
      document.body.style.opacity = '1';
    }, 100);
  });
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ctrl+Shift+P
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.shiftKey && e.key === 'P') {
      e.preventDefault();
      performanceTracker.reportMetrics();
      
      const cacheStats = {
        articles: advancedCache.articles.size,
        users: advancedCache.users.size,
        comments: advancedCache.comments.size,
        hits: performanceTracker.metrics.cacheHits,
        totalRequests: performanceTracker.metrics.requests
      };
      
      console.log('[Cache Stats]', cacheStats);
      console.log('[Rate Limiter Stats]', rateLimiter.requests.size);
      console.log('[Request Queue]', requestQueue.size);
      
      const notification = document.createElement('div');
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.background = '#111';
      notification.style.color = 'white';
      notification.style.padding = '15px';
      notification.style.borderRadius = '8px';
      notification.style.zIndex = '9999';
      notification.style.border = '1px solid #333';
      notification.innerHTML = `
        <strong>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡:</strong><br>
        Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${performanceTracker.metrics.requests}<br>
        Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒØ§Ø´: ${((performanceTracker.metrics.cacheHits / performanceTracker.metrics.requests) * 100).toFixed(1)}%<br>
        Ù…ÙƒØ§Ù„Ù…Ø§Øª Firebase: ${performanceTracker.metrics.firebaseCalls}
      `;
      
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }
  });
  </script>

<script>
document.addEventListener('contextmenu', function(e) {
  if (!e.target.closest('.article-content, .comment-content')) {
    e.preventDefault();
  }
});
</script>

</body>
</html>
