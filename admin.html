<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لوحة تحكم المشرف - منتدى الريدبيل</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
  /* =====================================================
     GLOBAL / RESET
  ===================================================== */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    font-family: 'Cairo', sans-serif;
    background: #000000;
    color: #ffffff;
    overflow-x: hidden;
    line-height: 1.6;
    min-height: 100vh;
  }
  
  h1, h2, h3, h4, h5, h6 {
    margin: 0;
    font-weight: 700;
    line-height: 1.3;
  }
  
  button {
    cursor: pointer;
    font-family: inherit;
    border: none;
    outline: none;
    background: none;
  }
  
  a {
    text-decoration: none;
    color: inherit;
  }
  
  /* =====================================================
     THEME VARIABLES
  ===================================================== */
  :root {
    --bg: #000000;
    --panel: #0a0a0a;
    --card: #111111;
    --card-hover: #1a1a1a;
    --border: rgba(255, 255, 255, 0.1);
    --accent: #ffffff;
    --text: #ffffff;
    --text-muted: #aaaaaa;
    --text-light: #f5f5f5;
    --red: #ff4757;
    --green: #2ed573;
    --blue: #1e90ff;
    --yellow: #ffa502;
    --radius: 12px;
    --radius-sm: 8px;
  }
  
  /* =====================================================
     ADMIN LAYOUT
  ===================================================== */
  .admin-header {
    height: 70px;
    background: rgba(20, 20, 20, 0.95);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  .admin-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }
  
  .admin-logo i {
    font-size: 18px;
    color: var(--blue);
  }
  
  .admin-nav {
    display: flex;
    gap: 15px;
  }
  
  .admin-main {
    display: flex;
    min-height: calc(100vh - 70px);
  }
  
  .admin-sidebar {
    width: 250px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow-y: auto;
    max-height: calc(100vh - 70px);
  }
  
  .admin-content {
    flex: 1;
    padding: 20px;
    max-width: 100%;
    width: 100%;
    overflow-x: hidden;
  }
  
  /* =====================================================
     ADMIN UI COMPONENTS
  ===================================================== */
  .admin-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .admin-stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
  }
  
  .admin-stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
  }
  
  .admin-stat-label {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 8px;
    font-weight: 500;
  }
  
  .admin-section-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
  }
  
  .admin-btn {
    padding: 10px 20px;
    border-radius: var(--radius-sm);
    border: none;
    background: #222222;
    color: var(--text);
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  
  .admin-btn:hover {
    background: #333333;
  }
  
  .admin-btn.primary {
    background: var(--blue);
    color: white;
  }
  
  .admin-btn.primary:hover {
    background: #1c7ed6;
  }
  
  .admin-btn.danger {
    background: var(--red);
    color: white;
  }
  
  .admin-btn.danger:hover {
    background: #ff3838;
  }
  
  .admin-btn.success {
    background: var(--green);
    color: white;
  }
  
  .admin-btn.success:hover {
    background: #25c063;
  }
  
  .admin-btn.warning {
    background: var(--yellow);
    color: white;
  }
  
  .admin-btn.warning:hover {
    background: #e69500;
  }
  
  .admin-btn.small {
    padding: 8px 16px;
    font-size: 13px;
  }
  
  .admin-btn.xsmall {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .admin-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: transparent;
    color: var(--text-light);
    border-radius: var(--radius-sm);
    transition: all 0.2s;
    border: none;
    width: 100%;
    text-align: right;
    font-size: 14px;
    font-weight: 600;
  }
  
  .admin-menu-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--accent);
  }
  
  .admin-menu-item.active {
    background: rgba(30, 144, 255, 0.2);
    color: var(--blue);
    border-right: 3px solid var(--blue);
  }
  
  .admin-menu-item i {
    width: 20px;
    font-size: 16px;
    color: inherit;
  }
  
  /* =====================================================
     ADMIN TABLES
  ===================================================== */
  .admin-table-container {
    overflow-x: auto;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }
  
  .admin-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
  }
  
  .admin-table th {
    background: #222222;
    color: var(--text);
    font-weight: 600;
    font-size: 14px;
    padding: 12px 16px;
    text-align: right;
    border-bottom: 1px solid var(--border);
  }
  
  .admin-table td {
    padding: 12px 16px;
    font-size: 14px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    color: var(--text-light);
  }
  
  .admin-table tr:hover td {
    background: rgba(255, 255, 255, 0.02);
  }
  
  .admin-table .actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .user-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    background: rgba(30, 144, 255, 0.2);
    color: var(--blue);
  }
  
  .user-badge.admin {
    background: rgba(255, 71, 87, 0.2);
    color: var(--red);
  }
  
  /* =====================================================
     ADMIN MODALS
  ===================================================== */
  .admin-modal-overlay {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }
  
  .admin-modal {
    background: var(--panel);
    border-radius: var(--radius);
    padding: 24px;
    width: 90%;
    max-width: 700px;
    border: 1px solid var(--border);
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .admin-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .admin-modal-header h3 {
    font-size: 20px;
    color: var(--text);
  }
  
  .admin-modal-close {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-muted);
    font-size: 18px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--border);
    transition: all 0.2s;
  }
  
  .admin-modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text);
    border-color: var(--accent);
  }
  
  /* =====================================================
     ADMIN FORM ELEMENTS
  ===================================================== */
  .admin-form-group {
    margin-bottom: 20px;
  }
  
  .admin-form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text);
    font-size: 14px;
  }
  
  .admin-form-control {
    width: 100%;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
  }
  
  .admin-form-control:focus {
    outline: none;
    border-color: var(--blue);
  }
  
  /* =====================================================
     LOADING & EMPTY STATES
  ===================================================== */
  .admin-loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 60px;
  }
  
  .admin-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--blue);
    animation: admin-spin 1s linear infinite;
  }
  
  @keyframes admin-spin {
    to { transform: rotate(360deg); }
  }
  
  .admin-empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  
  .admin-empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
    color: var(--text);
  }
  
  .admin-empty-state h3 {
    font-size: 18px;
    margin-bottom: 12px;
    color: var(--text);
  }
  
  /* =====================================================
     STATS GRID
  ===================================================== */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  /* =====================================================
     USER DETAILS
  ===================================================== */
  .user-details {
    background: #222222;
    border-radius: var(--radius-sm);
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
  }
  
  .user-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }
  
  .user-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #333333;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
    color: white;
    border: 2px solid var(--border);
  }
  
  .user-info h3 {
    font-size: 18px;
    margin-bottom: 4px;
    color: var(--text);
  }
  
  .user-info .email {
    color: var(--text-muted);
    font-size: 14px;
  }
  
  /* =====================================================
     NOTIFICATION
  ===================================================== */
  .notification {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 15px 20px;
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 2000;
    max-width: 400px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease;
  }
  
  .notification.success {
    border-left: 4px solid var(--green);
  }
  
  .notification.error {
    border-left: 4px solid var(--red);
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(-100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* =====================================================
     ALL POSTS SECTION
  ===================================================== */
  .all-posts-container {
    margin-top: 20px;
  }
  
  .post-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.3s ease;
  }
  
  .post-item:hover {
    background: var(--card-hover);
    border-color: var(--blue);
  }
  
  .post-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
  }
  
  .post-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }
  
  .post-author {
    font-size: 12px;
    color: var(--text-muted);
  }
  
  .post-content {
    font-size: 14px;
    line-height: 1.5;
    color: var(--text-light);
    margin-bottom: 12px;
    max-height: 100px;
    overflow: hidden;
    position: relative;
  }
  
  .post-content.expanded {
    max-height: none;
    overflow: visible;
  }
  
  .post-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid var(--border);
  }
  
  .post-stats {
    display: flex;
    gap: 15px;
    font-size: 12px;
    color: var(--text-muted);
  }
  
  .post-actions {
    display: flex;
    gap: 8px;
  }
  
  .load-more-btn {
    width: 100%;
    padding: 12px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-weight: 600;
    margin-top: 20px;
    transition: all 0.3s ease;
  }
  
  .load-more-btn:hover {
    background: var(--card-hover);
    border-color: var(--blue);
  }
  
  .load-more-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* =====================================================
     COMMENTS SECTION
  ===================================================== */
  .comments-modal {
    max-width: 800px;
  }
  
  .comment-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 10px;
  }
  
  .comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .comment-author {
    font-weight: 600;
    font-size: 13px;
    color: var(--text);
  }
  
  .comment-date {
    font-size: 11px;
    color: var(--text-muted);
  }
  
  .comment-content {
    font-size: 13px;
    line-height: 1.5;
    color: var(--text-light);
    margin-bottom: 8px;
  }
  
  .comment-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
  
  /* =====================================================
     BAN USER FORM
  ===================================================== */
  .ban-form {
    max-width: 500px;
  }
  
  .ban-options {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .ban-option-btn {
    flex: 1;
    padding: 12px;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .ban-option-btn.active {
    background: var(--red);
    border-color: var(--red);
    color: white;
  }
  
  .ban-option-btn:hover:not(.active) {
    background: #333333;
  }
  
  /* =====================================================
     RESPONSIVE DESIGN
  ===================================================== */
  @media (max-width: 1200px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 992px) {
    .admin-sidebar {
      position: fixed;
      top: 70px;
      left: -250px;
      height: calc(100vh - 70px);
      z-index: 100;
      width: 250px;
      transition: left 0.3s;
    }
    
    .admin-sidebar.active {
      left: 0;
    }
    
    .admin-menu-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .admin-overlay {
      display: none;
      position: fixed;
      top: 70px;
      right: 0;
      width: 100%;
      height: calc(100vh - 70px);
      background: rgba(0, 0, 0, 0.8);
      z-index: 90;
    }
    
    .admin-overlay.active {
      display: block;
    }
    
    .admin-content {
      padding: 16px;
    }
  }
  
  @media (max-width: 768px) {
    .admin-header {
      padding: 0 16px;
      height: 60px;
    }
    
    .admin-logo {
      font-size: 16px;
    }
    
    .admin-logo i {
      font-size: 16px;
    }
    
    .admin-nav {
      gap: 10px;
    }
    
    .admin-btn {
      padding: 8px 16px;
      font-size: 13px;
    }
    
    .admin-section-title {
      font-size: 18px;
    }
    
    .admin-card {
      padding: 16px;
    }
    
    .admin-modal {
      padding: 16px;
      width: 95%;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .admin-stat-value {
      font-size: 28px;
    }
    
    .admin-table th,
    .admin-table td {
      padding: 10px 12px;
      font-size: 13px;
    }
    
    .post-header {
      flex-direction: column;
      gap: 8px;
    }
    
    .post-footer {
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
    }
    
    .post-actions {
      width: 100%;
      justify-content: flex-start;
    }
    
    .ban-options {
      flex-direction: column;
    }
  }
  
  @media (max-width: 576px) {
    .admin-header {
      padding: 0 12px;
    }
    
    .admin-logo span {
      font-size: 14px;
    }
    
    .admin-nav {
      gap: 8px;
    }
    
    .admin-btn {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .admin-btn span {
      display: none;
    }
    
    .admin-section-title {
      font-size: 16px;
    }
    
    .admin-card {
      padding: 14px;
    }
    
    .admin-stat-card {
      padding: 16px;
    }
    
    .admin-stat-value {
      font-size: 24px;
    }
    
    .admin-table .actions {
      flex-direction: column;
      gap: 6px;
    }
    
    .post-actions {
      flex-wrap: wrap;
    }
  }
  
  /* =====================================================
     PAGINATION
  ===================================================== */
  .admin-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }
  
  .pagination-btn {
    padding: 8px 16px;
    background: #222222;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    min-width: 40px;
    text-align: center;
  }
  
  .pagination-btn:hover:not(:disabled) {
    background: #333333;
    border-color: var(--blue);
  }
  
  .pagination-btn.active {
    background: var(--blue);
    border-color: var(--blue);
    color: white;
  }
  
  .pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* =====================================================
     FILTERS
  ===================================================== */
  .admin-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .filter-input {
    flex: 1;
    min-width: 200px;
  }
  
  .filter-select {
    width: 150px;
  }
  
  /* =====================================================
     SEARCH RESULTS
  ===================================================== */
  .search-results {
    margin-top: 20px;
  }
  
  .search-result-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 12px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .search-result-info h4 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }
  
  .search-result-info p {
    font-size: 12px;
    color: var(--text-muted);
  }
  </style>
</head>
<body>
  <!-- ================= ADMIN HEADER ================= -->
  <header class="admin-header">
    <div class="admin-logo">
      <i class="fas fa-shield-alt"></i>
      <span>لوحة تحكم المشرف</span>
    </div>
    
    <div class="admin-nav">
      <button class="admin-btn" onclick="location.href='index.html'">
        <i class="fas fa-home"></i>
        <span>الرئيسية</span>
      </button>
      <button class="admin-btn danger" id="adminLogoutBtn">
        <i class="fas fa-sign-out-alt"></i>
        <span>تسجيل خروج</span>
      </button>
    </div>
  </header>
  
  <!-- ================= ADMIN MAIN ================= -->
  <div class="admin-main">
    <!-- ================= SIDEBAR ================= -->
    <div class="admin-sidebar" id="adminSidebar">
      <div class="admin-menu-item active" onclick="showAdminSection('dashboard')">
        <i class="fas fa-tachometer-alt"></i>
        <span>لوحة التحكم</span>
      </div>
      
      <div class="admin-menu-item" onclick="showAdminSection('articles')">
        <i class="fas fa-newspaper"></i>
        <span>إدارة المقالات</span>
      </div>
      
      <div class="admin-menu-item" onclick="showAdminSection('allPosts')">
        <i class="fas fa-stream"></i>
        <span>جميع المنشورات</span>
      </div>
      
      <div class="admin-menu-item" onclick="showAdminSection('users')">
        <i class="fas fa-users"></i>
        <span>إدارة المستخدمين</span>
      </div>
      
      <div class="admin-menu-item" onclick="showAdminSection('banUser')">
        <i class="fas fa-ban"></i>
        <span>حظر مستخدم</span>
      </div>
      
      <div class="admin-menu-item" onclick="showAdminSection('reports')">
        <i class="fas fa-chart-bar"></i>
        <span>التقارير والإحصائيات</span>
      </div>
      
      <div class="admin-menu-item" onclick="showAdminSection('settings')">
        <i class="fas fa-cog"></i>
        <span>الإعدادات</span>
      </div>
    </div>
    
    <div class="admin-overlay" id="adminOverlay" onclick="toggleAdminSidebar()"></div>
    
    <!-- ================= MAIN CONTENT ================= -->
    <main class="admin-content">
      <!-- لوحة التحكم -->
      <div id="dashboardSection" class="admin-section">
        <h2 class="admin-section-title"><i class="fas fa-tachometer-alt"></i> لوحة التحكم</h2>
        
        <div class="stats-grid" id="statsGrid">
          <div class="admin-stat-card">
            <div class="admin-stat-value" id="totalUsers">0</div>
            <div class="admin-stat-label">إجمالي المستخدمين</div>
          </div>
          
          <div class="admin-stat-card">
            <div class="admin-stat-value" id="totalArticles">0</div>
            <div class="admin-stat-label">إجمالي المقالات</div>
          </div>
          
          <div class="admin-stat-card">
            <div class="admin-stat-value" id="totalComments">0</div>
            <div class="admin-stat-label">إجمالي التعليقات</div>
          </div>
          
          <div class="admin-stat-card">
            <div class="admin-stat-value" id="totalLikes">0</div>
            <div class="admin-stat-label">إجمالي الإعجابات</div>
          </div>
        </div>
        
        <div class="admin-card">
          <h3><i class="fas fa-chart-line"></i> النشاط اليومي</h3>
          <div id="dailyActivity">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
            </div>
          </div>
        </div>
        
        <div class="admin-card">
          <h3><i class="fas fa-fire"></i> المقالات الأكثر شعبية</h3>
          <div id="popularArticles">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- إدارة المقالات -->
      <div id="articlesSection" class="admin-section" style="display: none;">
        <div class="admin-section-header">
          <h2 class="admin-section-title"><i class="fas fa-newspaper"></i> إدارة المقالات</h2>
          <div class="admin-filters">
            <input type="text" class="admin-form-control filter-input" id="articleSearch" placeholder="بحث في المقالات...">
            <select class="admin-form-control filter-select" id="articleFilter">
              <option value="all">جميع المقالات</option>
              <option value="recent">الأحدث</option>
              <option value="popular">الأكثر شعبية</option>
              <option value="flagged">المبلغ عنها</option>
            </select>
          </div>
        </div>
        
        <div class="admin-table-container">
          <table class="admin-table" id="articlesTable">
            <thead>
              <tr>
                <th>#</th>
                <th>العنوان</th>
                <th>الناشر</th>
                <th>التاريخ</th>
                <th>الإعجابات</th>
                <th>التعليقات</th>
                <th>المشاهدات</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="articlesTableBody">
              <tr>
                <td colspan="8" class="admin-loading">
                  <div class="admin-spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="admin-pagination" id="articlesPagination">
          <!-- سيتم إنشاء أزرار الترقيم هنا -->
        </div>
      </div>
      
      <!-- جميع المنشورات -->
      <div id="allPostsSection" class="admin-section" style="display: none;">
        <div class="admin-section-header">
          <h2 class="admin-section-title"><i class="fas fa-stream"></i> جميع المنشورات</h2>
          <div class="admin-filters">
            <input type="text" class="admin-form-control filter-input" id="allPostsSearch" placeholder="بحث في المنشورات...">
            <select class="admin-form-control filter-select" id="allPostsFilter">
              <option value="all">جميع المنشورات</option>
              <option value="recent">الأحدث</option>
              <option value="popular">الأكثر شعبية</option>
            </select>
          </div>
        </div>
        
        <div class="all-posts-container" id="allPostsContainer">
          <div class="admin-loading">
            <div class="admin-spinner"></div>
          </div>
        </div>
        
        <button class="load-more-btn" id="loadMorePostsBtn" onclick="loadMorePosts()" style="display: none;">
          <i class="fas fa-arrow-down"></i>
          <span>تحميل المزيد</span>
        </button>
      </div>
      
      <!-- إدارة المستخدمين -->
      <div id="usersSection" class="admin-section" style="display: none;">
        <div class="admin-section-header">
          <h2 class="admin-section-title"><i class="fas fa-users"></i> إدارة المستخدمين</h2>
          <div class="admin-filters">
            <input type="text" class="admin-form-control filter-input" id="userSearch" placeholder="بحث في المستخدمين...">
            <button class="admin-btn primary" onclick="openCreateUserModal()">
              <i class="fas fa-user-plus"></i>
              <span>مستخدم جديد</span>
            </button>
          </div>
        </div>
        
        <div class="admin-table-container">
          <table class="admin-table" id="usersTable">
            <thead>
              <tr>
                <th>#</th>
                <th>اسم المستخدم</th>
                <th>البريد الإلكتروني</th>
                <th>تاريخ الانضمام</th>
                <th>المقالات</th>
                <th>آخر نشاط</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="8" class="admin-loading">
                  <div class="admin-spinner"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="admin-pagination" id="usersPagination">
          <!-- سيتم إنشاء أزرار الترقيم هنا -->
        </div>
      </div>
      
      <!-- حظر المستخدم -->
      <div id="banUserSection" class="admin-section" style="display: none;">
        <h2 class="admin-section-title"><i class="fas fa-ban"></i> حظر مستخدم</h2>
        
        <div class="admin-card ban-form">
          <h3><i class="fas fa-user-slash"></i> حظر مستخدم باستخدام UID أو البريد الإلكتروني</h3>
          
          <div class="ban-options">
            <button class="ban-option-btn active" id="banByUIDBtn" onclick="setBanOption('uid')">
              <i class="fas fa-id-card"></i>
              <span>حسب UID</span>
            </button>
            <button class="ban-option-btn" id="banByEmailBtn" onclick="setBanOption('email')">
              <i class="fas fa-envelope"></i>
              <span>حسب البريد الإلكتروني</span>
            </button>
            <button class="ban-option-btn" id="searchUserBtn" onclick="setBanOption('search')">
              <i class="fas fa-search"></i>
              <span>بحث عن مستخدم</span>
            </button>
          </div>
          
          <div id="banUIDForm">
            <div class="admin-form-group">
              <label>رقم تعريف المستخدم (UID)</label>
              <input type="text" class="admin-form-control" id="banUserUID" placeholder="أدخل UID المستخدم">
            </div>
            
            <div class="admin-form-group">
              <label>سبب الحظر</label>
              <select class="admin-form-control" id="banReason">
                <option value="spam">نشر محتوى غير مرغوب</option>
                <option value="abuse">إساءة استخدام النظام</option>
                <option value="violation">انتهاك الشروط</option>
                <option value="other">سبب آخر</option>
              </select>
            </div>
            
            <div class="admin-form-group">
              <label>مدة الحظر</label>
              <select class="admin-form-control" id="banDuration">
                <option value="1">يوم واحد</option>
                <option value="7">أسبوع</option>
                <option value="30">شهر</option>
                <option value="365">سنة</option>
                <option value="permanent">حظر دائم</option>
              </select>
            </div>
            
            <div class="admin-form-group">
              <label>ملاحظات إضافية</label>
              <textarea class="admin-form-control" id="banNotes" rows="3" placeholder="تفاصيل إضافية عن سبب الحظر"></textarea>
            </div>
            
            <button class="admin-btn danger" onclick="banUserByUID()">
              <i class="fas fa-ban"></i>
              <span>حظر المستخدم</span>
            </button>
          </div>
          
          <div id="banEmailForm" style="display: none;">
            <div class="admin-form-group">
              <label>البريد الإلكتروني للمستخدم</label>
              <input type="email" class="admin-form-control" id="banUserEmail" placeholder="example@domain.com">
            </div>
            
            <div class="admin-form-group">
              <label>سبب الحظر</label>
              <select class="admin-form-control" id="banReasonEmail">
                <option value="spam">نشر محتوى غير مرغوب</option>
                <option value="abuse">إساءة استخدام النظام</option>
                <option value="violation">انتهاك الشروط</option>
                <option value="other">سبب آخر</option>
              </select>
            </div>
            
            <div class="admin-form-group">
              <label>مدة الحظر</label>
              <select class="admin-form-control" id="banDurationEmail">
                <option value="1">يوم واحد</option>
                <option value="7">أسبوع</option>
                <option value="30">شهر</option>
                <option value="365">سنة</option>
                <option value="permanent">حظر دائم</option>
              </select>
            </div>
            
            <div class="admin-form-group">
              <label>ملاحظات إضافية</label>
              <textarea class="admin-form-control" id="banNotesEmail" rows="3" placeholder="تفاصيل إضافية عن سبب الحظر"></textarea>
            </div>
            
            <button class="admin-btn danger" onclick="banUserByEmail()">
              <i class="fas fa-ban"></i>
              <span>حظر المستخدم</span>
            </button>
          </div>
          
          <div id="searchUserForm" style="display: none;">
            <div class="admin-form-group">
              <label>بحث عن مستخدم</label>
              <input type="text" class="admin-form-control" id="searchUserInput" placeholder="أدخل اسم المستخدم أو البريد الإلكتروني">
              <button class="admin-btn" onclick="searchUser()" style="margin-top: 10px;">
                <i class="fas fa-search"></i>
                <span>بحث</span>
              </button>
            </div>
            
            <div class="search-results" id="userSearchResults">
              <!-- نتائج البحث ستظهر هنا -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- التقارير والإحصائيات -->
      <div id="reportsSection" class="admin-section" style="display: none;">
        <h2 class="admin-section-title"><i class="fas fa-chart-bar"></i> التقارير والإحصائيات</h2>
        
        <div class="admin-card">
          <h3><i class="fas fa-calendar-alt"></i> إحصائيات الشهر</h3>
          <div id="monthlyStats">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
            </div>
          </div>
        </div>
        
        <div class="admin-card">
          <h3><i class="fas fa-user-chart"></i> أعلى المستخدمين نشاطاً</h3>
          <div id="topUsers">
            <div class="admin-loading">
              <div class="admin-spinner"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- الإعدادات -->
      <div id="settingsSection" class="admin-section" style="display: none;">
        <h2 class="admin-section-title"><i class="fas fa-cog"></i> إعدادات النظام</h2>
        
        <div class="admin-card">
          <h3><i class="fas fa-sliders-h"></i> الإعدادات العامة</h3>
          
          <div class="admin-form-group">
            <label>عنوان الموقع</label>
            <input type="text" class="admin-form-control" id="siteTitle" value="منتدى الريدبيل">
          </div>
          
          <div class="admin-form-group">
            <label>وصف الموقع</label>
            <textarea class="admin-form-control" id="siteDescription" rows="3">منتدى متخصص للمناقشات والأفكار</textarea>
          </div>
          
          <div class="admin-form-group">
            <label>فترة التبريد للمقالات (ساعات)</label>
            <input type="number" class="admin-form-control" id="articleCooldown" value="1" min="0.5" max="24" step="0.5">
          </div>
          
          <div class="admin-form-group">
            <label>فترة التبريد للتعليقات (دقائق)</label>
            <input type="number" class="admin-form-control" id="commentCooldown" value="1" min="0.5" max="60" step="0.5">
          </div>
          
          <button class="admin-btn success" onclick="saveSettings()">
            <i class="fas fa-save"></i>
            <span>حفظ الإعدادات</span>
          </button>
        </div>
      </div>
    </main>
  </div>
  
  <!-- ================= MODAL: ARTICLE DETAILS ================= -->
  <div class="admin-modal-overlay" id="articleDetailsModal">
    <div class="admin-modal">
      <div class="admin-modal-header">
        <h3><i class="fas fa-file-alt"></i> تفاصيل المقال</h3>
        <button class="admin-modal-close" onclick="closeArticleDetailsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="admin-modal-content">
        <div id="articleDetailsContent">
          <!-- سيتم تحميل تفاصيل المقال هنا -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= MODAL: USER DETAILS ================= -->
  <div class="admin-modal-overlay" id="userDetailsModal">
    <div class="admin-modal">
      <div class="admin-modal-header">
        <h3><i class="fas fa-user"></i> تفاصيل المستخدم</h3>
        <button class="admin-modal-close" onclick="closeUserDetailsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="admin-modal-content">
        <div id="userDetailsContent">
          <!-- سيتم تحميل تفاصيل المستخدم هنا -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= MODAL: EDIT ARTICLE ================= -->
  <div class="admin-modal-overlay" id="editArticleModal">
    <div class="admin-modal">
      <div class="admin-modal-header">
        <h3><i class="fas fa-edit"></i> تعديل المقال</h3>
        <button class="admin-modal-close" onclick="closeEditArticleModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="admin-modal-content">
        <div id="editArticleContent">
          <!-- سيتم تحميل نموذج التعديل هنا -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= MODAL: CREATE USER ================= -->
  <div class="admin-modal-overlay" id="createUserModal">
    <div class="admin-modal">
      <div class="admin-modal-header">
        <h3><i class="fas fa-user-plus"></i> إنشاء مستخدم جديد</h3>
        <button class="admin-modal-close" onclick="closeCreateUserModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="admin-modal-content">
        <div class="admin-form-group">
          <label>البريد الإلكتروني</label>
          <input type="email" class="admin-form-control" id="newUserEmail" placeholder="example@domain.com">
        </div>
        
        <div class="admin-form-group">
          <label>كلمة المرور</label>
          <input type="password" class="admin-form-control" id="newUserPassword" placeholder="6 أحرف على الأقل">
        </div>
        
        <div class="admin-form-group">
          <label>اسم المستخدم</label>
          <input type="text" class="admin-form-control" id="newUsername" placeholder="اسم المستخدم">
        </div>
        
        <div class="admin-form-group">
          <label>صلاحيات المستخدم</label>
          <select class="admin-form-control" id="newUserRole">
            <option value="user">مستخدم عادي</option>
            <option value="admin">مشرف</option>
            <option value="moderator">مراقب</option>
          </select>
        </div>
        
        <div class="admin-form-group">
          <button class="admin-btn primary" onclick="createNewUser()" id="createUserBtn">
            <i class="fas fa-user-plus"></i>
            <span>إنشاء الحساب</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= MODAL: CONFIRM DELETE ================= -->
  <div class="admin-modal-overlay" id="confirmDeleteModal">
    <div class="admin-modal" style="max-width: 400px;">
      <div class="admin-modal-header">
        <h3><i class="fas fa-exclamation-triangle"></i> تأكيد الحذف</h3>
        <button class="admin-modal-close" onclick="closeConfirmDeleteModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="admin-modal-content">
        <p id="deleteMessage">هل أنت متأكد من حذف هذا العنصر؟</p>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="admin-btn danger" id="confirmDeleteBtn">
            <i class="fas fa-trash"></i>
            <span>نعم، احذف</span>
          </button>
          <button class="admin-btn" onclick="closeConfirmDeleteModal()">
            <i class="fas fa-times"></i>
            <span>إلغاء</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ================= MODAL: POST COMMENTS ================= -->
  <div class="admin-modal-overlay" id="postCommentsModal">
    <div class="admin-modal comments-modal">
      <div class="admin-modal-header">
        <h3><i class="fas fa-comments"></i> تعليقات المنشور</h3>
        <button class="admin-modal-close" onclick="closePostCommentsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="admin-modal-content">
        <div id="postCommentsContent">
          <!-- سيتم تحميل التعليقات هنا -->
        </div>
        
        <button class="load-more-btn" id="loadMoreCommentsBtn" onclick="loadMoreComments()" style="display: none; margin-top: 20px;">
          <i class="fas fa-arrow-down"></i>
          <span>تحميل المزيد من التعليقات</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ================= ADMIN NOTIFICATION ================= -->
  <div class="notification" id="adminNotification">
    <i class="fas fa-check-circle" id="adminNotificationIcon"></i>
    <span id="adminNotificationText"></span>
  </div>

  <script type="module">
  /* =====================================================
     FIREBASE IMPORTS
  ===================================================== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signOut,
    createUserWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { 
    getDatabase, 
    ref, 
    onValue, 
    update, 
    get, 
    set, 
    remove, 
    query, 
    orderByChild, 
    limitToLast,
    limitToFirst,
    startAt,
    orderByKey,
    equalTo
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
  
  /* =====================================================
     CONFIG
  ===================================================== */
  const firebaseConfig = {
    apiKey: "AIzaSyCdoubvkI7VEvYxtG3CzKFAJg74XXl7fX4",
    authDomain: "redpill-1c7e2.firebaseapp.com",
    databaseURL: "https://redpill-1c7e2-default-rtdb.firebaseio.com",
    projectId: "redpill-1c7e2",
    storageBucket: "redpill-1c7e2.firebasestorage.app",
    messagingSenderId: "337690521778",
    appId: "1:337690521778:web:ba3c99ad55e6b0d58f59ab"
  };
  
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  
  // DOM Elements
  const adminLogoutBtn = document.getElementById('adminLogoutBtn');
  const adminSidebar = document.getElementById('adminSidebar');
  const adminOverlay = document.getElementById('adminOverlay');
  
  // Admin sections
  const dashboardSection = document.getElementById('dashboardSection');
  const articlesSection = document.getElementById('articlesSection');
  const allPostsSection = document.getElementById('allPostsSection');
  const usersSection = document.getElementById('usersSection');
  const banUserSection = document.getElementById('banUserSection');
  const reportsSection = document.getElementById('reportsSection');
  const settingsSection = document.getElementById('settingsSection');
  
  // Stats elements
  const totalUsers = document.getElementById('totalUsers');
  const totalArticles = document.getElementById('totalArticles');
  const totalComments = document.getElementById('totalComments');
  const totalLikes = document.getElementById('totalLikes');
  
  // Table elements
  const articlesTableBody = document.getElementById('articlesTableBody');
  const usersTableBody = document.getElementById('usersTableBody');
  
  // All posts elements
  const allPostsContainer = document.getElementById('allPostsContainer');
  const loadMorePostsBtn = document.getElementById('loadMorePostsBtn');
  
  // Comments modal elements
  const postCommentsModal = document.getElementById('postCommentsModal');
  const loadMoreCommentsBtn = document.getElementById('loadMoreCommentsBtn');
  
  // Pagination elements
  const articlesPagination = document.getElementById('articlesPagination');
  const usersPagination = document.getElementById('usersPagination');
  
  // Modal elements
  const articleDetailsModal = document.getElementById('articleDetailsModal');
  const userDetailsModal = document.getElementById('userDetailsModal');
  const editArticleModal = document.getElementById('editArticleModal');
  const createUserModal = document.getElementById('createUserModal');
  const confirmDeleteModal = document.getElementById('confirmDeleteModal');
  
  // Ban user elements
  const banUIDForm = document.getElementById('banUIDForm');
  const banEmailForm = document.getElementById('banEmailForm');
  const searchUserForm = document.getElementById('searchUserForm');
  const userSearchResults = document.getElementById('userSearchResults');
  
  // Notification
  const adminNotification = document.getElementById('adminNotification');
  const adminNotificationIcon = document.getElementById('adminNotificationIcon');
  const adminNotificationText = document.getElementById('adminNotificationText');
  
  // Global variables
  let currentAdmin = null;
  let currentArticlePage = 1;
  let currentUserPage = 1;
  let articlesPerPage = 10;
  let usersPerPage = 10;
  let totalArticlesCount = 0;
  let totalUsersCount = 0;
  
  // All posts variables
  let allPosts = [];
  let allPostsStartAt = 0;
  let allPostsLimit = 10;
  let currentPostComments = [];
  let currentPostId = null;
  let currentPostCommentsStartAt = 0;
  let currentPostCommentsLimit = 10;
  
  // Admin user ID (يجب أن يتطابق مع UID المحدد في قواعد الأمان)
  const ADMIN_USER_ID = 't3QsyZbU0UcxGwbLSOeFaclDCja2';
  
  /* =====================================================
     ADMIN AUTHENTICATION
  ===================================================== */
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      // التحقق إذا كان المستخدم مشرفاً
      if (user.uid === ADMIN_USER_ID) {
        currentAdmin = user;
        console.log('تم تسجيل دخول المشرف:', user.uid);
        loadDashboardStats();
        loadArticlesTable();
        loadUsersTable();
      } else {
        showAdminNotification('ليس لديك صلاحية الدخول إلى لوحة التحكم', 'error');
        setTimeout(() => {
          location.href = 'index.html';
        }, 2000);
      }
    } else {
      // إذا لم يكن مسجلاً، إعادة التوجيه إلى الصفحة الرئيسية
      showAdminNotification('يجب تسجيل الدخول أولاً', 'error');
      setTimeout(() => {
        location.href = 'index.html';
      }, 1500);
    }
  });
  
  adminLogoutBtn.addEventListener('click', () => {
    signOut(auth).then(() => {
      location.href = 'index.html';
    });
  });
  
  /* =====================================================
     ADMIN NAVIGATION
  ===================================================== */
  window.showAdminSection = (sectionName) => {
    // إخفاء جميع الأقسام
    dashboardSection.style.display = 'none';
    articlesSection.style.display = 'none';
    allPostsSection.style.display = 'none';
    usersSection.style.display = 'none';
    banUserSection.style.display = 'none';
    reportsSection.style.display = 'none';
    settingsSection.style.display = 'none';
    
    // إزالة النشاط من جميع عناصر القائمة
    document.querySelectorAll('.admin-menu-item').forEach(item => {
      item.classList.remove('active');
    });
    
    // إظهار القسم المحدد وإضافة النشاط لعنصر القائمة
    switch(sectionName) {
      case 'dashboard':
        dashboardSection.style.display = 'block';
        document.querySelector('.admin-menu-item:nth-child(1)').classList.add('active');
        loadDashboardStats();
        break;
      case 'articles':
        articlesSection.style.display = 'block';
        document.querySelector('.admin-menu-item:nth-child(2)').classList.add('active');
        currentArticlePage = 1;
        loadArticlesTable();
        break;
      case 'allPosts':
        allPostsSection.style.display = 'block';
        document.querySelector('.admin-menu-item:nth-child(3)').classList.add('active');
        loadAllPosts();
        break;
      case 'users':
        usersSection.style.display = 'block';
        document.querySelector('.admin-menu-item:nth-child(4)').classList.add('active');
        currentUserPage = 1;
        loadUsersTable();
        break;
      case 'banUser':
        banUserSection.style.display = 'block';
        document.querySelector('.admin-menu-item:nth-child(5)').classList.add('active');
        setBanOption('uid');
        break;
      case 'reports':
        reportsSection.style.display = 'block';
        document.querySelector('.admin-menu-item:nth-child(6)').classList.add('active');
        loadReports();
        break;
      case 'settings':
        settingsSection.style.display = 'block';
        document.querySelector('.admin-menu-item:nth-child(7)').classList.add('active');
        break;
    }
    
    closeAdminSidebar();
  };
  
  /* =====================================================
     SIDEBAR FUNCTIONS (للشاشات الصغيرة)
  ===================================================== */
  function toggleAdminSidebar() {
    adminSidebar.classList.toggle('active');
    adminOverlay.classList.toggle('active');
  }
  
  function closeAdminSidebar() {
    if (window.innerWidth <= 992) {
      adminSidebar.classList.remove('active');
      adminOverlay.classList.remove('active');
    }
  }
  
  adminOverlay.addEventListener('click', closeAdminSidebar);
  
  window.addEventListener('resize', () => {
    if (window.innerWidth > 992) {
      adminSidebar.classList.remove('active');
      adminOverlay.classList.remove('active');
    }
  });
  
  /* =====================================================
     DASHBOARD STATISTICS
  ===================================================== */
  async function loadDashboardStats() {
    try {
      // تحميل إحصائيات المستخدمين
      const usersRef = ref(db, 'users');
      onValue(usersRef, (snap) => {
        if (snap.exists()) {
          totalUsersCount = Object.keys(snap.val()).length;
          totalUsers.textContent = totalUsersCount;
        } else {
          totalUsersCount = 0;
          totalUsers.textContent = '0';
        }
      }, { onlyOnce: true });
      
      // تحميل إحصائيات المقالات
      const articlesRef = ref(db, 'articles');
      onValue(articlesRef, (snap) => {
        if (snap.exists()) {
          totalArticlesCount = Object.keys(snap.val()).length;
          totalArticles.textContent = totalArticlesCount;
        } else {
          totalArticlesCount = 0;
          totalArticles.textContent = '0';
        }
      }, { onlyOnce: true });
      
      // تحميل إحصائيات التعليقات
      const commentsRef = ref(db, 'comments');
      onValue(commentsRef, (snap) => {
        if (snap.exists()) {
          let commentsCount = 0;
          snap.forEach(category => {
            if (category.val()) {
              commentsCount += Object.keys(category.val()).length;
            }
          });
          totalComments.textContent = commentsCount;
        } else {
          totalComments.textContent = '0';
        }
      }, { onlyOnce: true });
      
      // تحميل إحصائيات الإعجابات
      const likesRef = ref(db, 'likes');
      onValue(likesRef, (snap) => {
        if (snap.exists()) {
          let likesCount = 0;
          snap.forEach(article => {
            if (article.val()) {
              likesCount += Object.keys(article.val()).length;
            }
          });
          totalLikes.textContent = likesCount;
        } else {
          totalLikes.textContent = '0';
        }
      }, { onlyOnce: true });
      
      // تحميل المقالات الشائعة
      loadPopularArticles();
      
      // تحميل النشاط اليومي
      loadDailyActivity();
      
    } catch (error) {
      console.error('Error loading dashboard stats:', error);
      showAdminNotification('حدث خطأ في تحميل الإحصائيات', 'error');
    }
  }
  
  async function loadPopularArticles() {
    try {
      const articlesRef = ref(db, 'articles');
      const articlesQuery = query(articlesRef, orderByChild('likesCount'), limitToLast(5));
      
      get(articlesQuery).then((snap) => {
        const popularArticlesDiv = document.getElementById('popularArticles');
        popularArticlesDiv.innerHTML = '';
        
        if (!snap.exists()) {
          popularArticlesDiv.innerHTML = '<div class="admin-empty-state"><p>لا توجد مقالات بعد</p></div>';
          return;
        }
        
        const articles = [];
        snap.forEach(articleSnap => {
          articles.push({
            id: articleSnap.key,
            ...articleSnap.val()
          });
        });
        
        // ترتيب تنازلي حسب الإعجابات
        articles.sort((a, b) => (b.likesCount || 0) - (a.likesCount || 0));
        
        let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
        articles.forEach(article => {
          html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: var(--radius-sm);">
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 14px;">${article.title || 'عنوان غير محدد'}</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                  ${formatDate(article.created)} • ${article.likesCount || 0} إعجاب
                </div>
              </div>
              <div>
                <button class="admin-btn xsmall" onclick="viewArticleDetails('${article.id}')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          `;
        });
        html += '</div>';
        
        popularArticlesDiv.innerHTML = html;
      }).catch(error => {
        console.error('Error loading popular articles:', error);
        document.getElementById('popularArticles').innerHTML = '<div class="admin-empty-state"><p>حدث خطأ في تحميل المقالات</p></div>';
      });
      
    } catch (error) {
      console.error('Error loading popular articles:', error);
    }
  }
  
  async function loadDailyActivity() {
    const dailyActivityDiv = document.getElementById('dailyActivity');
    
    try {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayTimestamp = today.getTime();
      
      // جلب المقالات المنشورة اليوم
      const articlesRef = ref(db, 'articles');
      const articlesQuery = query(articlesRef, orderByChild('created'), startAt(todayTimestamp));
      
      get(articlesQuery).then((articlesSnap) => {
        const articlesToday = articlesSnap.exists() ? Object.keys(articlesSnap.val()).length : 0;
        
        // جلب المستخدمين الجدد اليوم
        const usersRef = ref(db, 'users');
        get(usersRef).then((usersSnap) => {
          let usersToday = 0;
          if (usersSnap.exists()) {
            usersSnap.forEach(user => {
              if (user.val().joinDate >= todayTimestamp) {
                usersToday++;
              }
            });
          }
          
          dailyActivityDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
              <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--green);">${articlesToday}</div>
                <div style="font-size: 13px; color: var(--text-muted); margin-top: 5px;">مقالات جديدة</div>
              </div>
              <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--blue);">${usersToday}</div>
                <div style="font-size: 13px; color: var(--text-muted); margin-top: 5px;">مستخدمين جدد</div>
              </div>
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
              <div style="font-size: 13px; color: var(--text-muted);">آخر تحديث: ${new Date().toLocaleTimeString('ar-SA')}</div>
            </div>
          `;
        });
      }).catch(error => {
        dailyActivityDiv.innerHTML = '<div class="admin-empty-state"><p>حدث خطأ في تحميل النشاط اليومي</p></div>';
      });
      
    } catch (error) {
      dailyActivityDiv.innerHTML = '<div class="admin-empty-state"><p>حدث خطأ في تحميل النشاط اليومي</p></div>';
    }
  }
  
  /* =====================================================
     ARTICLES MANAGEMENT
  ===================================================== */
  async function loadArticlesTable(page = 1) {
    try {
      articlesTableBody.innerHTML = '<tr><td colspan="8" class="admin-loading"><div class="admin-spinner"></div></td></tr>';
      
      const articlesRef = ref(db, 'articles');
      const articlesQuery = query(articlesRef, orderByChild('created'));
      
      get(articlesQuery).then(async (snap) => {
        if (!snap.exists()) {
          articlesTableBody.innerHTML = '<tr><td colspan="8" class="admin-empty-state"><p>لا توجد مقالات</p></td></tr>';
          return;
        }
        
        const allArticles = [];
        snap.forEach(articleSnap => {
          const article = {
            id: articleSnap.key,
            ...articleSnap.val()
          };
          allArticles.push(article);
        });
        
        // ترتيب تنازلي حسب التاريخ
        allArticles.sort((a, b) => b.created - a.created);
        totalArticlesCount = allArticles.length;
        
        // التصفية حسب البحث
        const searchTerm = document.getElementById('articleSearch').value.toLowerCase();
        const filterType = document.getElementById('articleFilter').value;
        
        let filteredArticles = allArticles;
        
        if (searchTerm) {
          filteredArticles = allArticles.filter(article => 
            (article.title && article.title.toLowerCase().includes(searchTerm)) ||
            (article.content && article.content.toLowerCase().includes(searchTerm))
          );
        }
        
        if (filterType === 'popular') {
          filteredArticles.sort((a, b) => (b.likesCount || 0) - (a.likesCount || 0));
        } else if (filterType === 'recent') {
          filteredArticles.sort((a, b) => b.created - a.created);
        }
        
        // حساب الترقيم
        const totalPages = Math.ceil(filteredArticles.length / articlesPerPage);
        const startIndex = (page - 1) * articlesPerPage;
        const endIndex = startIndex + articlesPerPage;
        const pageArticles = filteredArticles.slice(startIndex, endIndex);
        
        // عرض المقالات
        articlesTableBody.innerHTML = '';
        
        if (pageArticles.length === 0) {
          articlesTableBody.innerHTML = '<tr><td colspan="8" class="admin-empty-state"><p>لا توجد مقالات</p></td></tr>';
          createPagination(articlesPagination, page, totalPages, 'articles');
          return;
        }
        
        let counter = startIndex + 1;
        for (const article of pageArticles) {
          const userData = await getUserData(article.author);
          const username = userData ? userData.username : 'مجهول';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${counter}</td>
            <td>
              <div style="font-weight: 600; font-size: 13px;">${article.title || 'عنوان غير محدد'}</div>
              <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                ${article.category || 'غير مصنف'} • ${article.readTime || '1'} دقيقة قراءة
              </div>
            </td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 30px; height: 30px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center;">
                  ${username[0] || '?'}
                </div>
                <span style="font-size: 13px;">${username}</span>
              </div>
            </td>
            <td>${formatShortDate(article.created)}</td>
            <td><span class="user-badge">${article.likesCount || 0}</span></td>
            <td><span class="user-badge">${article.commentsCount || 0}</span></td>
            <td><span class="user-badge">${article.viewsCount || 0}</span></td>
            <td>
              <div class="actions">
                <button class="admin-btn xsmall primary" onclick="viewArticleDetails('${article.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="admin-btn xsmall warning" onclick="editArticle('${article.id}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="admin-btn xsmall danger" onclick="confirmDeleteArticle('${article.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          `;
          articlesTableBody.appendChild(row);
          counter++;
        }
        
        // إنشاء أزرار الترقيم
        createPagination(articlesPagination, page, totalPages, 'articles');
        
      }).catch(error => {
        console.error('Error loading articles table:', error);
        showAdminNotification('حدث خطأ في تحميل المقالات', 'error');
        articlesTableBody.innerHTML = '<tr><td colspan="8" class="admin-empty-state"><p>حدث خطأ في تحميل المقالات</p></td></tr>';
      });
      
    } catch (error) {
      console.error('Error loading articles table:', error);
      showAdminNotification('حدث خطأ في تحميل المقالات', 'error');
    }
  }
  
  // إضافة مستمعات للبحث والتصفية
  document.getElementById('articleSearch').addEventListener('input', () => {
    currentArticlePage = 1;
    loadArticlesTable(1);
  });
  
  document.getElementById('articleFilter').addEventListener('change', () => {
    currentArticlePage = 1;
    loadArticlesTable(1);
  });
  
  /* =====================================================
     ALL POSTS MANAGEMENT
  ===================================================== */
  async function loadAllPosts() {
    try {
      allPostsContainer.innerHTML = '<div class="admin-loading"><div class="admin-spinner"></div></div>';
      allPostsStartAt = 0;
      allPosts = [];
      
      const articlesRef = ref(db, 'articles');
      const articlesQuery = query(articlesRef, orderByChild('created'), limitToFirst(allPostsLimit));
      
      get(articlesQuery).then(async (snap) => {
        if (!snap.exists()) {
          allPostsContainer.innerHTML = '<div class="admin-empty-state"><p>لا توجد منشورات</p></div>';
          loadMorePostsBtn.style.display = 'none';
          return;
        }
        
        allPosts = [];
        snap.forEach(articleSnap => {
          const article = {
            id: articleSnap.key,
            ...articleSnap.val()
          };
          allPosts.push(article);
        });
        
        // ترتيب تنازلي حسب التاريخ
        allPosts.sort((a, b) => b.created - a.created);
        
        displayAllPosts();
        
        // التحقق إذا كان هناك المزيد من المنشورات
        if (allPosts.length >= allPostsLimit) {
          loadMorePostsBtn.style.display = 'block';
        } else {
          loadMorePostsBtn.style.display = 'none';
        }
        
      }).catch(error => {
        console.error('Error loading all posts:', error);
        showAdminNotification('حدث خطأ في تحميل المنشورات', 'error');
        allPostsContainer.innerHTML = '<div class="admin-empty-state"><p>حدث خطأ في تحميل المنشورات</p></div>';
      });
      
    } catch (error) {
      console.error('Error loading all posts:', error);
      showAdminNotification('حدث خطأ في تحميل المنشورات', 'error');
    }
  }
  
  async function displayAllPosts() {
    if (allPosts.length === 0) {
      allPostsContainer.innerHTML = '<div class="admin-empty-state"><p>لا توجد منشورات</p></div>';
      return;
    }
    
    let html = '';
    
    for (const post of allPosts) {
      const userData = await getUserData(post.author);
      const username = userData ? userData.username : 'مجهول';
      
      // تقصير المحتوى إذا كان طويلاً
      let content = post.content || 'لا يوجد محتوى';
      if (content.length > 200) {
        content = content.substring(0, 200) + '...';
      }
      
      html += `
        <div class="post-item" id="post-${post.id}">
          <div class="post-header">
            <div>
              <div class="post-title">${post.title || 'عنوان غير محدد'}</div>
              <div class="post-author">
                <i class="fas fa-user"></i> ${username} • 
                <i class="fas fa-calendar"></i> ${formatDate(post.created)}
                ${post.category ? ` • <i class="fas fa-tag"></i> ${post.category}` : ''}
              </div>
            </div>
            <div class="post-actions">
              <button class="admin-btn xsmall primary" onclick="viewArticleDetails('${post.id}')">
                <i class="fas fa-eye"></i>
              </button>
              <button class="admin-btn xsmall warning" onclick="editArticle('${post.id}')">
                <i class="fas fa-edit"></i>
              </button>
              <button class="admin-btn xsmall" onclick="viewPostComments('${post.id}')">
                <i class="fas fa-comments"></i>
              </button>
              <button class="admin-btn xsmall danger" onclick="confirmDeleteArticle('${post.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="post-content" id="post-content-${post.id}">
            ${content}
          </div>
          
          <div class="post-footer">
            <div class="post-stats">
              <span><i class="fas fa-heart"></i> ${post.likesCount || 0} إعجاب</span>
              <span><i class="fas fa-comment"></i> ${post.commentsCount || 0} تعليق</span>
              <span><i class="fas fa-eye"></i> ${post.viewsCount || 0} مشاهدة</span>
            </div>
            <button class="admin-btn xsmall" onclick="togglePostContent('${post.id}')">
              <i class="fas fa-expand-alt"></i>
              <span>عرض المزيد</span>
            </button>
          </div>
        </div>
      `;
    }
    
    allPostsContainer.innerHTML = html;
  }
  
  window.loadMorePosts = async function() {
    try {
      loadMorePostsBtn.disabled = true;
      loadMorePostsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
      
      allPostsStartAt += allPostsLimit;
      
      const articlesRef = ref(db, 'articles');
      const articlesQuery = query(articlesRef, orderByChild('created'), limitToFirst(allPostsStartAt + allPostsLimit));
      
      get(articlesQuery).then(async (snap) => {
        if (!snap.exists()) {
          loadMorePostsBtn.style.display = 'none';
          loadMorePostsBtn.disabled = false;
          loadMorePostsBtn.innerHTML = '<i class="fas fa-arrow-down"></i> <span>تحميل المزيد</span>';
          return;
        }
        
        const newPosts = [];
        snap.forEach(articleSnap => {
          const article = {
            id: articleSnap.key,
            ...articleSnap.val()
          };
          newPosts.push(article);
        });
        
        // ترتيب تنازلي حسب التاريخ
        newPosts.sort((a, b) => b.created - a.created);
        
        // إضافة المنشورات الجديدة فقط
        const existingIds = allPosts.map(p => p.id);
        const uniqueNewPosts = newPosts.filter(p => !existingIds.includes(p.id));
        
        if (uniqueNewPosts.length > 0) {
          allPosts = [...allPosts, ...uniqueNewPosts];
          await displayAllPosts();
        }
        
        // التحقق إذا كان هناك المزيد من المنشورات
        if (uniqueNewPosts.length < allPostsLimit) {
          loadMorePostsBtn.style.display = 'none';
        }
        
        loadMorePostsBtn.disabled = false;
        loadMorePostsBtn.innerHTML = '<i class="fas fa-arrow-down"></i> <span>تحميل المزيد</span>';
        
      }).catch(error => {
        console.error('Error loading more posts:', error);
        showAdminNotification('حدث خطأ في تحميل المزيد من المنشورات', 'error');
        loadMorePostsBtn.disabled = false;
        loadMorePostsBtn.innerHTML = '<i class="fas fa-arrow-down"></i> <span>تحميل المزيد</span>';
      });
      
    } catch (error) {
      console.error('Error loading more posts:', error);
      showAdminNotification('حدث خطأ في تحميل المزيد من المنشورات', 'error');
      loadMorePostsBtn.disabled = false;
      loadMorePostsBtn.innerHTML = '<i class="fas fa-arrow-down"></i> <span>تحميل المزيد</span>';
    }
  };
  
  window.togglePostContent = function(postId) {
    const contentElement = document.getElementById(`post-content-${postId}`);
    const toggleBtn = contentElement.closest('.post-item').querySelector('.post-footer button');
    
    if (contentElement.classList.contains('expanded')) {
      contentElement.classList.remove('expanded');
      toggleBtn.innerHTML = '<i class="fas fa-expand-alt"></i> <span>عرض المزيد</span>';
    } else {
      // جلب المحتوى الكامل
      const post = allPosts.find(p => p.id === postId);
      if (post) {
        contentElement.innerHTML = post.content || 'لا يوجد محتوى';
        contentElement.classList.add('expanded');
        toggleBtn.innerHTML = '<i class="fas fa-compress-alt"></i> <span>عرض أقل</span>';
      }
    }
  };
  
  /* =====================================================
     POST COMMENTS MANAGEMENT
  ===================================================== */
  window.viewPostComments = async function(postId) {
    try {
      currentPostId = postId;
      currentPostComments = [];
      currentPostCommentsStartAt = 0;
      
      const commentsRef = ref(db, `comments/${postId}`);
      const commentsQuery = query(commentsRef, orderByChild('created'), limitToFirst(currentPostCommentsLimit));
      
      get(commentsQuery).then(async (snap) => {
        if (!snap.exists()) {
          document.getElementById('postCommentsContent').innerHTML = '<div class="admin-empty-state"><p>لا توجد تعليقات</p></div>';
          loadMoreCommentsBtn.style.display = 'none';
          postCommentsModal.style.display = 'flex';
          return;
        }
        
        currentPostComments = [];
        snap.forEach(commentSnap => {
          const comment = {
            id: commentSnap.key,
            ...commentSnap.val()
          };
          currentPostComments.push(comment);
        });
        
        // ترتيب تنازلي حسب التاريخ
        currentPostComments.sort((a, b) => b.created - a.created);
        
        await displayPostComments();
        
        // التحقق إذا كان هناك المزيد من التعليقات
        if (currentPostComments.length >= currentPostCommentsLimit) {
          loadMoreCommentsBtn.style.display = 'block';
        } else {
          loadMoreCommentsBtn.style.display = 'none';
        }
        
        postCommentsModal.style.display = 'flex';
        
      }).catch(error => {
        console.error('Error loading post comments:', error);
        document.getElementById('postCommentsContent').innerHTML = '<div class="admin-empty-state"><p>حدث خطأ في تحميل التعليقات</p></div>';
        postCommentsModal.style.display = 'flex';
      });
      
    } catch (error) {
      console.error('Error loading post comments:', error);
      showAdminNotification('حدث خطأ في تحميل التعليقات', 'error');
    }
  };
  
  async function displayPostComments() {
    if (currentPostComments.length === 0) {
      document.getElementById('postCommentsContent').innerHTML = '<div class="admin-empty-state"><p>لا توجد تعليقات</p></div>';
      return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
    
    for (const comment of currentPostComments) {
      const userData = await getUserData(comment.author);
      const username = userData ? userData.username : 'مجهول';
      
      html += `
        <div class="comment-item">
          <div class="comment-header">
            <div class="comment-author">
              <i class="fas fa-user"></i> ${username}
            </div>
            <div class="comment-date">
              ${formatDate(comment.created)}
            </div>
          </div>
          <div class="comment-content">
            ${comment.text || 'لا يوجد نص'}
          </div>
          <div class="comment-actions">
            <button class="admin-btn xsmall danger" onclick="deleteComment('${currentPostId}', '${comment.id}')">
              <i class="fas fa-trash"></i>
              <span>حذف</span>
            </button>
          </div>
        </div>
      `;
    }
    
    html += '</div>';
    document.getElementById('postCommentsContent').innerHTML = html;
  }
  
  window.loadMoreComments = async function() {
    try {
      loadMoreCommentsBtn.disabled = true;
      loadMoreCommentsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
      
      currentPostCommentsStartAt += currentPostCommentsLimit;
      
      const commentsRef = ref(db, `comments/${currentPostId}`);
      const commentsQuery = query(commentsRef, orderByChild('created'), limitToFirst(currentPostCommentsStartAt + currentPostCommentsLimit));
      
      get(commentsQuery).then(async (snap) => {
        if (!snap.exists()) {
          loadMoreCommentsBtn.style.display = 'none';
          loadMoreCommentsBtn.disabled = false;
          loadMoreCommentsBtn.innerHTML = '<i class="fas fa-arrow-down"></i> <span>تحميل المزيد</span>';
          return;
        }
        
        const newComments = [];
        snap.forEach(commentSnap => {
          const comment = {
            id: commentSnap.key,
            ...commentSnap.val()
          };
          newComments.push(comment);
        });
        
        // ترتيب تنازلي حسب التاريخ
        newComments.sort((a, b) => b.created - a.created);
        
        // إضافة التعليقات الجديدة فقط
        const existingIds = currentPostComments.map(c => c.id);
        const uniqueNewComments = newComments.filter(c => !existingIds.includes(c.id));
        
        if (uniqueNewComments.length > 0) {
          currentPostComments = [...currentPostComments, ...uniqueNewComments];
          await displayPostComments();
        }
        
        // التحقق إذا كان هناك المزيد من التعليقات
        if (uniqueNewComments.length < currentPostCommentsLimit) {
          loadMoreCommentsBtn.style.display = 'none';
        }
        
        loadMoreCommentsBtn.disabled = false;
        loadMoreCommentsBtn.innerHTML = '<i class="fas fa-arrow-down"></i> <span>تحميل المزيد</span>';
        
      }).catch(error => {
        console.error('Error loading more comments:', error);
        showAdminNotification('حدث خطأ في تحميل المزيد من التعليقات', 'error');
        loadMoreCommentsBtn.disabled = false;
        loadMoreCommentsBtn.innerHTML = '<i class="fas fa-arrow-down"></i> <span>تحميل المزيد</span>';
      });
      
    } catch (error) {
      console.error('Error loading more comments:', error);
      showAdminNotification('حدث خطأ في تحميل المزيد من التعليقات', 'error');
      loadMoreCommentsBtn.disabled = false;
      loadMoreCommentsBtn.innerHTML = '<i class="fas fa-arrow-down"></i> <span>تحميل المزيد</span>';
    }
  };
  
  window.deleteComment = async function(postId, commentId) {
    try {
      await remove(ref(db, `comments/${postId}/${commentId}`));
      
      // تحديث عدد التعليقات في المقال
      const articleRef = ref(db, `articles/${postId}`);
      const articleSnap = await get(articleRef);
      if (articleSnap.exists()) {
        const article = articleSnap.val();
        const newCommentsCount = (article.commentsCount || 0) - 1;
        await update(articleRef, {
          commentsCount: newCommentsCount >= 0 ? newCommentsCount : 0
        });
      }
      
      // إزالة التعليق من القائمة
      currentPostComments = currentPostComments.filter(c => c.id !== commentId);
      await displayPostComments();
      
      showAdminNotification('تم حذف التعليق بنجاح', 'success');
      
    } catch (error) {
      console.error('Error deleting comment:', error);
      showAdminNotification('حدث خطأ أثناء حذف التعليق', 'error');
    }
  };
  
  window.closePostCommentsModal = function() {
    postCommentsModal.style.display = 'none';
    currentPostComments = [];
    currentPostId = null;
    currentPostCommentsStartAt = 0;
  };
  
  /* =====================================================
     ARTICLE DETAILS & EDIT FUNCTIONS
  ===================================================== */
  window.viewArticleDetails = async (articleId) => {
    try {
      const articleRef = ref(db, `articles/${articleId}`);
      const articleSnap = await get(articleRef);
      
      if (!articleSnap.exists()) {
        showAdminNotification('المقال غير موجود', 'error');
        return;
      }
      
      const article = articleSnap.val();
      const userData = await getUserData(article.author);
      const username = userData ? userData.username : 'مجهول';
      
      let tagsHTML = '';
      if (article.likesCount > 10) {
        tagsHTML += '<span class="user-badge" style="margin-left: 5px;">🔥 شائع</span>';
      }
      if (Date.now() - article.created < 24 * 60 * 60 * 1000) {
        tagsHTML += '<span class="user-badge" style="margin-left: 5px;">🆕 جديد</span>';
      }
      if (article.category) {
        tagsHTML += `<span class="user-badge" style="margin-left: 5px;">${article.category}</span>`;
      }
      
      const content = document.getElementById('articleDetailsContent');
      content.innerHTML = `
        <div class="user-details">
          <div class="user-header">
            <div class="user-avatar">${username[0] || '?'}</div>
            <div class="user-info">
              <h3>${username}</h3>
              <div class="email">${article.author}</div>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <h4 style="font-size: 16px; margin-bottom: 10px;">تفاصيل المقال</h4>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">التاريخ</div>
                <div style="font-weight: 600;">${formatDate(article.created)}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">الإعجابات</div>
                <div style="font-weight: 600;">${article.likesCount || 0}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">التعليقات</div>
                <div style="font-weight: 600;">${article.commentsCount || 0}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">المشاهدات</div>
                <div style="font-weight: 600;">${article.viewsCount || 0}</div>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <h4 style="font-size: 16px; margin-bottom: 10px;">${article.title || 'عنوان المقال'}</h4>
            <div>${tagsHTML}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="font-size: 14px; margin-bottom: 10px; color: var(--text-muted);">المحتوى</h4>
            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: var(--radius-sm); font-size: 14px; line-height: 1.6;">
              ${article.content || 'لا يوجد محتوى'}
            </div>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button class="admin-btn primary" onclick="editArticle('${articleId}')">
              <i class="fas fa-edit"></i>
              <span>تعديل المقال</span>
            </button>
            <button class="admin-btn danger" onclick="confirmDeleteArticle('${articleId}')">
              <i class="fas fa-trash"></i>
              <span>حذف المقال</span>
            </button>
          </div>
        </div>
      `;
      
      articleDetailsModal.style.display = 'flex';
      
    } catch (error) {
      console.error('Error loading article details:', error);
      showAdminNotification('حدث خطأ في تحميل تفاصيل المقال', 'error');
    }
  };
  
  window.closeArticleDetailsModal = () => {
    articleDetailsModal.style.display = 'none';
  };
  
  window.editArticle = async (articleId) => {
    try {
      const articleRef = ref(db, `articles/${articleId}`);
      const articleSnap = await get(articleRef);
      
      if (!articleSnap.exists()) {
        showAdminNotification('المقال غير موجود', 'error');
        return;
      }
      
      const article = articleSnap.val();
      
      const content = document.getElementById('editArticleContent');
      content.innerHTML = `
        <div class="admin-form-group">
          <label>عنوان المقال</label>
          <input type="text" class="admin-form-control" id="editArticleTitle" value="${article.title || ''}" maxlength="70">
        </div>
        
        <div class="admin-form-group">
          <label>محتوى المقال</label>
          <textarea class="admin-form-control" id="editArticleContentText" rows="6" maxlength="2000">${article.content || ''}</textarea>
        </div>
        
        <div class="admin-form-group">
          <label>التصنيف</label>
          <select class="admin-form-control" id="editArticleCategory">
            <option value="ريدبيل" ${article.category === 'ريدبيل' ? 'selected' : ''}>ريدبيل</option>
            <option value="بلاك بيل" ${article.category === 'بلاك بيل' ? 'selected' : ''}>بلاك بيل</option>
            <option value="غير مصنف" ${article.category === 'غير مصنف' ? 'selected' : ''}>غير مصنف</option>
          </select>
        </div>
        
        <div class="admin-form-group">
          <label>وقت القراءة</label>
          <select class="admin-form-control" id="editArticleReadTime">
            <option value="1" ${article.readTime === '1' ? 'selected' : ''}>دقيقة واحدة</option>
            <option value="3" ${article.readTime === '3' ? 'selected' : ''}>٣ دقائق</option>
            <option value="5" ${article.readTime === '5' ? 'selected' : ''}>٥ دقائق</option>
            <option value="10" ${article.readTime === '10' ? 'selected' : ''}>١٠ دقائق</option>
            <option value="15" ${article.readTime === '15' ? 'selected' : ''}>١٥ دقيقة</option>
          </select>
        </div>
        
        <div class="admin-form-group" style="display: flex; gap: 10px;">
          <button class="admin-btn success" onclick="saveArticleEdit('${articleId}')" id="saveArticleBtn">
            <i class="fas fa-save"></i>
            <span>حفظ التغييرات</span>
          </button>
          <button class="admin-btn" onclick="closeEditArticleModal()">
            <i class="fas fa-times"></i>
            <span>إلغاء</span>
          </button>
        </div>
      `;
      
      editArticleModal.style.display = 'flex';
      
    } catch (error) {
      console.error('Error loading article for edit:', error);
      showAdminNotification('حدث خطأ في تحميل المقال للتعديل', 'error');
    }
  };
  
  window.saveArticleEdit = async (articleId) => {
    const title = document.getElementById('editArticleTitle').value.trim();
    const content = document.getElementById('editArticleContentText').value.trim();
    const category = document.getElementById('editArticleCategory').value;
    const readTime = document.getElementById('editArticleReadTime').value;
    
    if (!title || !content) {
      showAdminNotification('يرجى ملء جميع الحقول', 'error');
      return;
    }
    
    if (title.length < 5) {
      showAdminNotification('عنوان المقال قصير جداً', 'error');
      return;
    }
    
    if (content.length < 50) {
      showAdminNotification('محتوى المقال قصير جداً', 'error');
      return;
    }
    
    try {
      const btn = document.getElementById('saveArticleBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
      
      await update(ref(db, `articles/${articleId}`), {
        title: title,
        content: content,
        category: category,
        readTime: readTime,
        updated: Date.now(),
        updatedBy: currentAdmin.uid
      });
      
      showAdminNotification('تم تحديث المقال بنجاح', 'success');
      closeEditArticleModal();
      loadArticlesTable(currentArticlePage);
      loadAllPosts();
      
    } catch (error) {
      console.error('Error updating article:', error);
      showAdminNotification('حدث خطأ أثناء تحديث المقال', 'error');
    } finally {
      const btn = document.getElementById('saveArticleBtn');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> حفظ التغييرات';
    }
  };
  
  window.closeEditArticleModal = () => {
    editArticleModal.style.display = 'none';
  };
  
  window.confirmDeleteArticle = (articleId) => {
    const deleteMessage = document.getElementById('deleteMessage');
    deleteMessage.textContent = 'هل أنت متأكد من حذف هذا المقال؟ سيتم حذف جميع التعليقات والإعجابات المرتبطة به.';
    
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.onclick = () => deleteArticle(articleId);
    
    confirmDeleteModal.style.display = 'flex';
  };
  
  async function deleteArticle(articleId) {
    try {
      // حذف المقال - المشرف مسموح له بحذف أي مقال
      await remove(ref(db, `articles/${articleId}`));
      
      // محاولة حذف الإعجابات إذا كانت موجودة
      try {
        await remove(ref(db, `likes/${articleId}`));
      } catch (error) {
        console.log('No likes to delete for article:', articleId);
      }
      
      // محاولة حذف التعليقات إذا كانت موجودة
      try {
        await remove(ref(db, `comments/${articleId}`));
      } catch (error) {
        console.log('No comments to delete for article:', articleId);
      }
      
      // محاولة حذف المشاهدات إذا كانت موجودة
      try {
        await remove(ref(db, `views/${articleId}`));
      } catch (error) {
        console.log('No views to delete for article:', articleId);
      }
      
      showAdminNotification('تم حذف المقال بنجاح', 'success');
      closeConfirmDeleteModal();
      loadArticlesTable(currentArticlePage);
      loadAllPosts();
      loadDashboardStats();
      
    } catch (error) {
      console.error('Error deleting article:', error);
      showAdminNotification('حدث خطأ أثناء حذف المقال', 'error');
    }
  }
  
  /* =====================================================
     USERS MANAGEMENT
  ===================================================== */
  async function loadUsersTable(page = 1) {
    try {
      usersTableBody.innerHTML = '<tr><td colspan="8" class="admin-loading"><div class="admin-spinner"></div></td></tr>';
      
      // جلب جميع المستخدمين من قاعدة البيانات - المشرف فقط مسموح له بذلك
      const usersRef = ref(db, 'users');
      
      get(usersRef).then(async (usersSnap) => {
        if (!usersSnap.exists()) {
          usersTableBody.innerHTML = '<tr><td colspan="8" class="admin-empty-state"><p>لا يوجد مستخدمين</p></td></tr>';
          return;
        }
        
        const allUsers = [];
        usersSnap.forEach(userSnap => {
          const user = {
            id: userSnap.key,
            ...userSnap.val()
          };
          allUsers.push(user);
        });
        
        // التصفية حسب البحث
        const searchTerm = document.getElementById('userSearch').value.toLowerCase();
        
        let filteredUsers = allUsers;
        
        if (searchTerm) {
          filteredUsers = allUsers.filter(user => 
            (user.username && user.username.toLowerCase().includes(searchTerm)) ||
            (user.email && user.email.toLowerCase().includes(searchTerm))
          );
        }
        
        // حساب الترقيم
        const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
        const startIndex = (page - 1) * usersPerPage;
        const endIndex = startIndex + usersPerPage;
        const pageUsers = filteredUsers.slice(startIndex, endIndex);
        
        // عرض المستخدمين
        usersTableBody.innerHTML = '';
        
        if (pageUsers.length === 0) {
          usersTableBody.innerHTML = '<tr><td colspan="8" class="admin-empty-state"><p>لا يوجد مستخدمين</p></td></tr>';
          createPagination(usersPagination, page, totalPages, 'users');
          return;
        }
        
        let counter = startIndex + 1;
        for (const user of pageUsers) {
          const isAdmin = user.id === ADMIN_USER_ID;
          const status = isAdmin ? 'admin' : 'active';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${counter}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 30px; height: 30px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center;">
                  ${user.username ? user.username[0] || '?' : '?'}
                </div>
                <div>
                  <div style="font-weight: 600; font-size: 13px;">${user.username || 'مستخدم'}</div>
                  <div style="font-size: 11px; color: var(--text-muted);">ID: ${user.id.substring(0, 8)}...</div>
                </div>
              </div>
            </td>
            <td>${user.email || 'غير محدد'}</td>
            <td>${formatShortDate(user.joinDate)}</td>
            <td><span class="user-badge">${user.articlesCount || 0}</span></td>
            <td>${formatDate(user.lastLogin || user.joinDate)}</td>
            <td>
              <span class="user-badge ${isAdmin ? 'admin' : ''}">
                ${isAdmin ? 'مشرف' : 'نشط'}
              </span>
            </td>
            <td>
              <div class="actions">
                <button class="admin-btn xsmall primary" onclick="viewUserDetails('${user.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                ${!isAdmin ? `
                <button class="admin-btn xsmall danger" onclick="confirmDeleteUser('${user.id}')">
                  <i class="fas fa-trash"></i>
                </button>
                ` : ''}
              </div>
            </td>
          `;
          usersTableBody.appendChild(row);
          counter++;
        }
        
        // إنشاء أزرار الترقيم
        createPagination(usersPagination, page, totalPages, 'users');
        
      }).catch(error => {
        console.error('Error loading users table:', error);
        showAdminNotification('حدث خطأ في تحميل المستخدمين', 'error');
        usersTableBody.innerHTML = '<tr><td colspan="8" class="admin-empty-state"><p>حدث خطأ في تحميل المستخدمين</p></td></tr>';
      });
      
    } catch (error) {
      console.error('Error loading users table:', error);
      showAdminNotification('حدث خطأ في تحميل المستخدمين', 'error');
    }
  }
  
  // إضافة مستمع للبحث
  document.getElementById('userSearch').addEventListener('input', () => {
    currentUserPage = 1;
    loadUsersTable(1);
  });
  
  window.viewUserDetails = async (userId) => {
    try {
      const userRef = ref(db, `users/${userId}`);
      const userSnap = await get(userRef);
      
      if (!userSnap.exists()) {
        showAdminNotification('المستخدم غير موجود', 'error');
        return;
      }
      
      const userData = userSnap.val();
      userData.id = userId;
      
      // جلب مقالات المستخدم
      const articlesRef = ref(db, 'articles');
      const articlesSnap = await get(articlesRef);
      let userArticles = 0;
      let totalLikes = 0;
      let totalComments = 0;
      
      if (articlesSnap.exists()) {
        articlesSnap.forEach(articleSnap => {
          const article = articleSnap.val();
          if (article.author === userId) {
            userArticles++;
            totalLikes += article.likesCount || 0;
            totalComments += article.commentsCount || 0;
          }
        });
      }
      
      const content = document.getElementById('userDetailsContent');
      content.innerHTML = `
        <div class="user-details">
          <div class="user-header">
            <div class="user-avatar">${userData.username ? userData.username[0] || '?' : '?'}</div>
            <div class="user-info">
              <h3>${userData.username || 'مستخدم'}</h3>
              <div class="email">${userData.email || 'غير محدد'}</div>
            </div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <h4 style="font-size: 16px; margin-bottom: 10px;">إحصائيات المستخدم</h4>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">المقالات</div>
                <div style="font-weight: 600; font-size: 18px;">${userArticles}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">الإعجابات</div>
                <div style="font-weight: 600; font-size: 18px;">${totalLikes}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">التعليقات</div>
                <div style="font-weight: 600; font-size: 18px;">${totalComments}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">التقييم</div>
                <div style="font-weight: 600; font-size: 18px;">
                  ${Math.round((userArticles + totalLikes + totalComments) / 10) || 0}
                </div>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="font-size: 16px; margin-bottom: 10px;">معلومات الحساب</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">تاريخ الانضمام</div>
                <div style="font-weight: 600;">${formatDate(userData.joinDate)}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">آخر تسجيل دخول</div>
                <div style="font-weight: 600;">${formatDate(userData.lastLogin || userData.joinDate)}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">آخر مقال</div>
                <div style="font-weight: 600;">${userData.lastArticle ? formatDate(userData.lastArticle) : 'لا يوجد'}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted);">آخر تعليق</div>
                <div style="font-weight: 600;">${userData.lastComment ? formatDate(userData.lastComment) : 'لا يوجد'}</div>
              </div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h4 style="font-size: 16px; margin-bottom: 10px;">النبذة الشخصية</h4>
            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: var(--radius-sm);">
              ${userData.bio || 'لا توجد نبذة شخصية'}
            </div>
          </div>
          
          <div style="display: flex; gap: 10px;">
            ${userId !== ADMIN_USER_ID ? `
            <button class="admin-btn danger" onclick="confirmDeleteUser('${userId}')">
              <i class="fas fa-trash"></i>
              <span>حذف الحساب</span>
            </button>
            ` : '<div style="color: var(--text-muted); font-size: 14px;">هذا حساب مشرف لا يمكن تعديله</div>'}
          </div>
        </div>
      `;
      
      userDetailsModal.style.display = 'flex';
      
    } catch (error) {
      console.error('Error loading user details:', error);
      showAdminNotification('حدث خطأ في تحميل تفاصيل المستخدم', 'error');
    }
  };
  
  window.closeUserDetailsModal = () => {
    userDetailsModal.style.display = 'none';
  };
  
  window.confirmDeleteUser = (userId) => {
    if (userId === ADMIN_USER_ID) {
      showAdminNotification('لا يمكن حذف حساب مشرف', 'error');
      return;
    }
    
    const deleteMessage = document.getElementById('deleteMessage');
    deleteMessage.textContent = 'هل أنت متأكد من حذف هذا الحساب؟ سيتم حذف جميع مقالاته وتعليقاته وإعجاباته بشكل دائم.';
    
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.onclick = () => deleteUserAccount(userId);
    
    confirmDeleteModal.style.display = 'flex';
  };
  
  async function deleteUserAccount(userId) {
    try {
      // 1. حذف جميع مقالات المستخدم
      const articlesRef = ref(db, 'articles');
      const articlesSnap = await get(articlesRef);
      
      if (articlesSnap.exists()) {
        const deletePromises = [];
        articlesSnap.forEach(articleSnap => {
          const article = articleSnap.val();
          if (article.author === userId) {
            deletePromises.push(remove(ref(db, `articles/${articleSnap.key}`)));
            deletePromises.push(remove(ref(db, `likes/${articleSnap.key}`)));
            deletePromises.push(remove(ref(db, `comments/${articleSnap.key}`)));
            deletePromises.push(remove(ref(db, `views/${articleSnap.key}`)));
          }
        });
        await Promise.all(deletePromises);
      }
      
      // 2. حذف بيانات المستخدم من قاعدة البيانات
      await remove(ref(db, `users/${userId}`));
      
      // 3. حذف من قائمة المحظورين إذا كان موجوداً
      try {
        await remove(ref(db, `admin/bans/${userId}`));
      } catch (error) {
        console.log('User not in ban list');
      }
      
      showAdminNotification('تم حذف حساب المستخدم بنجاح', 'success');
      closeConfirmDeleteModal();
      loadUsersTable(currentUserPage);
      loadDashboardStats();
      loadAllPosts();
      
    } catch (error) {
      console.error('Error deleting user account:', error);
      showAdminNotification('حدث خطأ أثناء حذف حساب المستخدم', 'error');
    }
  }
  
  window.closeConfirmDeleteModal = () => {
    confirmDeleteModal.style.display = 'none';
  };
  
  /* =====================================================
     BAN USER MANAGEMENT
  ===================================================== */
  window.setBanOption = function(option) {
    // إعادة تعيين جميع الأزرار
    document.getElementById('banByUIDBtn').classList.remove('active');
    document.getElementById('banByEmailBtn').classList.remove('active');
    document.getElementById('searchUserBtn').classList.remove('active');
    
    // إخفاء جميع النماذج
    banUIDForm.style.display = 'none';
    banEmailForm.style.display = 'none';
    searchUserForm.style.display = 'none';
    userSearchResults.innerHTML = '';
    
    // تفعيل الخيار المحدد
    if (option === 'uid') {
      document.getElementById('banByUIDBtn').classList.add('active');
      banUIDForm.style.display = 'block';
    } else if (option === 'email') {
      document.getElementById('banByEmailBtn').classList.add('active');
      banEmailForm.style.display = 'block';
    } else if (option === 'search') {
      document.getElementById('searchUserBtn').classList.add('active');
      searchUserForm.style.display = 'block';
    }
  };
  
  window.searchUser = async function() {
    const searchTerm = document.getElementById('searchUserInput').value.trim();
    
    if (!searchTerm) {
      showAdminNotification('يرجى إدخال نص للبحث', 'error');
      return;
    }
    
    try {
      userSearchResults.innerHTML = '<div class="admin-loading"><div class="admin-spinner"></div></div>';
      
      const usersRef = ref(db, 'users');
      const usersSnap = await get(usersRef);
      
      if (!usersSnap.exists()) {
        userSearchResults.innerHTML = '<div class="admin-empty-state"><p>لا يوجد مستخدمين</p></div>';
        return;
      }
      
      const results = [];
      usersSnap.forEach(userSnap => {
        const user = userSnap.val();
        if (user.username && user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
            user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase())) {
          results.push({
            id: userSnap.key,
            ...user
          });
        }
      });
      
      if (results.length === 0) {
        userSearchResults.innerHTML = '<div class="admin-empty-state"><p>لا توجد نتائج</p></div>';
        return;
      }
      
      let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
      results.forEach(user => {
        const isAdmin = user.id === ADMIN_USER_ID;
        html += `
          <div class="search-result-item">
            <div class="search-result-info">
              <h4>${user.username || 'مستخدم'}</h4>
              <p>${user.email || 'غير محدد'} • UID: ${user.id.substring(0, 10)}...</p>
            </div>
            <div class="actions">
              <button class="admin-btn xsmall primary" onclick="setBanUID('${user.id}')">
                <i class="fas fa-ban"></i>
                <span>حظر</span>
              </button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      userSearchResults.innerHTML = html;
      
    } catch (error) {
      console.error('Error searching users:', error);
      userSearchResults.innerHTML = '<div class="admin-empty-state"><p>حدث خطأ في البحث</p></div>';
    }
  };
  
  window.setBanUID = function(uid) {
    document.getElementById('banUserUID').value = uid;
    setBanOption('uid');
  };
  
  window.banUserByUID = async function() {
    const uid = document.getElementById('banUserUID').value.trim();
    const reason = document.getElementById('banReason').value;
    const duration = document.getElementById('banDuration').value;
    const notes = document.getElementById('banNotes').value.trim();
    
    if (!uid) {
      showAdminNotification('يرجى إدخال UID المستخدم', 'error');
      return;
    }
    
    if (uid === ADMIN_USER_ID) {
      showAdminNotification('لا يمكن حظر حساب مشرف', 'error');
      return;
    }
    
    try {
      // التحقق من وجود المستخدم
      const userRef = ref(db, `users/${uid}`);
      const userSnap = await get(userRef);
      
      if (!userSnap.exists()) {
        showAdminNotification('المستخدم غير موجود', 'error');
        return;
      }
      
      // حساب تاريخ انتهاء الحظر
      let bannedUntil = 'permanent';
      if (duration !== 'permanent') {
        const days = parseInt(duration);
        bannedUntil = Date.now() + (days * 24 * 60 * 60 * 1000);
      }
      
      // حفظ بيانات الحظر في قاعدة البيانات
      await set(ref(db, `admin/bans/${uid}`), {
        reason: reason,
        duration: duration,
        notes: notes,
        bannedAt: Date.now(),
        bannedBy: currentAdmin.uid,
        bannedUntil: bannedUntil
      });
      
      showAdminNotification('تم حظر المستخدم بنجاح', 'success');
      
      // إعادة تعيين الحقول
      document.getElementById('banUserUID').value = '';
      document.getElementById('banNotes').value = '';
      
      // تحديث قائمة المستخدمين
      loadUsersTable(currentUserPage);
      
    } catch (error) {
      console.error('Error banning user by UID:', error);
      showAdminNotification('حدث خطأ أثناء حظر المستخدم', 'error');
    }
  };
  
  window.banUserByEmail = async function() {
    const email = document.getElementById('banUserEmail').value.trim();
    const reason = document.getElementById('banReasonEmail').value;
    const duration = document.getElementById('banDurationEmail').value;
    const notes = document.getElementById('banNotesEmail').value.trim();
    
    if (!email) {
      showAdminNotification('يرجى إدخال البريد الإلكتروني', 'error');
      return;
    }
    
    try {
      // البحث عن المستخدم بالبريد الإلكتروني
      const usersRef = ref(db, 'users');
      const usersSnap = await get(usersRef);
      
      if (!usersSnap.exists()) {
        showAdminNotification('لم يتم العثور على المستخدم', 'error');
        return;
      }
      
      let foundUserId = null;
      usersSnap.forEach(userSnap => {
        const user = userSnap.val();
        if (user.email && user.email.toLowerCase() === email.toLowerCase()) {
          foundUserId = userSnap.key;
        }
      });
      
      if (!foundUserId) {
        showAdminNotification('لم يتم العثور على مستخدم بهذا البريد الإلكتروني', 'error');
        return;
      }
      
      if (foundUserId === ADMIN_USER_ID) {
        showAdminNotification('لا يمكن حظر حساب مشرف', 'error');
        return;
      }
      
      // حساب تاريخ انتهاء الحظر
      let bannedUntil = 'permanent';
      if (duration !== 'permanent') {
        const days = parseInt(duration);
        bannedUntil = Date.now() + (days * 24 * 60 * 60 * 1000);
      }
      
      // حفظ بيانات الحظر في قاعدة البيانات
      await set(ref(db, `admin/bans/${foundUserId}`), {
        reason: reason,
        duration: duration,
        notes: notes,
        bannedAt: Date.now(),
        bannedBy: currentAdmin.uid,
        bannedUntil: bannedUntil
      });
      
      showAdminNotification(`تم حظر المستخدم ${foundUserId} بنجاح`, 'success');
      
      // إعادة تعيين الحقول
      document.getElementById('banUserEmail').value = '';
      document.getElementById('banNotesEmail').value = '';
      
      // تحديث قائمة المستخدمين
      loadUsersTable(currentUserPage);
      
    } catch (error) {
      console.error('Error banning user by email:', error);
      showAdminNotification('حدث خطأ أثناء حظر المستخدم', 'error');
    }
  };
  
  /* =====================================================
     CREATE NEW USER
  ===================================================== */
  window.openCreateUserModal = () => {
    createUserModal.style.display = 'flex';
  };
  
  window.closeCreateUserModal = () => {
    createUserModal.style.display = 'none';
    // إعادة تعيين الحقول
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';
    document.getElementById('newUsername').value = '';
    document.getElementById('newUserRole').value = 'user';
  };
  
  window.createNewUser = async () => {
    const email = document.getElementById('newUserEmail').value.trim();
    const password = document.getElementById('newUserPassword').value.trim();
    const username = document.getElementById('newUsername').value.trim();
    const role = document.getElementById('newUserRole').value;
    
    if (!email || !password || !username) {
      showAdminNotification('يرجى ملء جميع الحقول', 'error');
      return;
    }
    
    if (password.length < 6) {
      showAdminNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
      return;
    }
    
    if (username.length < 3) {
      showAdminNotification('اسم المستخدم يجب أن يكون 3 أحرف على الأقل', 'error');
      return;
    }
    
    try {
      const btn = document.getElementById('createUserBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...';
      
      // إنشاء حساب في Authentication
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const newUserId = userCredential.user.uid;
      
      // حفظ بيانات المستخدم في قاعدة البيانات
      await set(ref(db, `users/${newUserId}`), {
        username: username,
        email: email,
        role: role,
        joinDate: Date.now(),
        lastLogin: Date.now(),
        articlesCount: 0,
        likesCount: 0,
        commentsCount: 0,
        lastArticle: 0,
        lastComment: 0,
        bio: 'تم إنشاء الحساب بواسطة المشرف',
        status: 'active'
      });
      
      showAdminNotification('تم إنشاء حساب المستخدم بنجاح', 'success');
      closeCreateUserModal();
      loadUsersTable(currentUserPage);
      loadDashboardStats();
      
    } catch (error) {
      console.error('Error creating user:', error);
      
      if (error.code === 'auth/email-already-in-use') {
        showAdminNotification('البريد الإلكتروني مستخدم بالفعل', 'error');
      } else if (error.code === 'auth/invalid-email') {
        showAdminNotification('البريد الإلكتروني غير صالح', 'error');
      } else if (error.code === 'auth/weak-password') {
        showAdminNotification('كلمة المرور ضعيفة جداً', 'error');
      } else {
        showAdminNotification('حدث خطأ أثناء إنشاء الحساب', 'error');
      }
    } finally {
      const btn = document.getElementById('createUserBtn');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-user-plus"></i> إنشاء الحساب';
    }
  };
  
  /* =====================================================
     REPORTS
  ===================================================== */
  async function loadReports() {
    try {
      // تحميل إحصائيات الشهر
      const monthlyStatsDiv = document.getElementById('monthlyStats');
      const topUsersDiv = document.getElementById('topUsers');
      
      monthlyStatsDiv.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
          <div style="text-align: center;">
            <div style="font-size: 20px; font-weight: 700; color: var(--green);">${totalArticlesCount}</div>
            <div style="font-size: 13px; color: var(--text-muted); margin-top: 5px;">إجمالي المقالات</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 20px; font-weight: 700; color: var(--blue);">${totalUsersCount}</div>
            <div style="font-size: 13px; color: var(--text-muted); margin-top: 5px;">إجمالي المستخدمين</div>
          </div>
        </div>
      `;
      
      topUsersDiv.innerHTML = `
        <div class="admin-empty-state">
          <i class="fas fa-chart-line"></i>
          <h3>قريباً</h3>
          <p>سيتم إضافة هذه الميزة قريباً</p>
        </div>
      `;
      
    } catch (error) {
      console.error('Error loading reports:', error);
      showAdminNotification('حدث خطأ في تحميل التقارير', 'error');
    }
  }
  
  /* =====================================================
     SETTINGS
  ===================================================== */
  window.saveSettings = async () => {
    const siteTitle = document.getElementById('siteTitle').value;
    const siteDescription = document.getElementById('siteDescription').value;
    const articleCooldown = document.getElementById('articleCooldown').value;
    const commentCooldown = document.getElementById('commentCooldown').value;
    
    if (!siteTitle || !siteDescription) {
      showAdminNotification('يرجى ملء جميع الحقول', 'error');
      return;
    }
    
    try {
      await set(ref(db, 'admin/settings'), {
        siteTitle: siteTitle,
        siteDescription: siteDescription,
        articleCooldown: articleCooldown,
        commentCooldown: commentCooldown,
        updated: Date.now(),
        updatedBy: currentAdmin.uid
      });
      
      showAdminNotification('تم حفظ الإعدادات بنجاح', 'success');
    } catch (error) {
      console.error('Error saving settings:', error);
      showAdminNotification('حدث خطأ أثناء حفظ الإعدادات', 'error');
    }
  };
  
  /* =====================================================
     UTILITY FUNCTIONS
  ===================================================== */
  function createPagination(container, currentPage, totalPages, type) {
    container.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // زر السابق
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
      if (type === 'articles') {
        currentArticlePage--;
        loadArticlesTable(currentArticlePage);
      } else if (type === 'users') {
        currentUserPage--;
        loadUsersTable(currentUserPage);
      }
    };
    container.appendChild(prevBtn);
    
    // أزرار الصفحات
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
      const firstBtn = document.createElement('button');
      firstBtn.className = 'pagination-btn';
      firstBtn.textContent = '1';
      firstBtn.onclick = () => {
        if (type === 'articles') {
          currentArticlePage = 1;
          loadArticlesTable(currentArticlePage);
        } else if (type === 'users') {
          currentUserPage = 1;
          loadUsersTable(currentUserPage);
        }
      };
      container.appendChild(firstBtn);
      
      if (startPage > 2) {
        const ellipsis = document.createElement('span');
        ellipsis.style.padding = '8px';
        ellipsis.textContent = '...';
        container.appendChild(ellipsis);
      }
    }
    
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.className = 'pagination-btn';
      if (i === currentPage) {
        pageBtn.classList.add('active');
      }
      pageBtn.textContent = i;
      pageBtn.onclick = () => {
        if (type === 'articles') {
          currentArticlePage = i;
          loadArticlesTable(currentArticlePage);
        } else if (type === 'users') {
          currentUserPage = i;
          loadUsersTable(currentUserPage);
        }
      };
      container.appendChild(pageBtn);
    }
    
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const ellipsis = document.createElement('span');
        ellipsis.style.padding = '8px';
        ellipsis.textContent = '...';
        container.appendChild(ellipsis);
      }
      
      const lastBtn = document.createElement('button');
      lastBtn.className = 'pagination-btn';
      lastBtn.textContent = totalPages;
      lastBtn.onclick = () => {
        if (type === 'articles') {
          currentArticlePage = totalPages;
          loadArticlesTable(currentArticlePage);
        } else if (type === 'users') {
          currentUserPage = totalPages;
          loadUsersTable(currentUserPage);
        }
      };
      container.appendChild(lastBtn);
    }
    
    // زر التالي
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
      if (type === 'articles') {
        currentArticlePage++;
        loadArticlesTable(currentArticlePage);
      } else if (type === 'users') {
        currentUserPage++;
        loadUsersTable(currentUserPage);
      }
    };
    container.appendChild(nextBtn);
  }
  
  async function getUserData(userId) {
    try {
      const userRef = ref(db, `users/${userId}`);
      const snap = await get(userRef);
      return snap.exists() ? snap.val() : null;
    } catch (error) {
      console.error('Error getting user data:', error);
      return null;
    }
  }
  
  function formatDate(timestamp) {
    if (!timestamp) return 'غير محدد';
    
    const date = new Date(Number(timestamp));
    if (isNaN(date.getTime())) return 'تاريخ غير صالح';
    
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60 * 1000) {
      return 'الآن';
    }
    
    if (diff < 60 * 60 * 1000) {
      const minutes = Math.floor(diff / (60 * 1000));
      return `منذ ${minutes} دقيقة`;
    }
    
    if (diff < 24 * 60 * 60 * 1000) {
      const hours = Math.floor(diff / (60 * 60 * 1000));
      return `منذ ${hours} ساعة`;
    }
    
    if (diff < 7 * 24 * 60 * 60 * 1000) {
      const days = Math.floor(diff / (24 * 60 * 60 * 1000));
      return `منذ ${days} يوم`;
    }
    
    return date.toLocaleDateString('ar-SA', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  function formatShortDate(timestamp) {
    if (!timestamp) return 'غير محدد';
    
    const date = new Date(Number(timestamp));
    if (isNaN(date.getTime())) return '--';
    
    return date.toLocaleDateString('ar-SA', {
      month: 'short',
      day: 'numeric'
    });
  }
  
  function showAdminNotification(message, type = 'success') {
    if (type === 'success') {
      adminNotificationIcon.className = 'fas fa-check-circle';
      adminNotification.classList.add('success');
      adminNotification.classList.remove('error');
    } else {
      adminNotificationIcon.className = 'fas fa-exclamation-circle';
      adminNotification.classList.add('error');
      adminNotification.classList.remove('success');
    }
    
    adminNotificationText.textContent = message;
    adminNotification.style.display = 'flex';
    
    setTimeout(() => {
      adminNotification.style.display = 'none';
    }, 3000);
  }
  
  /* =====================================================
     INITIALIZATION
  ===================================================== */
  window.addEventListener('click', (e) => {
    if (e.target === articleDetailsModal) {
      closeArticleDetailsModal();
    }
    if (e.target === userDetailsModal) {
      closeUserDetailsModal();
    }
    if (e.target === editArticleModal) {
      closeEditArticleModal();
    }
    if (e.target === createUserModal) {
      closeCreateUserModal();
    }
    if (e.target === confirmDeleteModal) {
      closeConfirmDeleteModal();
    }
    if (e.target === postCommentsModal) {
      closePostCommentsModal();
    }
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeArticleDetailsModal();
      closeUserDetailsModal();
      closeEditArticleModal();
      closeCreateUserModal();
      closeConfirmDeleteModal();
      closePostCommentsModal();
      closeAdminSidebar();
    }
  });
  
  // تحميل لوحة التحكم كصفحة افتراضية
  showAdminSection('dashboard');
  </script>

</body>
</html>
